{"version":3,"sources":["../lib/scion.js"],"names":["util","extend","Object","assign","to","from","keys","forEach","k","STATE_TYPES","BASIC","COMPOSITE","PARALLEL","HISTORY","INITIAL","FINAL","SCXML_IOPROCESSOR_TYPE","HTTP_IOPROCESSOR_TYPE","transitionWithTargets","t","targets","transitionComparator","t1","t2","documentOrder","initializeModel","rootState","transitions","idToStateMap","Map","idCount","generateId","type","undefined","count","wrapInFakeRootState","state","$deserializeDatamodel","$serializeDatamodel","$idToStateMap","states","$type","target","statesWithInitialAttributes","transitionToString","sourceState","events","join","cond","name","stateToString","id","traverse","ancestors","printTrace","toString","push","apply","has","Error","set","depth","length","parent","j","len","transition","source","bind","ancs","concat","typeEnum","isAtomic","descendants","map","s","reduce","a","b","initialChildren","Array","isArray","initial","filter","child","initialRef","checkInitialRef","historyChildren","historyRef","prop","every","handler","invokes","invoke","finalize","connectIntialAttributes","initialStates","initialState","get","RX_WHITESPACE","connectTransitionGraph","i","onTransition","event","trim","split","lcca","getLCCA","scope","getScope","transitionIsReallyInternal","indexOf","s1","s2","commonAncestors","anc","fakeRootState","EventEmitter","_listeners","prototype","on","_on","listener","once","_once","self","__once","args","arguments","off","_off","index","splice","emit","_emit","slice","call","modifiedArgs","listeners","ArraySet","l","o","Set","add","x","remove","delete","union","v","difference","contains","iter","isEmpty","size","equals","RX_TRAILING_WILDCARD","isEventPrefixMatch","prefix","fullName","replace","charAt","isTransitionMatch","eventName","some","tEvent","scxmlPrefixTransitionSelector","evaluator","selectEventlessTransitions","eventlessTransitionSelector","query","isDescendant","getAncestors","root","getAncestorsOrSelf","getDescendantsOrSelf","isOrthogonalTo","isAncestrallyRelatedTo","getLCA","getTransitionWithHigherSourceChildPriority","_args","r","getStateWithHigherSourceChildPriority","sortInEntryOrder","initializeModelGeneratorFn","modelFn","opts","interpreter","_x","_sessionid","_ioprocessors","isIn","deserializeSerializedConfiguration","serializedConfiguration","deserializeHistory","serializedHistory","sid","process","env","DEBUG","BaseInterpreter","EVENTS","modelOrFnGenerator","_scriptingContext","interpreterScriptingContext","InterpreterScriptingContext","generateSessionid","sessionid","sessionRegistry","location","scxml","model","JSON","parse","stringify","_model","console","log","priorityComparisonFn","transitionSelector","String","_externalEventQueue","_internalEventQueue","params","snapshot","_configuration","_historyValue","_isInFinalState","_log","sessionIdCounter","beget","cancel","parentSession","invokeid","_exitInterpreter","_cancelAllDelayedSends","statesToExit","sort","stateExited","onExit","exitIdx","exitLen","block","blockIdx","blockLen","actionRef","e","_handleError","cancelInvoke","send","start","_initStart","_performBigStep","getConfiguration","startAsync","cb","genAsync","nop","getFullConfiguration","stateName","isFinal","currentEvent","keepGoing","allStatesExited","allStatesEntered","_startBigStep","_selectTransitionsAndPerformSmallStep","_finishBigStep","selectedTransitions","_selectTransitions","shift","statesExited","statesEntered","_performSmallStep","autoforward","data","_evaluateAction","action","statesToInvoke","f","_timeouts","timeoutOptions","sendOptions","delay","clearTimeout","timeoutHandle","_timeoutMap","key","_performBigStepAsync","nextStep","setImmediate","selectedTransitionsWithTargets","exitedTuple","_getStatesExited","basicStatesExited","_getStatesEntered","eventsToAddToInnerQueue","isDeep","s0","sortedTransitions","stxIdx","targetIds","txIdx","txLen","enterIdx","enterLen","stateEntered","onEntry","entryIdx","entryLen","grandparent","donedata","isInFinalState","__proto__","tagname","line","column","reason","message","transitionList","desc","configList","cfgIdx","cfgLen","ancIdx","ancLen","sortedStatesExited","enabledTransitions","statesToEnter","_computeEntrySet","_addDescendantStatesToEnter","ancestor","_getEffectiveTargetStates","_addAncestorStatesToEnter","atomicStates","loop","priorityEnabledTransitions","_removeConflictingTransition","filteredTransitions","t1Preempted","transitionsToRemove","t1ExitSet","t2ExitSet","hasIntersection","t3","arg","inspect","registerListener","unregisterListener","getAllTransitionEvents","getEvents","stateIdx","stateLen","getSnapshot","_isStepping","_serializeHistory","Statechart","F","gen","evtObjOrName","optionalData","c","err","config","_interpreter","_invokeMap","validateUriRegex","invokeSendTargetRegex","scxmlSendTargetRegex","raise","_installDefaultPropsOnEvent","parseXmlStringAsDOM","xmlString","xmlParser","invokeObj","Promise","resolve","reject","invokers","session","sessionPromise","then","isInternal","origin","origintype","options","sendType","validateSend","sendAction","targetIsValidUri","test","sendid","defaultSendAction","setTimeout","match","doSend","targetSessionId","invokeId","sendAsync","publish","sendFn","customSend","customCancel","module","exports"],"mappings":";;0BAgBmB,M;;gCAAA,M;;;;;;;;2BAAfA,I;AAhBJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA,QAAIC,SAASC,OAAOC,MAAP,IACT,UAAUC,EAAV,EAAcC,IAAd,EAAmB;AACjBH,eAAOI,IAAP,CAAYD,IAAZ,EAAkBE,OAAlB,CAA0B,UAASC,CAAT,EAAW;AACnCJ,eAAGI,CAAH,IAAQH,KAAKG,CAAL,CAAR;AACD,SAFD;AAGA,eAAOJ,EAAP;AACD,KANL;;AAQA,QAAIK,cAAc;AACdC,eAAO,CADO;AAEdC,mBAAW,CAFG;AAGdC,kBAAU,CAHI;AAIdC,iBAAS,CAJK;AAKdC,iBAAS,CALK;AAMdC,eAAO;AANO,KAAlB;;AASA,QAAMC,yBAAyB,iDAA/B;AACA,QAAMC,wBAAwB,qDAA9B;;AAEA,aAASC,qBAAT,CAA+BC,CAA/B,EAAiC;AAC7B,eAAOA,EAAEC,OAAT;AACH;;AAED,aAASC,oBAAT,CAA8BC,EAA9B,EAAkCC,EAAlC,EAAsC;AAClC,eAAOD,GAAGE,aAAH,GAAmBD,GAAGC,aAA7B;AACH;;AAED,aAASC,eAAT,CAAyBC,SAAzB,EAAmC;AAC/B,YAAIC,cAAc,EAAlB;AAAA,YAAsBC,eAAe,IAAIC,GAAJ,EAArC;AAAA,YAAgDL,gBAAgB,CAAhE;;AAGA;AACA;AACA,YAAIM,UAAU,EAAd;;AAEA,iBAASC,UAAT,CAAoBC,IAApB,EAAyB;AACrB,gBAAGF,QAAQE,IAAR,MAAkBC,SAArB,EAAgCH,QAAQE,IAAR,IAAgB,CAAhB;;AAEhC,gBAAIE,QAAQJ,QAAQE,IAAR,GAAZ;AACA,mBAAO,gBAAgBA,IAAhB,GAAuB,GAAvB,GAA6BE,KAApC;AACH;;AAED,iBAASC,mBAAT,CAA6BC,KAA7B,EAAmC;AAC/B,mBAAO;AACHC,uCAAwBD,MAAMC,qBAAN,IAA+B,YAAU,CAAE,CADhE;AAEHC,qCAAsBF,MAAME,mBAAN,IAA6B,YAAU;AAAE,2BAAO,IAAP;AAAa,iBAFzE;AAGHC,+BAAgBX,YAHb,EAG6B;AAChCY,wBAAS,CACL;AACIC,2BAAQ,SADZ;AAEId,iCAAc,CAAC;AACXe,gCAASN;AADE,qBAAD;AAFlB,iBADK,EAOLA,KAPK;AAJN,aAAP;AAcH;;AAED,YAAIO,8BAA8B,EAAlC;;AAEA,iBAASC,kBAAT,CAA4BC,WAA5B,EAAwC;AACtC,mBAAUA,WAAV,aAA4B,KAAKC,MAAL,GAAc,MAAM,KAAKA,MAAL,CAAYC,IAAZ,CAAiB,GAAjB,CAAN,GAA8B,GAA5C,GAAkD,IAA9E,KAAqF,KAAKC,IAAL,GAAY,MAAM,KAAKA,IAAL,CAAUC,IAAhB,GAAuB,GAAnC,GAAyC,EAA9H,eAAwI,KAAK7B,OAAL,GAAe,KAAKA,OAAL,CAAa2B,IAAb,CAAkB,GAAlB,CAAf,GAAwC,IAAhL;AACD;;AAED,iBAASG,aAAT,GAAwB;AACtB,mBAAO,KAAKC,EAAZ;AACD;;AAED,iBAASC,QAAT,CAAkBC,SAAlB,EAA4BjB,KAA5B,EAAkC;;AAE9B,gBAAGkB,UAAH,EAAelB,MAAMmB,QAAN,GAAiBL,aAAjB;;AAEf;AACA,gBAAGd,MAAMT,WAAT,EAAsBA,YAAY6B,IAAZ,CAAiBC,KAAjB,CAAuB9B,WAAvB,EAAmCS,MAAMT,WAAzC;;AAEtB;AACA,gBAAGS,MAAMe,EAAT,EAAY;AACR,oBAAGvB,aAAa8B,GAAb,CAAiBtB,MAAMe,EAAvB,CAAH,EAA+B,MAAM,IAAIQ,KAAJ,CAAU,8BAA8BvB,MAAMe,EAA9C,CAAN;;AAE/BvB,6BAAagC,GAAb,CAAiBxB,MAAMe,EAAvB,EAA2Bf,KAA3B;AACH;;AAED;AACA;AACAA,kBAAMK,KAAN,GAAcL,MAAMK,KAAN,IAAe,OAA7B;;AAEA;AACAL,kBAAMiB,SAAN,GAAkBA,SAAlB;AACAjB,kBAAMyB,KAAN,GAAcR,UAAUS,MAAxB;AACA1B,kBAAM2B,MAAN,GAAeV,UAAU,CAAV,CAAf;AACAjB,kBAAMZ,aAAN,GAAsBA,eAAtB;;AAEA;AACAY,kBAAMT,WAAN,GAAoBS,MAAMT,WAAN,IAAqB,EAAzC;AACA,iBAAK,IAAIqC,IAAI,CAAR,EAAWC,MAAM7B,MAAMT,WAAN,CAAkBmC,MAAxC,EAAgDE,IAAIC,GAApD,EAAyDD,GAAzD,EAA8D;AAC1D,oBAAIE,aAAa9B,MAAMT,WAAN,CAAkBqC,CAAlB,CAAjB;AACAE,2BAAW1C,aAAX,GAA2BA,eAA3B;AACA0C,2BAAWC,MAAX,GAAoB/B,KAApB;AACA,oBAAGkB,UAAH,EAAeY,WAAWX,QAAX,GAAsBX,mBAAmBwB,IAAnB,CAAwBF,UAAxB,EAAoC9B,KAApC,CAAtB;AAClB;;AAED;AACA,gBAAGA,MAAMI,MAAT,EAAiB;AACb,oBAAI6B,OAAO,CAACjC,KAAD,EAAQkC,MAAR,CAAejB,SAAf,CAAX;AACA,qBAAK,IAAIW,IAAI,CAAR,EAAWC,MAAM7B,MAAMI,MAAN,CAAasB,MAAnC,EAA2CE,IAAIC,GAA/C,EAAoDD,GAApD,EAAyD;AACrDZ,6BAASiB,IAAT,EAAejC,MAAMI,MAAN,CAAawB,CAAb,CAAf;AACH;AACJ;;AAED;AACA,oBAAO5B,MAAMK,KAAb;AACI,qBAAK,UAAL;AACIL,0BAAMmC,QAAN,GAAiB9D,YAAYG,QAA7B;AACAwB,0BAAMoC,QAAN,GAAiB,KAAjB;AACA;AACJ,qBAAK,SAAL;AACIpC,0BAAMmC,QAAN,GAAiB9D,YAAYK,OAA7B;AACAsB,0BAAMoC,QAAN,GAAiB,IAAjB;AACA;AACJ,qBAAK,SAAL;AACIpC,0BAAMmC,QAAN,GAAiB9D,YAAYI,OAA7B;AACAuB,0BAAMoC,QAAN,GAAiB,IAAjB;AACA;AACJ,qBAAK,OAAL;AACIpC,0BAAMmC,QAAN,GAAiB9D,YAAYM,KAA7B;AACAqB,0BAAMoC,QAAN,GAAiB,IAAjB;AACA;AACJ,qBAAK,OAAL;AACA,qBAAK,OAAL;AACI,wBAAGpC,MAAMI,MAAN,IAAgBJ,MAAMI,MAAN,CAAasB,MAAhC,EAAuC;AACnC1B,8BAAMmC,QAAN,GAAiB9D,YAAYE,SAA7B;AACAyB,8BAAMoC,QAAN,GAAiB,KAAjB;AACH,qBAHD,MAGK;AACDpC,8BAAMmC,QAAN,GAAiB9D,YAAYC,KAA7B;AACA0B,8BAAMoC,QAAN,GAAiB,IAAjB;AACH;AACD;AACJ;AACI,0BAAM,IAAIb,KAAJ,CAAU,yBAAyBvB,MAAMK,KAAzC,CAAN;AA5BR;;AA+BA;AACA,gBAAGL,MAAMI,MAAT,EAAgB;AACZJ,sBAAMqC,WAAN,GAAoBrC,MAAMI,MAAN,CAAa8B,MAAb,CAAoBlC,MAAMI,MAAN,CAAakC,GAAb,CAAiB,UAASC,CAAT,EAAW;AAAC,2BAAOA,EAAEF,WAAT;AAAsB,iBAAnD,EAAqDG,MAArD,CAA4D,UAASC,CAAT,EAAWC,CAAX,EAAa;AAAC,2BAAOD,EAAEP,MAAF,CAASQ,CAAT,CAAP;AAAoB,iBAA9F,EAA+F,EAA/F,CAApB,CAApB;AACH,aAFD,MAEK;AACD1C,sBAAMqC,WAAN,GAAoB,EAApB;AACH;;AAED,gBAAIM,eAAJ;AACA,gBAAG3C,MAAMmC,QAAN,KAAmB9D,YAAYE,SAAlC,EAA4C;AACxC;;AAEA,oBAAGqE,MAAMC,OAAN,CAAc7C,MAAM8C,OAApB,KAAgC,OAAO9C,MAAM8C,OAAb,KAAyB,QAA5D,EAAqE;AACjEvC,gDAA4Ba,IAA5B,CAAiCpB,KAAjC;AACH,iBAFD,MAEK;AACD;AACA2C,sCAAkB3C,MAAMI,MAAN,CAAa2C,MAAb,CAAoB,UAASC,KAAT,EAAe;AACjD,+BAAOA,MAAM3C,KAAN,KAAgB,SAAvB;AACH,qBAFiB,CAAlB;;AAIAL,0BAAMiD,UAAN,GAAmB,CAACN,gBAAgBjB,MAAhB,GAAyBiB,gBAAgB,CAAhB,CAAzB,GAA8C3C,MAAMI,MAAN,CAAa,CAAb,CAA/C,CAAnB;AACA8C,oCAAgBlD,KAAhB;AACH;AAEJ;;AAED;AACA,gBAAGA,MAAMmC,QAAN,KAAmB9D,YAAYE,SAA/B,IACKyB,MAAMmC,QAAN,KAAmB9D,YAAYG,QADvC,EACgD;;AAE5C,oBAAI2E,kBAAkBnD,MAAMI,MAAN,CAAa2C,MAAb,CAAoB,UAASR,CAAT,EAAW;AACjD,2BAAOA,EAAElC,KAAF,KAAY,SAAnB;AACH,iBAFqB,CAAtB;;AAIDL,sBAAMoD,UAAN,GAAmBD,eAAnB;AACF;;AAED;AACA,gBAAG,CAACnD,MAAMe,EAAV,EAAa;AACTf,sBAAMe,EAAN,GAAWpB,WAAWK,MAAMK,KAAjB,CAAX;AACAb,6BAAagC,GAAb,CAAiBxB,MAAMe,EAAvB,EAA2Bf,KAA3B;AACH;;AAED;AACA,aAAC,SAAD,EAAW,QAAX,EAAqB7B,OAArB,CAA6B,UAASkF,IAAT,EAAc;AACzC,oBAAIrD,MAAMqD,IAAN,CAAJ,EAAiB;AACf,wBAAG,CAACT,MAAMC,OAAN,CAAc7C,MAAMqD,IAAN,CAAd,CAAJ,EAA+B;AAC7BrD,8BAAMqD,IAAN,IAAc,CAACrD,MAAMqD,IAAN,CAAD,CAAd;AACD;AACD,wBAAG,CAACrD,MAAMqD,IAAN,EAAYC,KAAZ,CAAkB,UAASC,OAAT,EAAiB;AAAE,+BAAOX,MAAMC,OAAN,CAAcU,OAAd,CAAP;AAAgC,qBAArE,CAAJ,EAA2E;AACzEvD,8BAAMqD,IAAN,IAAc,CAACrD,MAAMqD,IAAN,CAAD,CAAd;AACD;AACF;AACF,aATD;;AAWA,gBAAIrD,MAAMwD,OAAN,IAAiB,CAACZ,MAAMC,OAAN,CAAc7C,MAAMwD,OAApB,CAAtB,EAAoD;AAChDxD,sBAAMwD,OAAN,GAAgB,CAACxD,MAAMwD,OAAP,CAAhB;AACAxD,sBAAMwD,OAAN,CAAcrF,OAAd,CAAuB,kBAAU;AAC/B,wBAAIsF,OAAOC,QAAP,IAAmB,CAACd,MAAMC,OAAN,CAAcY,OAAOC,QAArB,CAAxB,EAAwD;AACtDD,+BAAOC,QAAP,GAAkB,CAACD,OAAOC,QAAR,CAAlB;AACD;AACF,iBAJD;AAKH;AACJ;;AAED;;AAEA,iBAASR,eAAT,CAAyBlD,KAAzB,EAA+B;AAC7B,gBAAG,CAACA,MAAMiD,UAAV,EAAsB,MAAM,IAAI1B,KAAJ,CAAU,yDAAyDvB,MAAMe,EAAzE,CAAN;AACvB;AACD,iBAAS4C,uBAAT,GAAkC;AAChC,iBAAK,IAAI/B,IAAI,CAAR,EAAWC,MAAMtB,4BAA4BmB,MAAlD,EAA0DE,IAAIC,GAA9D,EAAmED,GAAnE,EAAwE;AACtE,oBAAIW,IAAIhC,4BAA4BqB,CAA5B,CAAR;;AAEA,oBAAIgC,gBAAgBhB,MAAMC,OAAN,CAAcN,EAAEO,OAAhB,IAA2BP,EAAEO,OAA7B,GAAuC,CAACP,EAAEO,OAAH,CAA3D;AACAP,kBAAEU,UAAF,GAAeW,cAActB,GAAd,CAAkB,UAASuB,YAAT,EAAsB;AAAE,2BAAOrE,aAAasE,GAAb,CAAiBD,YAAjB,CAAP;AAAwC,iBAAlF,CAAf;AACAX,gCAAgBX,CAAhB;AACD;AACF;;AAED,YAAIwB,gBAAgB,KAApB;;AAEA,iBAASC,sBAAT,GAAiC;AAC7B;AACA,iBAAK,IAAIC,IAAI,CAAR,EAAWpC,MAAMtC,YAAYmC,MAAlC,EAA0CuC,IAAIpC,GAA9C,EAAmDoC,GAAnD,EAAwD;AACpD,oBAAIlF,IAAIQ,YAAY0E,CAAZ,CAAR;AACA,oBAAIlF,EAAEmF,YAAF,IAAkB,CAACtB,MAAMC,OAAN,CAAc9D,EAAEmF,YAAhB,CAAvB,EAAsD;AAClDnF,sBAAEmF,YAAF,GAAiB,CAACnF,EAAEmF,YAAH,CAAjB;AACH;;AAED;AACA,oBAAI,OAAOnF,EAAEoF,KAAT,KAAmB,QAAvB,EAAiC;AAC7BpF,sBAAE2B,MAAF,GAAW3B,EAAEoF,KAAF,CAAQC,IAAR,GAAeC,KAAf,CAAqBN,aAArB,CAAX;AACH;AACD,uBAAOhF,EAAEoF,KAAT;;AAEA,oBAAGpF,EAAEC,OAAF,IAAc,OAAOD,EAAEuB,MAAT,KAAoB,WAArC,EAAmD;AAC/C;AACA;AACH;;AAED,oBAAG,OAAOvB,EAAEuB,MAAT,KAAoB,QAAvB,EAAgC;AAC5B,wBAAIA,SAASd,aAAasE,GAAb,CAAiB/E,EAAEuB,MAAnB,CAAb;AACA,wBAAG,CAACA,MAAJ,EAAY,MAAM,IAAIiB,KAAJ,CAAU,yCAAyCxC,EAAEuB,MAArD,CAAN;AACZvB,sBAAEuB,MAAF,GAAWA,MAAX;AACAvB,sBAAEC,OAAF,GAAY,CAACD,EAAEuB,MAAH,CAAZ;AACH,iBALD,MAKM,IAAGsC,MAAMC,OAAN,CAAc9D,EAAEuB,MAAhB,CAAH,EAA2B;AAC7BvB,sBAAEC,OAAF,GAAYD,EAAEuB,MAAF,CAASgC,GAAT,CAAa,UAAShC,MAAT,EAAgB;AACrC,4BAAG,OAAOA,MAAP,KAAkB,QAArB,EAA8B;AAC1BA,qCAASd,aAAasE,GAAb,CAAiBxD,MAAjB,CAAT;AACA,gCAAG,CAACA,MAAJ,EAAY,MAAM,IAAIiB,KAAJ,CAAU,yCAAyCxC,EAAEuB,MAArD,CAAN;AACZ,mCAAOA,MAAP;AACH,yBAJD,MAIK;AACD,mCAAOA,MAAP;AACH;AACJ,qBARW,CAAZ;AASH,iBAVK,MAUA,IAAG,QAAOvB,EAAEuB,MAAT,MAAoB,QAAvB,EAAgC;AAClCvB,sBAAEC,OAAF,GAAY,CAACD,EAAEuB,MAAH,CAAZ;AACH,iBAFK,MAED;AACD,0BAAM,IAAIiB,KAAJ,CAAU,yCAAyCxC,EAAEuB,MAArD,CAAN;AACH;AACJ;;AAED;AACA,iBAAK,IAAI2D,IAAI,CAAR,EAAWpC,MAAMtC,YAAYmC,MAAlC,EAA0CuC,IAAIpC,GAA9C,EAAmDoC,GAAnD,EAAwD;AACpD,oBAAIlF,IAAIQ,YAAY0E,CAAZ,CAAR;AACA,oBAAGlF,EAAEC,OAAL,EAAcD,EAAEuF,IAAF,GAASC,QAAQxF,EAAEgD,MAAV,EAAiBhD,EAAEC,OAAF,CAAU,CAAV,CAAjB,CAAT,CAFsC,CAEM;;AAE1DD,kBAAEyF,KAAF,GAAUC,SAAS1F,CAAT,CAAV;AACH;AACJ;;AAED,iBAAS0F,QAAT,CAAkB3C,UAAlB,EAA6B;AACzB;AACA;AACA,gBAAI4C,6BACI5C,WAAWlC,IAAX,KAAoB,UAApB,IACEkC,WAAWC,MAAX,CAAkBI,QAAlB,KAA+B9D,YAAYE,SAD7C,IAC4D;AAC1DuD,uBAAWC,MAAX,CAAkBJ,MAFpB,IAEiC;AAC/BG,uBAAW9C,OAHb,IAGwB;AACtB8C,uBAAW9C,OAAX,CAAmBsE,KAAnB,CACI,UAAShD,MAAT,EAAgB;AAAE,uBAAOwB,WAAWC,MAAX,CAAkBM,WAAlB,CAA8BsC,OAA9B,CAAsCrE,MAAtC,IAAgD,CAAC,CAAxD;AAA2D,aADjF,CALV;;AAQA,gBAAG,CAACwB,WAAW9C,OAAf,EAAuB;AACnB,uBAAO,IAAP;AACH,aAFD,MAEM,IAAG0F,0BAAH,EAA8B;AAChC,uBAAO5C,WAAWC,MAAlB;AACH,aAFK,MAED;AACD,uBAAOD,WAAWwC,IAAlB;AACH;AACJ;;AAED,iBAASC,OAAT,CAAiBK,EAAjB,EAAqBC,EAArB,EAAyB;AACrB,gBAAIC,kBAAkB,EAAtB;AACA,iBAAK,IAAIlD,IAAI,CAAR,EAAWC,MAAM+C,GAAG3D,SAAH,CAAaS,MAAnC,EAA2CE,IAAIC,GAA/C,EAAoDD,GAApD,EAAyD;AACrD,oBAAImD,MAAMH,GAAG3D,SAAH,CAAaW,CAAb,CAAV;AACA,oBAAGmD,IAAI5C,QAAJ,KAAiB9D,YAAYE,SAA7B,IACCwG,IAAI1C,WAAJ,CAAgBsC,OAAhB,CAAwBE,EAAxB,IAA8B,CAAC,CADnC,EACqC;AACjCC,oCAAgB1D,IAAhB,CAAqB2D,GAArB;AACH;AACJ;AACD,gBAAG,CAACD,gBAAgBpD,MAApB,EAA4B,MAAM,IAAIH,KAAJ,CAAU,gCAAV,CAAN;AAC5B,mBAAOuD,gBAAgB,CAAhB,CAAP;AACH;;AAED;AACA;AACA,YAAIE,gBAAgBjF,oBAAoBT,SAApB,CAApB,CAzR+B,CAyRsB;AACrD0B,iBAAS,EAAT,EAAYgE,aAAZ;AACAhB;AACAL;;AAEA,eAAOqB,aAAP;AACH;;AAED;AACA,aAASC,YAAT,GAAwB;AACpB,aAAKC,UAAL,GAAkB,EAAlB;AACA,aAAKA,UAAL,CAAgB,GAAhB,IAAuB,EAAvB;AACH;;AAEDD,iBAAaE,SAAb,CAAuBC,EAAvB,GAA4B,SAASC,GAAT,CAAazF,IAAb,EAAmB0F,QAAnB,EAA6B;AACrD,YAAI,CAAC1C,MAAMC,OAAN,CAAc,KAAKqC,UAAL,CAAgBtF,IAAhB,CAAd,CAAL,EAA2C;AACvC,iBAAKsF,UAAL,CAAgBtF,IAAhB,IAAwB,EAAxB;AACH;;AAED,YAAI,KAAKsF,UAAL,CAAgBtF,IAAhB,EAAsB+E,OAAtB,CAA8BW,QAA9B,MAA4C,CAAC,CAAjD,EAAoD;AAChD,iBAAKJ,UAAL,CAAgBtF,IAAhB,EAAsBwB,IAAtB,CAA2BkE,QAA3B;AACH;;AAED,eAAO,IAAP;AACH,KAVD;;AAYAL,iBAAaE,SAAb,CAAuBI,IAAvB,GAA8B,SAASC,KAAT,CAAe5F,IAAf,EAAqB0F,QAArB,EAA+B;AACzD,YAAIG,OAAO,IAAX;;AAEA,iBAASC,MAAT,GAAkB;AACd,iBAAK,IAAIC,OAAO,EAAX,EAAe1B,IAAI,CAAxB,EAA2BA,IAAI2B,UAAUlE,MAAzC,EAAiDuC,KAAK,CAAtD,EAAyD;AACrD0B,qBAAK1B,CAAL,IAAU2B,UAAU3B,CAAV,CAAV;AACH;;AAEDwB,iBAAKI,GAAL,CAASjG,IAAT,EAAe8F,MAAf;AACAJ,qBAASjE,KAAT,CAAeoE,IAAf,EAAqBE,IAArB;AACH;;AAEDD,eAAOJ,QAAP,GAAkBA,QAAlB;;AAEA,eAAO,KAAKF,EAAL,CAAQxF,IAAR,EAAc8F,MAAd,CAAP;AACH,KAfD;;AAiBAT,iBAAaE,SAAb,CAAuBU,GAAvB,GAA6B,SAASC,IAAT,CAAclG,IAAd,EAAoB0F,QAApB,EAA8B;AACvD,YAAI,CAAC1C,MAAMC,OAAN,CAAc,KAAKqC,UAAL,CAAgBtF,IAAhB,CAAd,CAAL,EAA2C;AACvC,mBAAO,IAAP;AACH;;AAED,YAAI,OAAO0F,QAAP,KAAoB,WAAxB,EAAqC;AACjC,iBAAKJ,UAAL,CAAgBtF,IAAhB,IAAwB,EAAxB;AACA,mBAAO,IAAP;AACH;;AAED,YAAImG,QAAQ,KAAKb,UAAL,CAAgBtF,IAAhB,EAAsB+E,OAAtB,CAA8BW,QAA9B,CAAZ;;AAEA,YAAIS,UAAU,CAAC,CAAf,EAAkB;AACd,iBAAK,IAAI9B,IAAI,CAAb,EAAgBA,IAAI,KAAKiB,UAAL,CAAgBtF,IAAhB,EAAsB8B,MAA1C,EAAkDuC,KAAK,CAAvD,EAA0D;AACtD,oBAAI,KAAKiB,UAAL,CAAgBtF,IAAhB,EAAsBqE,CAAtB,EAAyBqB,QAAzB,KAAsCA,QAA1C,EAAoD;AAChDS,4BAAQ9B,CAAR;AACA;AACH;AACJ;AACJ;;AAED,aAAKiB,UAAL,CAAgBtF,IAAhB,EAAsBoG,MAAtB,CAA6BD,KAA7B,EAAoC,CAApC;AACA,eAAO,IAAP;AACH,KAvBD;;AAyBAd,iBAAaE,SAAb,CAAuBc,IAAvB,GAA8B,SAASC,KAAT,CAAetG,IAAf,EAAqB;;AAE/C,YAAI+F,OAAO/C,MAAMuC,SAAN,CAAgBgB,KAAhB,CAAsBC,IAAtB,CAA2BR,SAA3B,CAAX;AACA,YAAIS,eAAeV,KAAKQ,KAAL,CAAW,CAAX,CAAnB;;AAEA,YAAIG,YAAY,KAAKpB,UAAL,CAAgBtF,IAAhB,CAAhB;AACA,YAAIgC,CAAJ,EAAOC,GAAP;AACA,YAAIe,MAAMC,OAAN,CAAcyD,SAAd,CAAJ,EAA8B;AAC5B,iBAAK1E,IAAI,CAAJ,EAAOC,MAAMyE,UAAU5E,MAA5B,EAAoCE,IAAIC,GAAxC,EAA6CD,GAA7C,EAAkD;AAChD0E,0BAAU1E,CAAV,EAAaP,KAAb,CAAmB,IAAnB,EAAyBgF,YAAzB;AACD;AACF;;AAED;AACAC,oBAAY,KAAKpB,UAAL,CAAgB,GAAhB,CAAZ;AACA,aAAKtD,IAAI,CAAJ,EAAOC,MAAMyE,UAAU5E,MAA5B,EAAoCE,IAAIC,GAAxC,EAA6CD,GAA7C,EAAkD;AAC9C0E,sBAAU1E,CAAV,EAAaP,KAAb,CAAmB,IAAnB,EAAyBsE,IAAzB;AACH;;AAED,eAAO,IAAP;AACH,KApBD;;AAsBA;;AAEA;;AAEA;AACA,aAASY,QAAT,CAAkBC,CAAlB,EAAqB;AACjBA,YAAIA,KAAK,EAAT;AACA,aAAKC,CAAL,GAAS,IAAIC,GAAJ,CAAQF,CAAR,CAAT;AACH;;AAEDD,aAASpB,SAAT,GAAqB;;AAEjBwB,aAAM,aAASC,CAAT,EAAY;AACd,iBAAKH,CAAL,CAAOE,GAAP,CAAWC,CAAX;AACH,SAJgB;;AAMjBC,gBAAS,gBAASD,CAAT,EAAY;AACjB,mBAAO,KAAKH,CAAL,CAAOK,MAAP,CAAcF,CAAd,CAAP;AACH,SARgB;;AAUjBG,eAAQ,eAASP,CAAT,EAAY;AAAA;AAAA;AAAA;;AAAA;AAChB,qCAAcA,EAAEC,CAAhB,8HAAmB;AAAA,wBAAVO,CAAU;;AACf,yBAAKP,CAAL,CAAOE,GAAP,CAAWK,CAAX;AACH;AAHe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIhB,mBAAO,IAAP;AACH,SAfgB;;AAiBjBC,oBAAa,oBAAST,CAAT,EAAY;AAAA;AAAA;AAAA;;AAAA;AACrB,sCAAcA,EAAEC,CAAhB,mIAAmB;AAAA,wBAAVO,CAAU;;AACf,yBAAKP,CAAL,CAAOK,MAAP,CAAcE,CAAd;AACH;AAHoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIrB,mBAAO,IAAP;AACH,SAtBgB;;AAwBjBE,kBAAW,kBAASN,CAAT,EAAY;AACnB,mBAAO,KAAKH,CAAL,CAAOnF,GAAP,CAAWsF,CAAX,CAAP;AACH,SA1BgB;;AA4BjBO,cAAO,gBAAW;AACd,mBAAOvE,MAAM3E,IAAN,CAAW,KAAKwI,CAAhB,CAAP;AACH,SA9BgB;;AAgCjBW,iBAAU,mBAAW;AACjB,mBAAO,CAAC,KAAKX,CAAL,CAAOY,IAAf;AACH,SAlCgB;;AAoCjBA,cAAM,gBAAW;AACb,mBAAO,KAAKZ,CAAL,CAAOY,IAAd;AACH,SAtCgB;;AAwCjBC,gBAAS,gBAASzC,EAAT,EAAa;AAClB,gBAAI,KAAK4B,CAAL,CAAOY,IAAP,KAAgBxC,GAAGwC,IAAH,EAApB,EAA+B;AAC3B,uBAAO,KAAP;AACH;;AAHiB;AAAA;AAAA;;AAAA;AAKlB,sCAAc,KAAKZ,CAAnB,mIAAsB;AAAA,wBAAbO,CAAa;;AAClB,wBAAI,CAACnC,GAAGqC,QAAH,CAAYF,CAAZ,CAAL,EAAqB;AACjB,+BAAO,KAAP;AACH;AACJ;AATiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAWlB,mBAAO,IAAP;AACH,SApDgB;;AAsDjB7F,kBAAW,oBAAW;AAClB,mBAAO,KAAKsF,CAAL,CAAOY,IAAP,KAAgB,CAAhB,GAAoB,SAApB,GAAgCzE,MAAM3E,IAAN,CAAW,KAAKwI,CAAhB,EAAmB9F,IAAnB,CAAwB,KAAxB,CAAvC;AACH;AAxDgB,KAArB;;AA2DA,QAAM4G,uBAAuB,OAA7B;;AAEA,aAASC,kBAAT,CAA4BC,MAA5B,EAAoCC,QAApC,EAA8C;AAC1CD,iBAASA,OAAOE,OAAP,CAAeJ,oBAAf,EAAqC,EAArC,CAAT;;AAEA,YAAIE,WAAWC,QAAf,EAAyB;AACrB,mBAAO,IAAP;AACH;;AAED,YAAID,OAAO/F,MAAP,GAAgBgG,SAAShG,MAA7B,EAAqC;AACjC,mBAAO,KAAP;AACH;;AAED,YAAIgG,SAASE,MAAT,CAAgBH,OAAO/F,MAAvB,MAAmC,GAAvC,EAA4C;AACxC,mBAAO,KAAP;AACH;;AAED,eAAQgG,SAAS/C,OAAT,CAAiB8C,MAAjB,MAA6B,CAArC;AACH;;AAED,aAASI,iBAAT,CAA2B9I,CAA3B,EAA8B+I,SAA9B,EAAyC;AACrC,eAAO/I,EAAE2B,MAAF,CAASqH,IAAT,CAAc,UAACC,MAAD,EAAY;AAC7B,mBAAOA,WAAW,GAAX,IAAkBR,mBAAmBQ,MAAnB,EAA2BF,SAA3B,CAAzB;AACH,SAFM,CAAP;AAGH;;AAED,aAASG,6BAAT,CAAuClJ,CAAvC,EAA0CoF,KAA1C,EAAiD+D,SAAjD,EAA4DC,0BAA5D,EAAwF;AACpF,eAAO,CACLA,6BACE,CAACpJ,EAAE2B,MADL,GAEG3B,EAAE2B,MAAF,IAAYyD,KAAZ,IAAqBA,MAAMtD,IAA3B,IAAmCgH,kBAAkB9I,CAAlB,EAAqBoF,MAAMtD,IAA3B,CAHjC,MAKD,CAAC9B,EAAE6B,IAAH,IAAWsH,UAAUnJ,EAAE6B,IAAZ,CALV,CAAP;AAMH;;AAED,aAASwH,2BAAT,CAAqCpI,KAArC,EAA2C;AACzC,eAAOA,MAAMT,WAAN,CAAkBwD,MAAlB,CAAyB,UAASjB,UAAT,EAAoB;AAAE,mBAAO,CAACA,WAAWpB,MAAZ,IAAwBoB,WAAWpB,MAAX,IAAqBoB,WAAWpB,MAAX,CAAkBgB,MAAlB,KAA6B,CAAjF;AAAuF,SAAtI,CAAP;AACD;;AAED;AACA,QAAI2G,QAAQ;AACRC,sBAAe,sBAAS1D,EAAT,EAAaC,EAAb,EAAgB;AAC7B;AACA,mBAAOA,GAAGxC,WAAH,CAAesC,OAAf,CAAuBC,EAAvB,IAA6B,CAAC,CAArC;AACD,SAJO;AAKR2D,sBAAc,sBAAShG,CAAT,EAAYiG,IAAZ,EAAkB;AAC5B,gBAAIvH,SAAJ,EAAe8E,KAAf,EAAsB/F,KAAtB;AACA,gBAAGwI,SAAS,IAAZ,EAAkB,OAAO,EAAP;AAClBzC,oBAAQxD,EAAEtB,SAAF,CAAY0D,OAAZ,CAAoB6D,IAApB,CAAR;AACA,gBAAIzC,QAAQ,CAAC,CAAb,EAAgB;AACZ,uBAAOxD,EAAEtB,SAAF,CAAYkF,KAAZ,CAAkB,CAAlB,EAAqBJ,KAArB,CAAP;AACH,aAFD,MAEO;AACH,uBAAOxD,EAAEtB,SAAT;AACH;AACJ,SAdO;AAeR;AACAwH,4BAAoB,4BAASlG,CAAT,EAAYiG,IAAZ,EAAkB;AAClC,mBAAO,CAACjG,CAAD,EAAIL,MAAJ,CAAW,KAAKqG,YAAL,CAAkBhG,CAAlB,EAAqBiG,IAArB,CAAX,CAAP;AACH,SAlBO;AAmBRE,8BAAsB,8BAASnG,CAAT,EAAY;AAC9B,mBAAO,CAACA,CAAD,EAAIL,MAAJ,CAAWK,EAAEF,WAAb,CAAP;AACH,SArBO;AAsBR;AACAsG,wBAAgB,wBAAS/D,EAAT,EAAaC,EAAb,EAAiB;AAC7B;AACA;AACA,gBAAGD,OAAO,IAAP,IAAeC,OAAO,IAAzB,EAA+B,OAAO,IAAP;AAC/B,mBAAO,CAAC,KAAK+D,sBAAL,CAA4BhE,EAA5B,EAAgCC,EAAhC,CAAD,IAAwC,KAAKgE,MAAL,CAAYjE,EAAZ,EAAgBC,EAAhB,EAAoB1C,QAApB,KAAiC9D,YAAYG,QAA5F;AACH,SA5BO;AA6BR;AACAoK,gCAAwB,gCAAShE,EAAT,EAAaC,EAAb,EAAiB;AACrC;AACA,mBAAO,KAAK4D,kBAAL,CAAwB5D,EAAxB,EAA4BF,OAA5B,CAAoCC,EAApC,IAA0C,CAAC,CAA3C,IAAgD,KAAK6D,kBAAL,CAAwB7D,EAAxB,EAA4BD,OAA5B,CAAoCE,EAApC,IAA0C,CAAC,CAAlG;AACH,SAjCO;AAkCR;AACAgE,gBAAQ,gBAASjE,EAAT,EAAaC,EAAb,EAAiB;AACrB,gBAAIC,kBAAkB,KAAKyD,YAAL,CAAkB3D,EAAlB,EAAsB7B,MAAtB,CAA6B,UAASN,CAAT,EAAW;AAC1D,uBAAOA,EAAEJ,WAAF,CAAcsC,OAAd,CAAsBE,EAAtB,IAA4B,CAAC,CAApC;AACH,aAFqB,EAEpB,IAFoB,CAAtB;AAGA,mBAAOC,gBAAgB,CAAhB,CAAP;AACH;AAxCO,KAAZ;;AA2CA;AACA,aAASgE,0CAAT,CAAoDC,KAApD,EAA2D;AACvD,YAAI7J,KAAK6J,MAAM,CAAN,CAAT;AAAA,YAAmB5J,KAAK4J,MAAM,CAAN,CAAxB;AACA,YAAIC,IAAIC,sCAAsC/J,GAAG6C,MAAzC,EAAiD5C,GAAG4C,MAApD,CAAR;AACA;AACA,YAAI7C,GAAG6C,MAAH,CAAUN,KAAV,GAAkBtC,GAAG4C,MAAH,CAAUN,KAAhC,EAAuC;AACnC,mBAAOtC,EAAP;AACH,SAFD,MAEO,IAAIA,GAAG4C,MAAH,CAAUN,KAAV,GAAkBvC,GAAG6C,MAAH,CAAUN,KAAhC,EAAuC;AAC1C,mBAAOvC,EAAP;AACH,SAFM,MAEA;AACJ,gBAAIA,GAAGE,aAAH,GAAmBD,GAAGC,aAA1B,EAAyC;AACpC,uBAAOF,EAAP;AACH,aAFF,MAEQ;AACH,uBAAOC,EAAP;AACH;AACJ;AACJ;;AAED,aAAS+J,gBAAT,CAA0BtE,EAA1B,EAA8BC,EAA9B,EAAiC;AAC/B,eAAOoE,sCAAsCrE,EAAtC,EAA0CC,EAA1C,IAAgD,CAAC,CAAxD;AACD;;AAED,aAASoE,qCAAT,CAA+CrE,EAA/C,EAAmDC,EAAnD,EAAuD;AACnD;AACA,YAAID,GAAGnD,KAAH,GAAWoD,GAAGpD,KAAlB,EAAyB;AACrB,mBAAO,CAAC,CAAR;AACH,SAFD,MAEO,IAAImD,GAAGnD,KAAH,GAAWoD,GAAGpD,KAAlB,EAAyB;AAC5B,mBAAO,CAAP;AACH,SAFM,MAEA;AACH;AACA,gBAAImD,GAAGxF,aAAH,GAAmByF,GAAGzF,aAA1B,EAAyC;AACrC,uBAAO,CAAP;AACH,aAFD,MAEO,IAAIwF,GAAGxF,aAAH,GAAmByF,GAAGzF,aAA1B,EAAyC;AAC5C,uBAAO,CAAC,CAAR;AACH,aAFM,MAED;AACF,uBAAO,CAAP;AACH;AACJ;AACJ;;AAED,aAAS+J,0BAAT,CAAoCC,OAApC,EAA6CC,IAA7C,EAAmDC,WAAnD,EAA+D;AAC3D,eAAOF,QAAQhD,IAAR,CAAakD,WAAb,EACHD,KAAKE,EADF,EAEHF,KAAKE,EAAL,CAAQC,UAFL,EAGHH,KAAKE,EAAL,CAAQE,aAHL,EAIHH,YAAYI,IAAZ,CAAiB1H,IAAjB,CAAsBsH,WAAtB,CAJG,CAAP;AAKH;;AAED,aAASK,kCAAT,CAA4CC,uBAA5C,EAAoEpK,YAApE,EAAiF;AAC/E,eAAOoK,wBAAwBtH,GAAxB,CAA4B,UAASvB,EAAT,EAAY;AAC7C,gBAAIf,QAAQR,aAAasE,GAAb,CAAiB/C,EAAjB,CAAZ;AACA,gBAAG,CAACf,KAAJ,EAAW,MAAM,IAAIuB,KAAJ,CAAU,4EAA4ER,EAAtF,CAAN;AACX,mBAAOf,KAAP;AACD,SAJM,CAAP;AAKD;;AAED,aAAS6J,kBAAT,CAA4BC,iBAA5B,EAA8CtK,YAA9C,EAA2D;AACzD,YAAIiH,IAAI,EAAR;AACA3I,eAAOI,IAAP,CAAY4L,iBAAZ,EAA+B3L,OAA/B,CAAuC,UAAS4L,GAAT,EAAa;AAClDtD,cAAEsD,GAAF,IAASD,kBAAkBC,GAAlB,EAAuBzH,GAAvB,CAA2B,UAASvB,EAAT,EAAY;AAC9C,oBAAIf,QAAQR,aAAasE,GAAb,CAAiB/C,EAAjB,CAAZ;AACA,oBAAG,CAACf,KAAJ,EAAW,MAAM,IAAIuB,KAAJ,CAAU,sEAAsER,EAAhF,CAAN;AACX,uBAAOf,KAAP;AACD,aAJQ,CAAT;AAKD,SAND;AAOA,eAAOyG,CAAP;AACD;;AAED,QAAMvF,aAAa,CAAC,CAAC8I,QAAQC,GAAR,CAAYC,KAAjC;;AAEAC,oBAAgBC,MAAhB,GAAyB,CACvB,SADuB,EAEvB,QAFuB,EAGvB,cAHuB,EAIvB,SAJuB,EAKvB,gBALuB,EAMvB,kBANuB,EAOvB,iBAPuB,EAQvB,kBARuB,EASvB,gBATuB,EAUvB,cAVuB,CAAzB;;AAaA;AACA,aAASD,eAAT,CAAyBE,kBAAzB,EAA6ChB,IAA7C,EAAkD;;AAE9CpE,qBAAamB,IAAb,CAAkB,IAAlB;;AAEA,aAAKkE,iBAAL,GAAyBjB,KAAKkB,2BAAL,KAAqClB,KAAKmB,2BAAL,GAAmC,IAAInB,KAAKmB,2BAAT,CAAqC,IAArC,CAAnC,GAAgF,EAArH,CAAzB;;AAGA,aAAKnB,IAAL,GAAYA,QAAQ,EAApB;;AAEA,aAAKA,IAAL,CAAUoB,iBAAV,GAA8B,KAAKpB,IAAL,CAAUoB,iBAAV,IAA+BN,gBAAgBM,iBAA7E;AACA,aAAKpB,IAAL,CAAUqB,SAAV,GAAsB,KAAKrB,IAAL,CAAUqB,SAAV,IAAuB,KAAKrB,IAAL,CAAUoB,iBAAV,EAA7C;AACA,aAAKpB,IAAL,CAAUsB,eAAV,GAA4B,KAAKtB,IAAL,CAAUsB,eAAV,IAA6BR,gBAAgBQ,eAAzE,CAX8C,CAW6C;;;AAG3F,YAAIlB,gBAAgB,EAApB;AACAA,sBAAc7K,sBAAd,IAAwC;AACtCgM,mCAAsB,KAAKvB,IAAL,CAAUqB;AADM,SAAxC;AAGAjB,sBAAcoB,KAAd,GAAsBpB,cAAc7K,sBAAd,CAAtB,CAlB8C,CAkBkB;;AAEhE;AACAyK,aAAKE,EAAL,GAAU;AACNC,wBAAaH,KAAKqB,SADZ;AAENjB,2BAAgBA;AAFV,SAAV;;AAMA,YAAIqB,KAAJ;AACA,YAAG,OAAOT,kBAAP,KAA8B,UAAjC,EAA4C;AACxCS,oBAAQ3B,2BAA2BkB,kBAA3B,EAA+ChB,IAA/C,EAAqD,IAArD,CAAR;AACH,SAFD,MAEM,IAAG,QAAOgB,kBAAP,yCAAOA,kBAAP,OAA8B,QAAjC,EAA0C;AAC5CS,oBAAQC,KAAKC,KAAL,CAAWD,KAAKE,SAAL,CAAeZ,kBAAf,CAAX,CAAR,CAD4C,CACY;AAC3D,SAFK,MAED;AACD,kBAAM,IAAI9I,KAAJ,CAAU,2EAAV,CAAN;AACH;;AAED,aAAK2J,MAAL,GAAc7L,gBAAgByL,KAAhB,CAAd;;AAEA,aAAKzB,IAAL,CAAU8B,OAAV,GAAoB9B,KAAK8B,OAAL,KAAiB,OAAOA,OAAP,KAAmB,WAAnB,GAAiC,EAACC,KAAM,eAAU,CAAE,CAAnB,EAAjC,GAAwDD,OAAzE,CAApB,CAtC8C,CAsC2D;AACzG,aAAK9B,IAAL,CAAU3C,GAAV,GAAgB,KAAK2C,IAAL,CAAU3C,GAAV,IAAiBH,QAAjC;AACA,aAAK8C,IAAL,CAAUgC,oBAAV,GAAiC,KAAKhC,IAAL,CAAUgC,oBAAV,IAAkCvC,0CAAnE;AACA,aAAKO,IAAL,CAAUiC,kBAAV,GAA+B,KAAKjC,IAAL,CAAUiC,kBAAV,IAAgCrD,6BAA/D;;AAEA,aAAKoB,IAAL,CAAUsB,eAAV,CAA0BnJ,GAA1B,CAA8B+J,OAAO,KAAKlC,IAAL,CAAUqB,SAAjB,CAA9B,EAA2D,IAA3D;;AAEA,aAAKJ,iBAAL,CAAuBc,GAAvB,GAA6B,KAAKd,iBAAL,CAAuBc,GAAvB,IAA+B,SAASA,GAAT,GAAc;AACxE,gBAAG,KAAK/B,IAAL,CAAU8B,OAAV,CAAkBC,GAAlB,CAAsB/J,KAAzB,EAA+B;AAC7B,qBAAKgI,IAAL,CAAU8B,OAAV,CAAkBC,GAAlB,CAAsB/J,KAAtB,CAA4B,KAAKgI,IAAL,CAAU8B,OAAtC,EAA+CvF,SAA/C;AACD,aAFD,MAEO;AACL;AACA,qBAAKyD,IAAL,CAAU8B,OAAV,CAAkBC,GAAlB,CAAsBxI,MAAMuC,SAAN,CAAgBgB,KAAhB,CAAsB9E,KAAtB,CAA4BuE,SAA5B,EAAuCjF,IAAvC,CAA4C,GAA5C,CAAtB;AACD;AACF,SAP2D,CAO1DqB,IAP0D,CAOrD,IAPqD,CAA5D,CA7C8C,CAoD7B;;AAEjB,aAAKwJ,mBAAL,GAA2B,EAA3B;AACA,aAAKC,mBAAL,GAA2B,EAA3B;;AAEA,YAAGpC,KAAKqC,MAAR,EAAe;AACb,iBAAKR,MAAL,CAAYjL,qBAAZ,CAAkCoJ,KAAKqC,MAAvC,EADa,CACqC;AACnD;;AAED;AACA,YAAGrC,KAAKsC,QAAR,EAAiB;AACf,iBAAKC,cAAL,GAAsB,IAAI,KAAKvC,IAAL,CAAU3C,GAAd,CAAkBiD,mCAAmCN,KAAKsC,QAAL,CAAc,CAAd,CAAnC,EAAqD,KAAKT,MAAL,CAAY/K,aAAjE,CAAlB,CAAtB;AACA,iBAAK0L,aAAL,GAAqBhC,mBAAmBR,KAAKsC,QAAL,CAAc,CAAd,CAAnB,EAAqC,KAAKT,MAAL,CAAY/K,aAAjD,CAArB;AACA,iBAAK2L,eAAL,GAAuBzC,KAAKsC,QAAL,CAAc,CAAd,CAAvB;AACA,iBAAKT,MAAL,CAAYjL,qBAAZ,CAAkCoJ,KAAKsC,QAAL,CAAc,CAAd,CAAlC,EAJe,CAIwC;AACxD,SALD,MAKK;AACH,iBAAKC,cAAL,GAAsB,IAAI,KAAKvC,IAAL,CAAU3C,GAAd,EAAtB;AACA,iBAAKmF,aAAL,GAAqB,EAArB;AACA,iBAAKC,eAAL,GAAuB,KAAvB;AACD;;AAED;AACA3B,wBAAgBC,MAAhB,CAAuBjM,OAAvB,CAA+B,UAASgG,KAAT,EAAe;AAC5C,iBAAKiB,EAAL,CAAQjB,KAAR,EAAe,KAAK4H,IAAL,CAAU/J,IAAV,CAAe,IAAf,EAAoBmC,KAApB,CAAf;AACD,SAFD,EAEG,IAFH;AAGH;;AAED;AACAgG,oBAAgB6B,gBAAhB,GAAmC,CAAnC;AACA7B,oBAAgBM,iBAAhB,GAAoC,YAAU;AAC5C,eAAON,gBAAgB6B,gBAAhB,EAAP;AACD,KAFD;AAGA7B,oBAAgBQ,eAAhB,GAAkC,IAAIlL,GAAJ,EAAlC;;AAEA0K,oBAAgBhF,SAAhB,GAA4BtH,OAAOoO,MAAMhH,aAAaE,SAAnB,CAAP,EAAqC;;AAE7D;AACA;AACA+G,gBAAS,kBAAU;AACjB,mBAAO,KAAK7C,IAAL,CAAU8C,aAAjB;AACA,gBAAG,KAAKL,eAAR,EAAyB;AACzB,iBAAKA,eAAL,GAAuB,IAAvB;AACA,iBAAKC,IAAL,wBAA+B,KAAK1C,IAAL,CAAU+C,QAAzC;AACA,iBAAKC,gBAAL;AACD,SAV4D;;AAY7DA,0BAAmB,4BAAU;AAAA;;AAC3B;AACA;AACA,iBAAKC,sBAAL;;AAEA,gBAAIC,eACA,KAAKX,cAAL,CAAoBzE,IAApB,GACA7E,GADA,CACI,UAASC,CAAT,EAAW;AAAE,uBAAO,CAACA,CAAD,EAAIL,MAAJ,CAAWmG,MAAME,YAAN,CAAmBhG,CAAnB,CAAX,CAAP;AAA0C,aAD3D,EAC4D,IAD5D,EAEAC,MAFA,CAEO,UAASC,CAAT,EAAWC,CAAX,EAAa;AAAC,uBAAOD,EAAEP,MAAF,CAASQ,CAAT,CAAP;AAAoB,aAFzC,EAE0C,EAF1C,GAEkD;AAClDF,kBAHA,CAGO,UAASC,CAAT,EAAWC,CAAX,EAAa;AAAC,uBAAOD,EAAEkC,OAAF,CAAUjC,CAAV,IAAe,CAAC,CAAhB,GAAoBD,CAApB,GAAwBA,EAAEP,MAAF,CAASQ,CAAT,CAA/B;AAA4C,aAHjE,EAGkE,EAHlE,EAIC8J,IAJD,CAIMvD,qCAJN,CADJ;;AAOA,iBAAK,IAAIrH,IAAI,CAAR,EAAWC,MAAM0K,aAAa7K,MAAnC,EAA2CE,IAAIC,GAA/C,EAAoDD,GAApD,EAAyD;AACrD,oBAAI6K,cAAcF,aAAa3K,CAAb,CAAlB;;AAEA,oBAAG6K,YAAYC,MAAZ,KAAuB7M,SAA1B,EAAqC;AACjC,yBAAK,IAAI8M,UAAU,CAAd,EAAiBC,UAAUH,YAAYC,MAAZ,CAAmBhL,MAAnD,EAA2DiL,UAAUC,OAArE,EAA8ED,SAA9E,EAAyF;AACrF,4BAAIE,QAAQJ,YAAYC,MAAZ,CAAmBC,OAAnB,CAAZ;AACA,6BAAK,IAAIG,WAAW,CAAf,EAAkBC,WAAWF,MAAMnL,MAAxC,EAAgDoL,WAAWC,QAA3D,EAAqED,UAArE,EAAiF;AAC7E,gCAAIE,YAAYH,MAAMC,QAAN,CAAhB;AACA,gCAAI;AACFE,0CAAU5G,IAAV,CAAe,KAAKkE,iBAApB,EAAuC,IAAvC;AACD,6BAFD,CAEE,OAAO2C,CAAP,EAAS;AACT,qCAAKC,YAAL,CAAkBD,CAAlB,EAAqBD,SAArB;AACA;AACD;AACJ;AACJ;AACJ;;AAED;AACA,oBAAGP,YAAYjJ,OAAf,EAAwBiJ,YAAYjJ,OAAZ,CAAoBrF,OAApB,CAA6B,kBAAU;AAC7D,0BAAKmM,iBAAL,CAAuB6C,YAAvB,CAAoC1J,OAAO1C,EAA3C;AACD,iBAFuB;;AAIxB;AACA,oBAAG,KAAKsI,IAAL,CAAU8C,aAAV,IACCM,YAAYpM,KAAZ,KAAsB,OADvB,IAECoM,YAAY9K,MAAZ,CAAmBtB,KAAnB,KAA6B,OAFjC,EAEyC;;AAEvC,yBAAKiK,iBAAL,CAAuB8C,IAAvB,CAA4B;AAC1B9M,gCAAQ,UADkB;AAE1BO,8BAAM,iBAAiB,KAAKwI,IAAL,CAAU+C;AAFP,qBAA5B;;AAKA,yBAAK/C,IAAL,CAAUsB,eAAV,CAA0B7D,MAA1B,CAAiC,KAAKuC,IAAL,CAAUqB,SAA3C;AACD;AACJ;AAEF,SA7D4D;;AA+D7D;AACA2C,eAAQ,iBAAW;AACf,iBAAKC,UAAL;AACA,iBAAKC,eAAL;AACA,mBAAO,KAAKC,gBAAL,EAAP;AACH,SApE4D;;AAsE7D;;;;;AAKAC,oBAAa,oBAASC,EAAT,EAAa;AACtBA,iBAAK,KAAKJ,UAAL,CAAgBI,EAAhB,CAAL;AACA,iBAAKC,QAAL,CAAc,IAAd,EAAoBD,EAApB;AACH,SA9E4D;;AAgF7DJ,oBAAa,oBAASI,EAAT,EAAY;AAAA;;AACrB,gBAAI,OAAOA,EAAP,KAAc,UAAlB,EAA8B;AAC1BA,qBAAKE,GAAL;AACH;;AAED,iBAAK7B,IAAL,CAAU,6BAAV;;AAEA;AACA;AACA;AACA,iBAAKb,MAAL,CAAYjI,UAAZ,CAAuB9E,OAAvB,CAAgC;AAAA,uBAAK,OAAKyN,cAAL,CAAoBjF,GAApB,CAAwBpE,CAAxB,CAAL;AAAA,aAAhC;;AAEA,mBAAOmL,EAAP;AACH,SA7F4D;;AA+F7D;AACAF,0BAAmB,4BAAW;AAC1B,mBAAO,KAAK5B,cAAL,CAAoBzE,IAApB,GAA2B7E,GAA3B,CAA+B,UAASC,CAAT,EAAW;AAAC,uBAAOA,EAAExB,EAAT;AAAa,aAAxD,CAAP;AACH,SAlG4D;;AAoG7D;AACA8M,8BAAuB,gCAAW;AAC9B,mBAAO,KAAKjC,cAAL,CAAoBzE,IAApB,GACC7E,GADD,CACK,UAASC,CAAT,EAAW;AAAE,uBAAO,CAACA,CAAD,EAAIL,MAAJ,CAAWmG,MAAME,YAAN,CAAmBhG,CAAnB,CAAX,CAAP;AAA0C,aAD5D,EAC6D,IAD7D,EAECC,MAFD,CAEQ,UAASC,CAAT,EAAWC,CAAX,EAAa;AAAC,uBAAOD,EAAEP,MAAF,CAASQ,CAAT,CAAP;AAAoB,aAF1C,EAE2C,EAF3C,GAEmD;AAClDJ,eAHD,CAGK,UAASC,CAAT,EAAW;AAAC,uBAAOA,EAAExB,EAAT;AAAa,aAH9B,EAICyB,MAJD,CAIQ,UAASC,CAAT,EAAWC,CAAX,EAAa;AAAC,uBAAOD,EAAEkC,OAAF,CAAUjC,CAAV,IAAe,CAAC,CAAhB,GAAoBD,CAApB,GAAwBA,EAAEP,MAAF,CAASQ,CAAT,CAA/B;AAA4C,aAJlE,EAImE,EAJnE,CAAP,CAD8B,CAKiD;AAClF,SA3G4D;;AA8G7D;AACAgH,cAAO,cAASoE,SAAT,EAAoB;AACvB,mBAAO,KAAKD,oBAAL,GAA4BlJ,OAA5B,CAAoCmJ,SAApC,IAAiD,CAAC,CAAzD;AACH,SAjH4D;;AAmH7D;AACAC,iBAAU,iBAASD,SAAT,EAAoB;AAC1B,mBAAO,KAAKhC,eAAZ;AACH,SAtH4D;;AAwH7D;AACAyB,yBAAkB,yBAASN,CAAT,EAAY;AAC1B,gBAAIe,qBAAJ;AAAA,gBAAkBC,kBAAlB;AAAA,gBAA6BC,wBAA7B;AAAA,gBAA8CC,yBAA9C;;AAD0B,gCAEqC,KAAKC,aAAL,CAAmBnB,CAAnB,CAFrC;;AAAA;;AAEzBiB,2BAFyB;AAERC,4BAFQ;AAEUF,qBAFV;AAEqBD,wBAFrB;;;AAI1B,mBAAOC,SAAP,EAAkB;AAAA,4CACY,KAAKI,qCAAL,CAA2CL,YAA3C,EAAyDG,gBAAzD,EAA2ED,eAA3E,CADZ;;AAAA;;AACfF,4BADe;AACDC,yBADC;AAEjB;;AAED,iBAAKK,cAAL,CAAoBH,gBAApB,EAAsCD,eAAtC;AACH,SAlI4D;;AAoI7DG,+CAAwC,+CAASL,YAAT,EAAuBG,gBAAvB,EAAyCD,eAAzC,EAAyD;AAC7F,gBAAIK,sBAAuB,KAAKC,kBAAL,CAAwBR,YAAxB,EAAsC,IAAtC,CAA3B;AACA,gBAAGO,oBAAoBnH,OAApB,EAAH,EAAiC;AAC/B4G,+BAAe,KAAKvC,mBAAL,CAAyBgD,KAAzB,MAAoC,IAAnD;AACAF,sCAAsB,KAAKC,kBAAL,CAAwBR,YAAxB,EAAsC,KAAtC,CAAtB;AACD;;AAED,iBAAK/H,IAAL,CAAU,kBAAV,EAA8B+H,YAA9B;AACA,gBAAIU,qBAAJ;AAAA,gBAAkBC,sBAAlB;;AAR6F,oCAS7D,KAAKC,iBAAL,CAAuBZ,YAAvB,EAAqCO,mBAArC,CAT6D;;AAAA;;AAS5FG,wBAT4F;AAS9EC,yBAT8E;;AAU7F,gBAAGD,YAAH,EAAiBA,aAAavQ,OAAb,CAAsB;AAAA,uBAAK+P,gBAAgBvH,GAAhB,CAAoBpE,CAApB,CAAL;AAAA,aAAtB;AACjB,gBAAGoM,aAAH,EAAkBA,cAAcxQ,OAAd,CAAuB;AAAA,uBAAKgQ,iBAAiBxH,GAAjB,CAAqBpE,CAArB,CAAL;AAAA,aAAvB;AAClB,iBAAK0D,IAAL,CAAU,gBAAV,EAA4B+H,YAA5B;AACA,gBAAIC,YAAY,CAACM,oBAAoBnH,OAApB,EAAD,IAAkC,KAAKqE,mBAAL,CAAyB/J,MAA3E;AACA,mBAAO,CAACsM,YAAD,EAAeC,SAAf,CAAP;AACH,SAnJ4D;;AAqJ7DG,uBAAgB,uBAASnB,CAAT,EAAW;AAAA;;AACvB,iBAAKhH,IAAL,CAAU,gBAAV;;AAEA;AACA,iBAAK2F,cAAL,CAAoBzE,IAApB,GAA2BhJ,OAA3B,CAAmC,iBAAS;AAC1C,oBAAG6B,MAAMwD,OAAT,EAAkBxD,MAAMwD,OAAN,CAAcrF,OAAd,CAAuB,kBAAW;AAClD,wBAAGsF,OAAOoL,WAAV,EAAsB;AACpB;AACA,+BAAKvE,iBAAL,CAAuB8C,IAAvB,CAA4B;AAC1B9M,2CAAamD,OAAO1C,EADM;AAE1BF,kCAAMoM,EAAEpM,IAFkB;AAG1BiO,kCAAO7B,EAAE6B;AAHiB,yBAA5B;AAKD;AACD,wBAAGrL,OAAO1C,EAAP,KAAckM,EAAEb,QAAnB,EAA4B;AAC1B;AACA,4BAAG3I,OAAOC,QAAV,EAAoBD,OAAOC,QAAP,CAAgBvF,OAAhB,CAAyB;AAAA,mCAAW,OAAK4Q,eAAL,CAAqB9B,CAArB,EAAwB+B,MAAxB,CAAX;AAAA,yBAAzB;AACrB;AACF,iBAbiB;AAcnB,aAfD;;AAiBA,gBAAI/B,CAAJ,EAAO,KAAKxB,mBAAL,CAAyBrK,IAAzB,CAA8B6L,CAA9B;;AAEP,gBAAIiB,kBAAkB,IAAIxH,GAAJ,EAAtB;AAAA,gBAAiCyH,mBAAmB,IAAIzH,GAAJ,EAApD;AACA,gBAAIuH,YAAY,IAAhB;AACA,gBAAID,eAAe,IAAnB;AACA,mBAAO,CAACG,gBAAD,EAAmBD,eAAnB,EAAoCD,SAApC,EAA+CD,YAA/C,CAAP;AACH,SAhL4D;;AAkL7DM,wBAAiB,wBAASH,gBAAT,EAA2BD,eAA3B,EAA4CR,EAA5C,EAA+C;AAAA;;AAC5D,gBAAIuB,iBAAiBrM,MAAM3E,IAAN,CAAW,IAAIyI,GAAJ,CAAQ,6BAAIyH,gBAAJ,GAAsBpL,MAAtB,CAA6B;AAAA,uBAAKR,EAAEiB,OAAF,IAAa,CAAC0K,gBAAgB5M,GAAhB,CAAoBiB,CAApB,CAAnB;AAAA,aAA7B,CAAR,CAAX,EAA6FiK,IAA7F,CAAkGtD,gBAAlG,CAArB;;AAEA;AACA+F,2BAAe9Q,OAAf,CAAwB,aAAK;AACzBoE,kBAAEiB,OAAF,CAAUrF,OAAV,CAAmB;AAAA,2BAAM,OAAK4Q,eAAL,CAAqB,IAArB,EAA0BG,CAA1B,CAAN;AAAA,iBAAnB;AACH,aAFD;;AAIA;AACAhB,4BAAgB/P,OAAhB,CAAyB,aAAK;AAC5B,oBAAGoE,EAAEiB,OAAL,EAAcjB,EAAEiB,OAAF,CAAUrF,OAAV,CAAmB,kBAAU;AACzC,2BAAKmM,iBAAL,CAAuB6C,YAAvB,CAAoC1J,OAAO1C,EAA3C;AACD,iBAFa;AAGf,aAJD;;AAMA;AACA;AACA;;AAEA,iBAAK+K,eAAL,GAAuB,KAAKF,cAAL,CAAoBzE,IAApB,GAA2B7D,KAA3B,CAAiC,UAASf,CAAT,EAAW;AAAE,uBAAOA,EAAEJ,QAAF,KAAe9D,YAAYM,KAAlC;AAA0C,aAAxF,CAAvB;AACA,gBAAG,KAAKmN,eAAR,EAAwB;AACtB,qBAAKO,gBAAL;AACD;AACD,iBAAKpG,IAAL,CAAU,cAAV;AACA,gBAAGyH,EAAH,EAAOA,GAAG7N,SAAH,EAAc,KAAK2N,gBAAL,EAAd;AACV,SA3M4D;;AA6M7DlB,gCAAyB,kCAAU;AAAA;AAAA;AAAA;;AAAA;AACjC,sCAA2B,KAAKhC,iBAAL,CAAuB6E,SAAlD,mIAA4D;AAAA,wBAAnDC,cAAmD;;AAC1D,wBAAG,CAACA,eAAeC,WAAf,CAA2BC,KAA/B,EAAsC;AACtC,yBAAKvD,IAAL,CAAU,yBAAV,EAAqCqD,cAArC;AACAG,iCAAaH,eAAeI,aAA5B;AACA,yBAAKlF,iBAAL,CAAuB6E,SAAvB,CAAiCrI,MAAjC,CAAwCsI,cAAxC;AACD;AANgC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAOjCtR,mBAAOI,IAAP,CAAY,KAAKoM,iBAAL,CAAuBmF,WAAnC,EAAgDtR,OAAhD,CAAwD,UAASuR,GAAT,EAAa;AACnE,uBAAO,KAAKpF,iBAAL,CAAuBmF,WAAvB,CAAmCC,GAAnC,CAAP;AACD,aAFD,EAEG,IAFH;AAGD,SAvN4D;;AAyN7DC,8BAAuB,8BAAS1C,CAAT,EAAYS,EAAZ,EAAgB;AACnC,gBAAIM,qBAAJ;AAAA,gBAAkBC,kBAAlB;AAAA,gBAA6BC,wBAA7B;AAAA,gBAA8CC,yBAA9C;;AADmC,iCAE4B,KAAKC,aAAL,CAAmBnB,CAAnB,CAF5B;;AAAA;;AAElCiB,2BAFkC;AAEjBC,4BAFiB;AAECF,qBAFD;AAEYD,wBAFZ;;;AAInC,qBAAS4B,QAAT,CAAkB3J,IAAlB,EAAuB;AACrB,qBAAKA,IAAL,CAAUA,IAAV;;AADqB,6CAEO,KAAKoI,qCAAL,CAA2CL,YAA3C,EAAyDG,gBAAzD,EAA2ED,eAA3E,CAFP;;AAAA;;AAEpBF,4BAFoB;AAENC,yBAFM;;;AAIrB,oBAAGA,SAAH,EAAa;AACX,yBAAKhI,IAAL,CAAU,kBAAV;AACA4J,iCAAaD,SAAS5N,IAAT,CAAc,IAAd,CAAb,EAAiC,iBAAjC;AACD,iBAHD,MAGK;AACH,yBAAKsM,cAAL,CAAoBH,gBAApB,EAAsCD,eAAtC,EAAuDR,EAAvD;AACD;AACF;AACDkC,qBAASxJ,IAAT,CAAc,IAAd,EAAmB,gBAAnB;AACH,SAzO4D;;AA2O7D;AACAwI,2BAAoB,2BAASZ,YAAT,EAAuBO,mBAAvB,EAA4C;AAAA;;AAE5D,iBAAKxC,IAAL,CAAU,yCAAV,EAAqDiC,YAArD;;AAEA,iBAAKjC,IAAL,CAAU,sBAAV,EAAkCwC,mBAAlC;;AAEA,gBAAI,CAACA,oBAAoBnH,OAApB,EAAL,EAAoC;;AAEhC,qBAAK2E,IAAL,CAAU,oBAAV,EAAgCwC,mBAAhC;;AAEA;AACA;AACA,oBAAIuB,iCAAiC,IAAI,KAAKzG,IAAL,CAAU3C,GAAd,CAAkB6H,oBAAoBpH,IAApB,GAA2BpE,MAA3B,CAAkCjE,qBAAlC,CAAlB,CAArC;;AAEA,oBAAIiR,cAAc,KAAKC,gBAAL,CAAsBF,8BAAtB,CAAlB;AAAA,oBACIG,oBAAoBF,YAAY,CAAZ,CADxB;AAAA,oBAEIrB,eAAeqB,YAAY,CAAZ,CAFnB;;AAIA,oBAAIpB,gBAAgB,KAAKuB,iBAAL,CAAuBJ,8BAAvB,CAApB;;AAEA,qBAAK/D,IAAL,CAAU,oBAAV,EAAgCkE,iBAAhC;AACA,qBAAKlE,IAAL,CAAU,eAAV,EAA2B2C,YAA3B;AACA,qBAAK3C,IAAL,CAAU,gBAAV,EAA4B4C,aAA5B;;AAEA,oBAAIwB,0BAA0B,IAAI,KAAK9G,IAAL,CAAU3C,GAAd,EAA9B;;AAEA;AACA,qBAAKqF,IAAL,CAAU,8BAAV;;AAEA,qBAAK,IAAInK,IAAI,CAAR,EAAWC,MAAM6M,aAAahN,MAAnC,EAA2CE,IAAIC,GAA/C,EAAoDD,GAApD,EAAyD;AACrD,wBAAI6K,cAAciC,aAAa9M,CAAb,CAAlB;;AAEA,wBAAG6K,YAAYrK,QAAf,EAAyB,KAAKwJ,cAAL,CAAoB/E,MAApB,CAA2B4F,WAA3B;;AAEzB,yBAAKV,IAAL,CAAU,UAAV,EAAsBU,YAAY1L,EAAlC;;AAEA;AACA,yBAAKkF,IAAL,CAAU,QAAV,EAAmBwG,YAAY1L,EAA/B;;AAEA,wBAAG0L,YAAYC,MAAZ,KAAuB7M,SAA1B,EAAqC;AACjC,6BAAK,IAAI8M,UAAU,CAAd,EAAiBC,UAAUH,YAAYC,MAAZ,CAAmBhL,MAAnD,EAA2DiL,UAAUC,OAArE,EAA8ED,SAA9E,EAAyF;AACrF,gCAAIE,QAAQJ,YAAYC,MAAZ,CAAmBC,OAAnB,CAAZ;AACA,iCAAK,IAAIG,WAAW,CAAf,EAAkBC,WAAWF,MAAMnL,MAAxC,EAAgDoL,WAAWC,QAA3D,EAAqED,UAArE,EAAiF;AAC7E,oCAAIE,YAAYH,MAAMC,QAAN,CAAhB;AACA,oCAAI;AACFE,8CAAU5G,IAAV,CAAe,KAAKkE,iBAApB,EAAuC0D,YAAvC;AACD,iCAFD,CAEE,OAAOf,CAAP,EAAS;AACT,yCAAKC,YAAL,CAAkBD,CAAlB,EAAqBD,SAArB;AACA;AACD;AACJ;AACJ;AACJ;;AAED,wBAAIkC,CAAJ;AACA,wBAAIzC,YAAYrJ,UAAhB,EAA4B;AAAA;AAAA;AAAA;;AAAA;AACxB,kDAAsBqJ,YAAYrJ,UAAlC,mIAA6C;AAAA,oCAArCA,UAAqC;;AACzC,oCAAIA,WAAWgN,MAAf,EAAuB;AACnBlB,wCAAI,WAASmB,EAAT,EAAa;AACb,+CAAOA,GAAGlO,QAAH,KAAgB9D,YAAYC,KAA5B,IAAqCmO,YAAYpK,WAAZ,CAAwBsC,OAAxB,CAAgC0L,EAAhC,IAAsC,CAAC,CAAnF;AACH,qCAFD;AAGH,iCAJD,MAIO;AACHnB,wCAAI,WAASmB,EAAT,EAAa;AACb,+CAAOA,GAAG1O,MAAH,KAAc8K,WAArB;AACH,qCAFD;AAGH;AACD;AACA,qCAAKZ,aAAL,CAAmBzI,WAAWrC,EAA9B,IAAoC2N,aAAa3L,MAAb,CAAoBmM,CAApB,CAApC;AACH;AAbuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAc3B;AACJ;;AAED;AACA;AACA,oBAAIoB,oBAAoB/B,oBAAoBpH,IAApB,GAA2BqF,IAA3B,CAAgCvN,oBAAhC,CAAxB;;AAEA,qBAAK8M,IAAL,CAAU,gCAAV;;AAGA,qBAAK,IAAIwE,SAAS,CAAb,EAAgB1O,MAAMyO,kBAAkB5O,MAA7C,EAAqD6O,SAAS1O,GAA9D,EAAmE0O,QAAnE,EAA6E;AACzE,wBAAIzO,aAAawO,kBAAkBC,MAAlB,CAAjB;;AAEA,wBAAIC,YAAY1O,WAAW9C,OAAX,IAAsB8C,WAAW9C,OAAX,CAAmBsD,GAAnB,CAAuB,UAAShC,MAAT,EAAgB;AAAC,+BAAOA,OAAOS,EAAd;AAAkB,qBAA1D,CAAtC;;AAEA,yBAAKkF,IAAL,CAAU,cAAV,EAAyBnE,WAAWC,MAAX,CAAkBhB,EAA3C,EAA8CyP,SAA9C,EAAyD1O,WAAWC,MAAX,CAAkBxC,WAAlB,CAA8BoF,OAA9B,CAAsC7C,UAAtC,CAAzD;;AAEA,wBAAGA,WAAWoC,YAAX,KAA4BrE,SAA/B,EAA0C;AACtC,6BAAK,IAAI4Q,QAAQ,CAAZ,EAAeC,QAAQ5O,WAAWoC,YAAX,CAAwBxC,MAApD,EAA4D+O,QAAQC,KAApE,EAA2ED,OAA3E,EAAoF;AAChF,gCAAIzD,aAAYlL,WAAWoC,YAAX,CAAwBuM,KAAxB,CAAhB;AACA,gCAAI;AACFzD,2CAAU5G,IAAV,CAAe,KAAKkE,iBAApB,EAAuC0D,YAAvC;AACD,6BAFD,CAEE,OAAOf,CAAP,EAAS;AACT,qCAAKC,YAAL,CAAkBD,CAAlB,EAAqBD,UAArB;AACA;AACD;AACJ;AACJ;AACJ;;AAED,qBAAKjB,IAAL,CAAU,+BAAV;;AAEA,qBAAK,IAAI4E,WAAW,CAAf,EAAkBC,WAAWjC,cAAcjN,MAAhD,EAAwDiP,WAAWC,QAAnE,EAA6ED,UAA7E,EAAyF;AACrF,wBAAIE,eAAelC,cAAcgC,QAAd,CAAnB;;AAEA,wBAAGE,aAAazO,QAAhB,EAA0B,KAAKwJ,cAAL,CAAoBjF,GAApB,CAAwBkK,YAAxB;;AAE1B,yBAAK9E,IAAL,CAAU,UAAV,EAAsB8E,aAAa9P,EAAnC;;AAEA,yBAAKkF,IAAL,CAAU,SAAV,EAAoB4K,aAAa9P,EAAjC;;AAEA,wBAAG8P,aAAaC,OAAb,KAAyBjR,SAA5B,EAAuC;AACnC,6BAAK,IAAIkR,WAAW,CAAf,EAAkBC,WAAWH,aAAaC,OAAb,CAAqBpP,MAAvD,EAA+DqP,WAAWC,QAA1E,EAAoFD,UAApF,EAAgG;AAC5F,gCAAIlE,SAAQgE,aAAaC,OAAb,CAAqBC,QAArB,CAAZ;AACA,iCAAK,IAAIjE,YAAW,CAAf,EAAkBC,YAAWF,OAAMnL,MAAxC,EAAgDoL,YAAWC,SAA3D,EAAqED,WAArE,EAAiF;AAC7E,oCAAIE,cAAYH,OAAMC,SAAN,CAAhB;AACA,oCAAI;AACFE,gDAAU5G,IAAV,CAAe,KAAKkE,iBAApB,EAAuC0D,YAAvC;AACD,iCAFD,CAEE,OAAOf,CAAP,EAAS;AACT,yCAAKC,YAAL,CAAkBD,CAAlB,EAAqBD,WAArB;AACA;AACD;AACJ;AACJ;AACJ;AACJ;;AAED,qBAAK,IAAI2D,WAAW,CAAf,EAAkBC,WAAWjC,cAAcjN,MAAhD,EAAwDiP,WAAWC,QAAnE,EAA6ED,UAA7E,EAAyF;AACrF,wBAAIE,eAAelC,cAAcgC,QAAd,CAAnB;AACA,wBAAGE,aAAa1O,QAAb,KAA0B9D,YAAYM,KAAzC,EAA+C;AAC7C,4BAAIgD,SAASkP,aAAalP,MAA1B;AACA,4BAAIsP,cAActP,OAAOA,MAAzB;AACA,6BAAK8J,mBAAL,CAAyBrK,IAAzB,CAA8B,EAACP,MAAO,gBAAgBc,OAAOZ,EAA/B,EAAmC+N,MAAO+B,aAAaK,QAAvD,EAA9B,EAH6C,CAGuD;AACpG,4BAAGD,eAAeA,YAAY9O,QAAZ,KAAyB9D,YAAYG,QAAvD,EAAgE;AAC5D,gCAAGyS,YAAY7Q,MAAZ,CAAmBkD,KAAnB,CAAyB;AAAA,uCAAK,OAAK6N,cAAL,CAAoB5O,CAApB,CAAL;AAAA,6BAAzB,CAAH,EAA0D;AACtD,qCAAKkJ,mBAAL,CAAyBrK,IAAzB,CAA8B,EAACP,MAAO,gBAAgBoQ,YAAYlQ,EAApC,EAA9B;AACH;AACJ;AACF;AACJ;;AAID,qBAAKgL,IAAL,CAAU,oBAAV,EAAgC,KAAKH,cAArC;;AAEA;AACA,oBAAI,CAACuE,wBAAwB/I,OAAxB,EAAL,EAAwC;AACpC,yBAAK2E,IAAL,CAAU,yCAAV,EAAqDoE,uBAArD;AACA,yBAAK1E,mBAAL,CAAyBrK,IAAzB,CAA8B+O,uBAA9B;AACH;AAEJ;;AAED;AACA,mBAAO,CAACzB,YAAD,EAAeC,aAAf,CAAP;AACH,SAtY4D;;AAyY7DwC,wBAAiB,wBAAS5O,CAAT,EAAW;AAAA;;AACxB,gBAAGA,EAAEJ,QAAF,KAAe9D,YAAYE,SAA9B,EAAwC;AACpC,uBAAOgE,EAAEnC,MAAF,CAAS2H,IAAT,CAAc;AAAA,2BAAKxF,EAAEJ,QAAF,KAAe9D,YAAYM,KAA3B,IAAoC,OAAKiN,cAAL,CAAoB1E,QAApB,CAA6B3E,CAA7B,CAAzC;AAAA,iBAAd,CAAP;AACH,aAFD,MAEM,IAAGA,EAAEJ,QAAF,KAAe9D,YAAYG,QAA9B,EAAuC;AACzC,uBAAO+D,EAAEnC,MAAF,CAASkD,KAAT,CAAe,KAAK6N,cAAL,CAAoBnP,IAApB,CAAyB,IAAzB,CAAf,CAAP;AACH,aAFK,MAED;AACD,uBAAO,KAAP;AACH;AACJ,SAjZ4D;;AAmZ7D;AACA+M,yBAAkB,yBAASf,YAAT,EAAuBhB,SAAvB,EAAkC;AAChD,gBAAI;AACF,uBAAOA,UAAU5G,IAAV,CAAe,KAAKkE,iBAApB,EAAuC0D,YAAvC,CAAP,CADE,CAC+D;AAClE,aAFD,CAEE,OAAOf,CAAP,EAAS;AACT,qBAAKC,YAAL,CAAkBD,CAAlB,EAAqBD,SAArB;AACD;AACJ,SA1Z4D;;AA4Z7DE,sBAAe,sBAASD,CAAT,EAAYD,SAAZ,EAAsB;AACnC,gBAAI7I,QACF8I,aAAa1L,KAAb,IAAsB0L,EAAEmE,SAAF,CAAYvQ,IAAZ,KAAqB,OAA3C,GAAsD;AACpD;AACEA,sBAAK,iBADP;AAEEiO,sBAAO;AACLuC,6BAASrE,UAAUqE,OADd;AAELC,0BAAMtE,UAAUsE,IAFX;AAGLC,4BAAQvE,UAAUuE,MAHb;AAILC,4BAAQvE,EAAEwE;AAJL,iBAFT;AAQE7R,sBAAO;AART,aADF,GAWGqN,EAAEpM,IAAF,GACCoM,CADD,GAEC;AACEpM,sBAAK,iBADP;AAEEiO,sBAAK7B,CAFP;AAGErN,sBAAO;AAHT,aAdN;AAoBA,iBAAK6L,mBAAL,CAAyBrK,IAAzB,CAA8B+C,KAA9B;AACA,iBAAK8B,IAAL,CAAU,SAAV,EAAqB9B,KAArB;AACD,SAnb4D;;AAqb7D;AACA6L,0BAAmB,0BAASzQ,WAAT,EAAsB;AACrC,gBAAImP,eAAe,IAAI,KAAKrF,IAAL,CAAU3C,GAAd,EAAnB;AACA,gBAAIuJ,oBAAoB,IAAI,KAAK5G,IAAL,CAAU3C,GAAd,EAAxB;;AAEA;AACA;AACA;AACA;AACA,gBAAIgL,iBAAiBnS,YAAY4H,IAAZ,EAArB;AACA,iBAAK,IAAIsJ,QAAQ,CAAZ,EAAeC,QAAQgB,eAAehQ,MAA3C,EAAmD+O,QAAQC,KAA3D,EAAkED,OAAlE,EAA2E;AACvE,oBAAI3O,aAAa4P,eAAejB,KAAf,CAAjB;AACA,oBAAIjM,QAAQ1C,WAAW0C,KAAvB;AAAA,oBACImN,OAAOnN,MAAMnC,WADjB;;AAGA;AACA;AACA;AACA,oBAAIuP,aAAa,KAAKhG,cAAL,CAAoBzE,IAApB,EAAjB;AACA,qBAAK,IAAI0K,SAAS,CAAb,EAAgBC,SAASF,WAAWlQ,MAAzC,EAAiDmQ,SAASC,MAA1D,EAAkED,QAAlE,EAA4E;AACxE,wBAAI7R,QAAQ4R,WAAWC,MAAX,CAAZ;AACA,wBAAGF,KAAKhN,OAAL,CAAa3E,KAAb,IAAsB,CAAC,CAA1B,EAA4B;AACxBiQ,0CAAkBtJ,GAAlB,CAAsB3G,KAAtB;AACA0O,qCAAa/H,GAAb,CAAiB3G,KAAjB;AACA,4BAAIiB,YAAYoH,MAAME,YAAN,CAAmBvI,KAAnB,EAAyBwE,KAAzB,CAAhB;AACA,6BAAK,IAAIuN,SAAS,CAAb,EAAgBC,SAAS/Q,UAAUS,MAAxC,EAAgDqQ,SAASC,MAAzD,EAAiED,QAAjE,EAA2E;AACvErD,yCAAa/H,GAAb,CAAiB1F,UAAU8Q,MAAV,CAAjB;AACH;AACJ;AACJ;AACJ;;AAED,gBAAIE,qBAAqBvD,aAAavH,IAAb,GAAoBqF,IAApB,CAAyBvD,qCAAzB,CAAzB;AACA,mBAAO,CAACgH,iBAAD,EAAoBgC,kBAApB,CAAP;AACH,SAvd4D;;AAyd7D/B,2BAAoB,2BAASgC,kBAAT,EAA4B;AAC5C,gBAAIC,gBAAgB,IAAIzL,GAAJ,EAApB;AACA;AACA,iBAAK0L,gBAAL,CAAsBF,kBAAtB,EAA0CC,aAA1C;AACA,mBAAO,6BAAIA,aAAJ,GAAmB3F,IAAnB,CAAwBtD,gBAAxB,CAAP;AACH,SA9d4D;;AAge7DkJ,0BAAmB,0BAAS7S,WAAT,EAAsB4S,aAAtB,EAAoC;AAAA;AAAA;AAAA;;AAAA;AACrD,sCAAa5S,YAAY4H,IAAZ,EAAb,mIAAgC;AAAA,wBAAxBpI,CAAwB;AAAA;AAAA;AAAA;;AAAA;AAC5B,8CAAaA,EAAEC,OAAf,mIAAuB;AAAA,gCAAfuD,CAAe;;AACnB,iCAAK8P,2BAAL,CAAiC9P,CAAjC,EAAmC4P,aAAnC;AACH;AAH2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAI5B,wBAAIG,WAAWvT,EAAEyF,KAAjB;AAJ4B;AAAA;AAAA;;AAAA;AAK5B,8CAAa,KAAK+N,yBAAL,CAA+BxT,CAA/B,CAAb,mIAA+C;AAAA,gCAAvCwD,EAAuC;;AAC3C,iCAAKiQ,yBAAL,CAA+BjQ,EAA/B,EAAkC+P,QAAlC,EAA4CH,aAA5C;AACH;AAP2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQ/B;AAToD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUtD,SA1e4D;;AA4e7DI,mCAA4B,mCAASzQ,UAAT,EAAoB;AAC9C,gBAAI9C,UAAU,IAAI0H,GAAJ,EAAd;AAD8C;AAAA;AAAA;;AAAA;AAE9C,sCAAa5E,WAAW9C,OAAxB,mIAAgC;AAAA,wBAAxBuD,CAAwB;;AAC5B,wBAAGA,EAAEJ,QAAF,KAAe9D,YAAYI,OAA9B,EAAsC;AAClC,4BAAG8D,EAAExB,EAAF,IAAQ,KAAK8K,aAAhB,EACI,KAAKA,aAAL,CAAmBtJ,EAAExB,EAArB,EAAyB5C,OAAzB,CAAkC;AAAA,mCAASa,QAAQ2H,GAAR,CAAY3G,KAAZ,CAAT;AAAA,yBAAlC,EADJ,KAGI,6BAAI,KAAKuS,yBAAL,CAA+BhQ,EAAEhD,WAAF,CAAc,CAAd,CAA/B,CAAJ,GAAsDpB,OAAtD,CAA+D;AAAA,mCAASa,QAAQ2H,GAAR,CAAY3G,KAAZ,CAAT;AAAA,yBAA/D;AACP,qBALD,MAKO;AACHhB,gCAAQ2H,GAAR,CAAYpE,CAAZ;AACH;AACJ;AAX6C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAY9C,mBAAOvD,OAAP;AACD,SAzf4D;;AA2f7DqT,qCAA8B,qCAASrS,KAAT,EAAemS,aAAf,EAA6B;AAAA;;AACzD,gBAAGnS,MAAMmC,QAAN,KAAmB9D,YAAYI,OAAlC,EAA0C;AACtC,oBAAG,KAAKoN,aAAL,CAAmB7L,MAAMe,EAAzB,CAAH,EAAgC;AAAA;AAAA;AAAA;;AAAA;AAC5B,+CAAa,KAAK8K,aAAL,CAAmB7L,MAAMe,EAAzB,CAAb;AAAA,gCAAQwB,CAAR;;AACI,iCAAK8P,2BAAL,CAAiC9P,CAAjC,EAAmC4P,aAAnC;AADJ;AAD4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAI5B,+CAAa,KAAKtG,aAAL,CAAmB7L,MAAMe,EAAzB,CAAb;AAAA,gCAAQwB,GAAR;;AACI,iCAAKiQ,yBAAL,CAA+BjQ,GAA/B,EAAkCvC,MAAM2B,MAAxC,EAAgDwQ,aAAhD;AADJ;AAJ4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAM/B,iBAND,MAMO;AACHA,kCAAcxL,GAAd,CAAkB3G,KAAlB;AACH;AACJ,aAVD,MAUO;AACHmS,8BAAcxL,GAAd,CAAkB3G,KAAlB;AACA,oBAAGA,MAAMmC,QAAN,KAAmB9D,YAAYE,SAAlC,EAA4C;AAAA;AAAA;AAAA;;AAAA;AACxC,+CAAayB,MAAMiD,UAAnB;AAAA,gCAAQV,GAAR;;AACI,iCAAK8P,2BAAL,CAAiC9P,GAAjC,EAAmC4P,aAAnC;AADJ;AADwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAGxC,+CAAanS,MAAMiD,UAAnB;AAAA,gCAAQV,GAAR;;AACI,iCAAKiQ,yBAAL,CAA+BjQ,GAA/B,EAAkCvC,KAAlC,EAAyCmS,aAAzC;AADJ;AAHwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAK3C,iBALD,MAKK;AACD,wBAAGnS,MAAMmC,QAAN,KAAmB9D,YAAYG,QAAlC,EAA2C;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,oCAC/BwE,KAD+B;;AAEnC,oCAAG,CAAC,6BAAImP,aAAJ,GAAmBpK,IAAnB,CAAwB;AAAA,2CAAKM,MAAMC,YAAN,CAAmB/F,CAAnB,EAAsBS,KAAtB,CAAL;AAAA,iCAAxB,CAAJ,EAA+D;AAC3D,2CAAKqP,2BAAL,CAAiCrP,KAAjC,EAAuCmP,aAAvC;AACH;AAJkC;;AACvC,mDAAiBnS,MAAMI,MAAvB,wIAA8B;AAAA;AAI7B;AALsC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAM1C;AACJ;AACJ;AACF,SAvhB4D;;AAyhB7DoS,mCAA4B,mCAASxS,KAAT,EAAgBsS,QAAhB,EAA0BH,aAA1B,EAAwC;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAClE,uCAAe9J,MAAME,YAAN,CAAmBvI,KAAnB,EAAyBsS,QAAzB,CAAf,wIAAkD;AAAA,wBAA1CvN,GAA0C;;AAC9CoN,kCAAcxL,GAAd,CAAkB5B,GAAlB;AACA,wBAAGA,IAAI5C,QAAJ,KAAiB9D,YAAYG,QAAhC,EAAyC;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,oCAC7BwE,KAD6B;;AAEjC,oCAAG,CAAC,6BAAImP,aAAJ,GAAmBpK,IAAnB,CAAwB;AAAA,2CAAKM,MAAMC,YAAN,CAAmB/F,CAAnB,EAAsBS,KAAtB,CAAL;AAAA,iCAAxB,CAAJ,EAA+D;AAC3D,2CAAKqP,2BAAL,CAAiCrP,KAAjC,EAAuCmP,aAAvC;AACH;AAJgC;;AACrC,mDAAiBpN,IAAI3E,MAArB,wIAA4B;AAAA;AAI3B;AALoC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMxC;AACJ;AAViE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWnE,SApiB4D;;AAsiB7D;AACAoO,4BAAqB,4BAASR,YAAT,EAAuB7F,0BAAvB,EAAmD;AACpE,gBAAImD,qBAAqB,KAAKjC,IAAL,CAAUiC,kBAAnC;AACA,gBAAI4G,qBAAqB,IAAI,KAAK7I,IAAL,CAAU3C,GAAd,EAAzB;;AAEA,gBAAIuG,IAAI,KAAK8B,eAAL,CAAqB/M,IAArB,CAA0B,IAA1B,EAA+BgM,YAA/B,CAAR;;AAEA,gBAAIyE,eAAe,KAAK7G,cAAL,CAAoBzE,IAApB,GAA2BqF,IAA3B,CAAgCvN,oBAAhC,CAAnB;AANoE;AAAA;AAAA;;AAAA;AAOpE,uCAAiBwT,YAAjB,wIAA8B;AAAA,wBAAtBzS,KAAsB;AAAA;AAAA;AAAA;;AAAA;AAC1B0S,4BAD0B,EACpB,uBAAa,CAAC1S,KAAD,EAAQkC,MAAR,CAAemG,MAAME,YAAN,CAAmBvI,KAAnB,CAAf,CAAb,wIAAuD;AAAA,gCAA/CuC,CAA+C;AAAA;AAAA;AAAA;;AAAA;AACzD,uDAAaA,EAAEhD,WAAf,wIAA2B;AAAA,wCAAnBR,CAAmB;;AACvB,wCAAGuM,mBAAmBvM,CAAnB,EAAsBiP,YAAtB,EAAoCf,CAApC,EAAuC9E,0BAAvC,CAAH,EAAsE;AAClE+J,2DAAmBvL,GAAnB,CAAuB5H,CAAvB;AACA,8CAAM2T,IAAN;AACH;AACJ;AANwD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAO5D;AARyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAS7B;AAhBmE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAkBpE,gBAAIC,6BAA6B,KAAKC,4BAAL,CAAkCV,kBAAlC,CAAjC;;AAEA,iBAAKnG,IAAL,CAAU,4BAAV,EAAwC4G,0BAAxC;;AAEA,mBAAOA,0BAAP;AACH,SA9jB4D;;AAgkB7D;AACAC,sCAA+B,sCAASV,kBAAT,EAA6B;AAC1D,gBAAIW,sBAAsB,IAAI,KAAKxJ,IAAL,CAAU3C,GAAd,EAA1B;AACA;AAF0D;AAAA;AAAA;;AAAA;AAG1D,uCAAewL,mBAAmB/K,IAAnB,EAAf,wIAAyC;AAAA,wBAAhCjI,EAAgC;;AACrC,wBAAI4T,cAAc,KAAlB;AACA,wBAAIC,sBAAsB,IAAIrM,GAAJ,EAA1B;AAFqC;AAAA;AAAA;;AAAA;AAAA;AAAA,gCAG5BvH,EAH4B;;AAIjC,gCAAI6T,YAAY3K,MAAME,YAAN,CAAmBrJ,GAAG6C,MAAtB,EAA8B7C,GAAGsF,KAAjC,CAAhB,CAJiC,CAI2B;AAC5D,gCAAIyO,YAAY5K,MAAME,YAAN,CAAmBpJ,GAAG4C,MAAtB,EAA8B5C,GAAGqF,KAAjC,CAAhB,CALiC,CAK4B;AAC7D,gCAAI0O,kBAAkBF,UAAUjL,IAAV,CAAgB;AAAA,uCAAKkL,UAAUtO,OAAV,CAAkBpC,CAAlB,IAAuB,CAAC,CAA7B;AAAA,6BAAhB,CAAtB,CANiC,CAMwC;AACzE,gCAAG2Q,eAAH,EAAmB;AACf,oCAAG/T,GAAG4C,MAAH,CAAUM,WAAV,CAAsBsC,OAAtB,CAA8BzF,GAAG6C,MAAjC,IAA2C,CAAC,CAA/C,EAAiD;AAAK;AAClDgR,wDAAoBpM,GAApB,CAAwBxH,EAAxB;AACH,iCAFD,MAEK;AACD2T,kDAAc,IAAd;AACA;AACH;AACJ;AAdgC;;AAGrC,+CAAeD,oBAAoB1L,IAApB,EAAf,wIAA0C;AAAA;;AAAA,mDAS9B;AAGX;AAfoC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAgBrC,wBAAG,CAAC2L,WAAJ,EAAgB;AAAA;AAAA;AAAA;;AAAA;AACZ,mDAAcC,mBAAd,wIAAkC;AAAA,oCAA1BI,EAA0B;;AAC9BN,oDAAoBhM,MAApB,CAA2BsM,EAA3B;AACH;AAHW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIZN,4CAAoBlM,GAApB,CAAwBzH,EAAxB;AACH;AACJ;AAzByD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA2B1D,mBAAO2T,mBAAP;AACD,SA7lB4D;;AA+lB7D9G,cAAO,gBAAU;AACf,gBAAG7K,UAAH,EAAc;AACZ,oBAAIyE,OAAO/C,MAAM3E,IAAN,CAAW2H,SAAX,CAAX;AACA,qBAAKyD,IAAL,CAAU8B,OAAV,CAAkBC,GAAlB,CACKzF,KAAK,CAAL,CADL,UAEIA,KAAKQ,KAAL,CAAW,CAAX,EAAc7D,GAAd,CAAkB,UAAS8Q,GAAT,EAAa;AAC7B,2BAAOA,QAAQ,IAAR,GAAe,MAAf,GACHA,QAAQvT,SAAR,GAAoB,WAApB,GACE,OAAOuT,GAAP,KAAe,QAAf,GAA0BA,GAA1B,GACEA,IAAIjS,QAAJ,OAAmB,iBAAnB,GAAuCvD,KAAKyV,OAAL,CAAaD,GAAb,CAAvC,GAA2DA,IAAIjS,QAAJ,EAHnE;AAKD,iBAND,EAMGR,IANH,CAMQ,IANR,CAFJ;AAWD;AACF,SA9mB4D;;AAgnB7D;;;;;;;;;;;;;;;;;;;AAmBA;;AAEA;AACA2S,0BAAmB,0BAAShO,QAAT,EAAkB;AACjC6E,4BAAgBC,MAAhB,CAAuBjM,OAAvB,CAA+B,UAASgG,KAAT,EAAe;AAC5C,oBAAGmB,SAASnB,KAAT,CAAH,EAAoB,KAAKiB,EAAL,CAAQjB,KAAR,EAAcmB,SAASnB,KAAT,CAAd;AACrB,aAFD,EAEG,IAFH;AAGH,SA1oB4D;;AA4oB7D;AACAoP,4BAAqB,4BAASjO,QAAT,EAAkB;AACnC6E,4BAAgBC,MAAhB,CAAuBjM,OAAvB,CAA+B,UAASgG,KAAT,EAAe;AAC5C,oBAAGmB,SAASnB,KAAT,CAAH,EAAoB,KAAK0B,GAAL,CAAS1B,KAAT,EAAemB,SAASnB,KAAT,CAAf;AACrB,aAFD,EAEG,IAFH;AAGH,SAjpB4D;;AAmpB7D;AACAqP,gCAAyB,kCAAU;AAC/B,gBAAI9S,SAAS,EAAb;AACA,qBAAS+S,SAAT,CAAmBzT,KAAnB,EAAyB;;AAErB,oBAAGA,MAAMT,WAAT,EAAqB;AACjB,yBAAK,IAAIkR,QAAQ,CAAZ,EAAeC,QAAQ1Q,MAAMT,WAAN,CAAkBmC,MAA9C,EAAsD+O,QAAQC,KAA9D,EAAqED,OAArE,EAA8E;AAC1E/P,+BAAOV,MAAMT,WAAN,CAAkBkR,KAAlB,EAAyBtM,KAAhC,IAAyC,IAAzC;AACH;AACJ;;AAED,oBAAGnE,MAAMI,MAAT,EAAiB;AACb,yBAAK,IAAIsT,WAAW,CAAf,EAAkBC,WAAW3T,MAAMI,MAAN,CAAasB,MAA/C,EAAuDgS,WAAWC,QAAlE,EAA4ED,UAA5E,EAAwF;AACpFD,kCAAUzT,MAAMI,MAAN,CAAasT,QAAb,CAAV;AACH;AACJ;AACJ;;AAEDD,sBAAU,KAAKvI,MAAf;;AAEA,mBAAOpN,OAAOI,IAAP,CAAYwC,MAAZ,CAAP;AACH,SAxqB4D;;AA2qB7D;AACA;;;;;;;;;;;;;;AAeAkT,qBAAc,uBAAU;AACtB,gBAAG,KAAKC,WAAR,EAAqB,MAAM,IAAItS,KAAJ,CAAU,wEAAV,CAAN;;AAGrB,mBAAO,CACL,KAAKiM,gBAAL,EADK,EAEL,KAAKsG,iBAAL,EAFK,EAGL,KAAKhI,eAHA,EAIL,KAAKZ,MAAL,CAAYhL,mBAAZ,EAJK,CAAP;AAMD,SArsB4D;;AAusB7D4T,2BAAoB,6BAAU;AAC5B,gBAAIrN,IAAI,EAAR;AACA3I,mBAAOI,IAAP,CAAY,KAAK2N,aAAjB,EAAgC1N,OAAhC,CAAwC,UAAS4L,GAAT,EAAa;AACnDtD,kBAAEsD,GAAF,IAAS,KAAK8B,aAAL,CAAmB9B,GAAnB,EAAwBzH,GAAxB,CAA4B,UAAStC,KAAT,EAAe;AAAC,2BAAOA,MAAMe,EAAb;AAAgB,iBAA5D,CAAT;AACD,aAFD,EAEE,IAFF;AAGA,mBAAO0F,CAAP;AACD;AA7sB4D,KAArC,CAA5B;;AAgtBA;;;;AAIA,aAASsN,UAAT,CAAoBjJ,KAApB,EAA2BzB,IAA3B,EAAiC;AAC7BA,eAAOA,QAAQ,EAAf;;AAEAA,aAAKmB,2BAAL,GAAmCnB,KAAKmB,2BAAL,IAAoCA,2BAAvE;;AAEA,aAAKqJ,WAAL,GAAmB,KAAnB;;AAEA1J,wBAAgB/D,IAAhB,CAAqB,IAArB,EAA0B0E,KAA1B,EAAgCzB,IAAhC,EAP6B,CAOc;AAC9C;;AAED,aAAS4C,KAAT,CAAexF,CAAf,EAAiB;AACb,iBAASuN,CAAT,GAAY,CAAE;AACdA,UAAE7O,SAAF,GAAcsB,CAAd;AACA,eAAO,IAAIuN,CAAJ,EAAP;AACH;;AAED;;;AAGA,aAASpG,GAAT,GAAe,CAAE;;AAEjB;AACA;AACAmG,eAAW5O,SAAX,GAAuB8G,MAAM9B,gBAAgBhF,SAAtB,CAAvB;;AAEA;AACA4O,eAAW5O,SAAX,CAAqB8O,GAArB,GAA2B,UAASC,YAAT,EAAsBC,YAAtB,EAAoC;;AAE3D,YAAInG,YAAJ;AACA,uBAAckG,YAAd,yCAAcA,YAAd;AACI,iBAAK,QAAL;AACIlG,+BAAe,EAACnN,MAAOqT,YAAR,EAAsBpF,MAAOqF,YAA7B,EAAf;AACA;AACJ,iBAAK,QAAL;AACI,oBAAG,OAAOD,aAAarT,IAApB,KAA6B,QAAhC,EAAyC;AACrCmN,mCAAekG,YAAf;AACH,iBAFD,MAEK;AACD,0BAAM,IAAI3S,KAAJ,CAAU,wDAAV,CAAN;AACH;AACD;AACJ;AACI,sBAAM,IAAIA,KAAJ,CAAU,mDAAV,CAAN;AAZR;;AAeA,YAAG,KAAKsS,WAAR,EAAqB,MAAM,IAAItS,KAAJ,CAAU,mCAAV,CAAN;;AAErB;AACA,aAAKsS,WAAL,GAAmB,IAAnB;;AAEA,aAAKtG,eAAL,CAAqBS,YAArB;;AAEA,aAAK6F,WAAL,GAAmB,KAAnB;AACA,eAAO,KAAKrG,gBAAL,EAAP;AACH,KA3BD;;AA6BA;;;;;;;;AAQAuG,eAAW5O,SAAX,CAAqBwI,QAArB,GAAgC,UAASK,YAAT,EAAuBN,EAAvB,EAA2B;AACvD,YAAIM,iBAAiB,IAAjB,KAA0B,QAAOA,YAAP,yCAAOA,YAAP,OAAwB,QAAxB,IAAoC,CAACA,YAArC,IAAqD,OAAOA,aAAanN,IAApB,KAA6B,QAA5G,CAAJ,EAA2H;AACvH,kBAAM,IAAIU,KAAJ,CAAU,2DAAV,CAAN;AACH;;AAED,YAAI,OAAOmM,EAAP,KAAc,UAAlB,EAA8B;AAC1BA,iBAAKE,GAAL;AACH;;AAED,aAAKpC,mBAAL,CAAyBpK,IAAzB,CAA8B,CAAC4M,YAAD,EAAeN,EAAf,CAA9B;;AAEA;AACA,iBAASkC,QAAT,CAAkB3C,CAAlB,EAAqBmH,CAArB,EAAuB;AACrB,iBAAKzE,oBAAL,CAA0B1C,CAA1B,EAA6B,UAASoH,GAAT,EAAcC,MAAd,EAAsB;AAC/CF,kBAAEC,GAAF,EAAOC,MAAP;;AAEA,oBAAG,KAAK9I,mBAAL,CAAyB9J,MAA5B,EAAmC;AACjCkO,6BAASvO,KAAT,CAAe,IAAf,EAAoB,KAAKmK,mBAAL,CAAyBiD,KAAzB,EAApB;AACD,iBAFD,MAEK;AACH,yBAAKoF,WAAL,GAAmB,KAAnB;AACD;AACJ,aAR4B,CAQ3B7R,IAR2B,CAQtB,IARsB,CAA7B;AASD;AACD,YAAG,CAAC,KAAK6R,WAAT,EAAqB;AACnB,iBAAKA,WAAL,GAAmB,IAAnB;AACAjE,qBAASvO,KAAT,CAAe,IAAf,EAAoB,KAAKmK,mBAAL,CAAyBiD,KAAzB,EAApB;AACD;AACJ,KA3BD;;AA6BA,aAASjE,2BAAT,CAAqClB,WAArC,EAAkD;AAC9C,aAAKiL,YAAL,GAAoBjL,WAApB;AACA,aAAKmG,WAAL,GAAmB,EAAnB;AACA,aAAK+E,UAAL,GAAkB,EAAlB;AACA,aAAKrF,SAAL,GAAiB,IAAIzI,GAAJ,EAAjB;AACH;;AAED;AACA;AACA;AACA,QAAI+N,mBAAmB,oNAAvB;;AAEA;AACAjK,gCAA4BrF,SAA5B,GAAwC;AACpCuP,+BAAyB,UADW;AAEpCC,8BAAwB,gBAFY;AAGpCC,eAAQ,eAASzQ,KAAT,EAAe;AACnB,iBAAK0Q,2BAAL,CAAiC1Q,KAAjC,EAAwC,IAAxC;AACA,iBAAKoQ,YAAL,CAAkB9I,mBAAlB,CAAsCrK,IAAtC,CAA2C+C,KAA3C;AACH,SANmC;AAOpC2Q,6BAAsB,6BAASC,SAAT,EAAmB;AACvC,mBAAO,CAAC,KAAKR,YAAL,CAAkBlL,IAAlB,CAAuB2L,SAAvB,IAAoCxK,4BAA4BwK,SAAjE,EAA4EhK,KAA5E,CAAkF+J,SAAlF,CAAP;AACD,SATmC;AAUpCtR,gBAAS,gBAASwR,SAAT,EAAmB;AAAA;;AAC1B;AACA,iBAAKT,UAAL,CAAgBS,UAAUlU,EAA1B,IAAgC,IAAImU,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC/D,iBAAC,OAAKb,YAAL,CAAkBlL,IAAlB,CAAuBgM,QAAvB,IAAmC7K,4BAA4B6K,QAAhE,EAA0EJ,UAAUrV,IAApF,EAA0F,OAAK2U,YAA/F,EAA6GU,SAA7G,EAAwH,UAACZ,GAAD,EAAMiB,OAAN,EAAkB;AACxI,wBAAGjB,GAAH,EAAQ,OAAOe,OAAOf,GAAP,CAAP;;AAERc,4BAAQG,OAAR;AACD,iBAJD;AAKD,aAN+B,CAAhC;AAOD,SAnBmC;AAoBpCnI,sBAAe,sBAASf,QAAT,EAAkB;AAAA;;AAC/B;AACA,gBAAImJ,iBAAiB,KAAKf,UAAL,CAAgBpI,QAAhB,CAArB;AACA,iBAAKmI,YAAL,CAAkBxI,IAAlB,uCAA2DK,QAA3D;AACA,gBAAGmJ,cAAH,EAAkB;AAChB,qBAAKhB,YAAL,CAAkBxI,IAAlB;AACAwJ,+BAAeC,IAAf,CACG,UAACF,OAAD,EAAa;AACZ,4BAAKf,YAAL,CAAkBxI,IAAlB,uBAA2CK,QAA3C;AACAkJ,4BAAQpJ,MAAR;AACA;AACA,2BAAO,QAAKsI,UAAL,CAAgBpI,QAAhB,CAAP;AACD,iBANH,EAOI,UAACiI,GAAD,EAAS;AACT;AACD,iBATH;AAUD;AACF,SArCmC;AAsCpCQ,qCAA8B,qCAAS1Q,KAAT,EAAesR,UAAf,EAA0B;AACtD,gBAAG,CAACA,UAAJ,EAAe;AACbtR,sBAAMuR,MAAN,GAAe,KAAKnB,YAAL,CAAkBlL,IAAlB,CAAuBE,EAAvB,CAA0BE,aAA1B,CAAwCoB,KAAxC,CAA8CD,QAA7D,CADa,CAC8D;AAC3EzG,sBAAMwR,UAAN,GAAmBxR,MAAMvE,IAAN,IAAchB,sBAAjC;AACD;AACD,gBAAG,OAAOuF,MAAMvE,IAAb,KAAsB,WAAzB,EAAqC;AACnCuE,sBAAMvE,IAAN,GAAa6V,aAAa,UAAb,GAA0B,UAAvC;AACD;AACD,aACE,MADF,EAEE,QAFF,EAGE,UAHF,EAIE,MAJF,EAKE,QALF,EAME,YANF,EAOEtX,OAPF,CAOU,gBAAQ;AAChB,oBAAG,CAACgG,MAAMd,IAAN,CAAJ,EAAgB;AACdc,0BAAMd,IAAN,IAAcxD,SAAd;AACD;AACF,aAXD;AAYD,SA1DmC;AA2DpCuN,cAAO,cAASjJ,KAAT,EAAgByR,OAAhB,EAAwB;AAC3B,iBAAKrB,YAAL,CAAkBxI,IAAlB,CAAuB,YAAvB,EAAqC5H,KAArC,EAA4CyR,OAA5C;AACAA,sBAAUA,WAAW,EAArB;AACA,gBAAIC,WAAWD,QAAQhW,IAAR,IAAgBhB,sBAA/B;AACA;AACA,qBAASkX,YAAT,CAAsB3R,KAAtB,EAA6ByR,OAA7B,EAAsCG,UAAtC,EAAiD;AAC/C,oBAAG5R,MAAM7D,MAAT,EAAgB;AACd,wBAAI0V,mBAAmBvB,iBAAiBwB,IAAjB,CAAsB9R,MAAM7D,MAA5B,CAAvB;AACA,wBAAG,CAAC0V,gBAAJ,EAAqB;AACnB,8BAAM,EAAEnV,MAAO,iBAAT,EAA4BiO,MAAM,yBAAlC,EAA6DoH,QAAQ/R,MAAM+R,MAA3E,EAAmFtW,MAAO,UAA1F,EAAN;AACD;AACF;AACD,oBAAIiW,aAAajX,sBAAjB,EAAyC;AAAG;AACxC,0BAAM,EAAEiC,MAAO,iBAAT,EAA4BiO,MAAM,kCAAlC,EAAsEoH,QAAQ/R,MAAM+R,MAApF,EAA4FtW,MAAO,UAAnG,EAAN;AACH;;AAEDmW,2BAAW3P,IAAX,CAAgB,IAAhB,EAAsBjC,KAAtB,EAA6ByR,OAA7B;AACD;;AAED,qBAASO,iBAAT,CAA4BhS,KAA5B,EAAmCyR,OAAnC,EAA4C;AAAA;;AAE1C,oBAAI,OAAOQ,UAAP,KAAsB,WAA1B,EAAwC,MAAM,IAAI7U,KAAJ,CAAU,0GAAV,CAAN;;AAExC,oBAAI8U,KAAJ;AACA,oBAAGlS,MAAM7D,MAAN,KAAiB,YAApB,EAAiC;AAC/B,yBAAKsU,KAAL,CAAWzQ,KAAX;AACD,iBAFD,MAEK;AACH,yBAAK0Q,2BAAL,CAAiC1Q,KAAjC,EAAwC,KAAxC;AACAA,0BAAMwR,UAAN,GAAmB/W,sBAAnB,CAFG,CAE6C;AACA;AAChD,wBAAG,CAACuF,MAAM7D,MAAV,EAAiB;AACfgW,+BAAOlQ,IAAP,CAAY,IAAZ,EAAkB,KAAKmO,YAAvB;AACD,qBAFD,MAEM,IAAGpQ,MAAM7D,MAAN,KAAiB,UAApB,EAA+B;AACnC,4BAAG,KAAKiU,YAAL,CAAkBlL,IAAlB,CAAuB8C,aAA1B,EAAwC;AACtChI,kCAAMiI,QAAN,GAAiB,KAAKmI,YAAL,CAAkBlL,IAAlB,CAAuB+C,QAAxC;AACAkK,mCAAOlQ,IAAP,CAAY,IAAZ,EAAkB,KAAKmO,YAAL,CAAkBlL,IAAlB,CAAuB8C,aAAzC;AACD,yBAHD,MAGK;AACH,kCAAM,EAAEtL,MAAO,qBAAT,EAAgCiO,MAAM,8BAAtC,EAAsEoH,QAAQ/R,MAAM+R,MAApF,EAA4FtW,MAAO,UAAnG,EAAN;AACD;AACF,qBAPK,MAOC,IAAGyW,QAAQlS,MAAM7D,MAAN,CAAa+V,KAAb,CAAmB,KAAK1B,oBAAxB,CAAX,EAAyD;AAC9D,4BAAI4B,kBAAkBF,MAAM,CAAN,CAAtB;AACA,4BAAIf,UAAU,KAAKf,YAAL,CAAkBlL,IAAlB,CAAuBsB,eAAvB,CAAuC7G,GAAvC,CAA2CyS,eAA3C,CAAd;AACA,4BAAGjB,OAAH,EAAW;AACTgB,mCAAOlQ,IAAP,CAAY,IAAZ,EAAiBkP,OAAjB;AACD,yBAFD,MAEM;AACJ,kCAAM,EAACzU,MAAO,qBAAR,EAA+BqV,QAAQ/R,MAAM+R,MAA7C,EAAqDtW,MAAO,UAA5D,EAAN;AACD;AACF,qBARM,MAQD,IAAGyW,QAAQlS,MAAM7D,MAAN,CAAa+V,KAAb,CAAmB,KAAK3B,qBAAxB,CAAX,EAA0D;AAC9D;AACA,4BAAI8B,WAAWH,MAAM,CAAN,CAAf;AACA,6BAAK7B,UAAL,CAAgBgC,QAAhB,EAA0BhB,IAA1B,CAAgC,UAACF,OAAD,EAAa;AAC3CgB,mCAAOlQ,IAAP,UAAiBkP,OAAjB;AACD,yBAFD;AAGD,qBANK,MAMC;AACL,8BAAM,IAAI/T,KAAJ,CAAU,2BAAV,CAAN,CADK,CACyC;AAC/C;AACF;;AAED,yBAAS+U,MAAT,CAAgBhB,OAAhB,EAAwB;AACtB;AACA;AACA;AACA,wBAAI9F,gBAAgB4G,WAAW,YAAU;AACvC,4BAAIjS,MAAM+R,MAAV,EAAkB,OAAO,KAAKzG,WAAL,CAAiBtL,MAAM+R,MAAvB,CAAP;AAClB,6BAAK/G,SAAL,CAAerI,MAAf,CAAsBsI,cAAtB;AACAkG,gCAAQ,KAAKf,YAAL,CAAkBlL,IAAlB,CAAuBoN,SAAvB,GAAmC,UAAnC,GAAgD,KAAxD,EAA+DtS,KAA/D;AACD,qBAJ8B,CAI7BnC,IAJ6B,CAIxB,IAJwB,CAAX,EAIN4T,QAAQtG,KAAR,IAAiB,CAJX,CAApB;;AAMA,wBAAIF,iBAAiB;AACnBC,qCAAcuG,OADK;AAEnBpG,uCAAgBA;AAFG,qBAArB;AAIA,wBAAIrL,MAAM+R,MAAV,EAAkB,KAAKzG,WAAL,CAAiBtL,MAAM+R,MAAvB,IAAiC1G,aAAjC;AAClB,yBAAKL,SAAL,CAAexI,GAAf,CAAmByI,cAAnB;AACD;AACF;;AAED,qBAASsH,OAAT,GAAkB;AAChB,qBAAKnC,YAAL,CAAkBtO,IAAlB,CAAuB9B,MAAMtD,IAA7B,EAAkCsD,MAAM2K,IAAxC;AACD;;AAED;AACA;AACA,gBAAI6H,MAAJ;AACA,gBAAGxS,MAAMvE,IAAN,KAAe,0CAAlB,EAA6D;AAC3D+W,yBAASD,OAAT;AACD,aAFD,MAEM,IAAG,KAAKnC,YAAL,CAAkBlL,IAAlB,CAAuBuN,UAA1B,EAAqC;AACzCD,yBAAS,KAAKpC,YAAL,CAAkBlL,IAAlB,CAAuBuN,UAAhC;AACD,aAFK,MAED;AACHD,yBAASR,iBAAT;AACD;;AAEDP,sBAAQA,WAAW,EAAnB;;AAEA,iBAAKrB,YAAL,CAAkBxI,IAAlB,CAAuB,eAAvB,EAAwC5H,MAAMtD,IAA9C,EAAoD,cAApD,EAAoEsD,MAAM2K,IAA1E,EAAgF,aAAhF,EAA+F8G,QAAQtG,KAAvG;;AAEAwG,yBAAa1P,IAAb,CAAkB,IAAlB,EAAwBjC,KAAxB,EAA+ByR,OAA/B,EAAwCe,MAAxC;AACH,SA5JmC;AA6JpCzK,gBAAS,gBAASgK,MAAT,EAAgB;AACrB,gBAAG,KAAK3B,YAAL,CAAkBlL,IAAlB,CAAuBwN,YAA1B,EAAwC;AACpC,uBAAO,KAAKtC,YAAL,CAAkBlL,IAAlB,CAAuBwN,YAAvB,CAAoCxV,KAApC,CAA0C,IAA1C,EAAgD,CAAC6U,MAAD,CAAhD,CAAP;AACH;;AAED,gBAAI,OAAO3G,YAAP,KAAwB,WAA5B,EAA0C,MAAM,IAAIhO,KAAJ,CAAU,4GAAV,CAAN;;AAE1C,gBAAI2U,UAAU,KAAKzG,WAAnB,EAAgC;AAC5B,qBAAK8E,YAAL,CAAkBxI,IAAlB,CAAuB,aAAvB,EAAsCmK,MAAtC,EAA8C,mBAA9C,EAAmE,KAAKzG,WAAL,CAAiByG,MAAjB,CAAnE;AACA3G,6BAAa,KAAKE,WAAL,CAAiByG,MAAjB,CAAb;AACH;AACJ;AAxKmC,KAAxC;;AA2KAY,WAAOC,OAAP,GAAiB;AACb;AACA5M,yBAAiBA,eAFJ;AAGb;AACA4J,oBAAYA,UAJC;AAKb;AACAxN,kBAAWA,QANE;AAOb;AACAlI,qBAAcA,WARD;AASb;AACAgB,yBAAkBA,eAVL;AAWb;AACAmL,qCAA8BA;AAZjB,KAAjB","file":"scion.js","sourcesContent":["//   Copyright 2012-2012 Jacob Beard, INFICON, and other SCION contributors\n//\n//   Licensed under the Apache License, Version 2.0 (the \"License\");\n//   you may not use this file except in compliance with the License.\n//   You may obtain a copy of the License at\n//\n//       http://www.apache.org/licenses/LICENSE-2.0\n//\n//   Unless required by applicable law or agreed to in writing, software\n//   distributed under the License is distributed on an \"AS IS\" BASIS,\n//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//   See the License for the specific language governing permissions and\n//   limitations under the License.\n\n\"use strict\";\n\nvar util = require('util');\n\nvar extend = Object.assign || \n    function (to, from){\n      Object.keys(from).forEach(function(k){\n        to[k] = from[k]; \n      });\n      return to;\n    };\n\nvar STATE_TYPES = {\n    BASIC: 0,\n    COMPOSITE: 1,\n    PARALLEL: 2,\n    HISTORY: 3,\n    INITIAL: 4,\n    FINAL: 5\n};\n\nconst SCXML_IOPROCESSOR_TYPE = 'http://www.w3.org/TR/scxml/#SCXMLEventProcessor'\nconst HTTP_IOPROCESSOR_TYPE = 'http://www.w3.org/TR/scxml/#BasicHTTPEventProcessor'\n\nfunction transitionWithTargets(t){\n    return t.targets;\n}\n\nfunction transitionComparator(t1, t2) {\n    return t1.documentOrder - t2.documentOrder;\n}\n\nfunction initializeModel(rootState){\n    var transitions = [], idToStateMap = new Map(), documentOrder = 0;\n\n\n    //TODO: need to add fake ids to anyone that doesn't have them\n    //FIXME: make this safer - break into multiple passes\n    var idCount = {};\n\n    function generateId(type){\n        if(idCount[type] === undefined) idCount[type] = 0;\n\n        var count = idCount[type]++;\n        return '$generated-' + type + '-' + count; \n    }\n\n    function wrapInFakeRootState(state){\n        return {\n            $deserializeDatamodel : state.$deserializeDatamodel || function(){},\n            $serializeDatamodel : state.$serializeDatamodel || function(){ return null;},\n            $idToStateMap : idToStateMap,   //keep this for handy deserialization of serialized configuration\n            states : [\n                {\n                    $type : 'initial',\n                    transitions : [{\n                        target : state\n                    }]\n                },\n                state\n            ]\n        };\n    }\n\n    var statesWithInitialAttributes = [];\n\n    function transitionToString(sourceState){\n      return `${sourceState} -- ${this.events ? '(' + this.events.join(',') + ')' : null}${this.cond ? '[' + this.cond.name + ']' : ''} --> ${this.targets ? this.targets.join(',') : null}`;\n    }\n\n    function stateToString(){\n      return this.id;\n    }\n\n    function traverse(ancestors,state){\n\n        if(printTrace) state.toString = stateToString;\n\n        //add to global transition and state id caches\n        if(state.transitions) transitions.push.apply(transitions,state.transitions);\n\n        //populate state id map\n        if(state.id){\n            if(idToStateMap.has(state.id)) throw new Error('Redefinition of state id ' + state.id);\n\n            idToStateMap.set(state.id, state);\n        }\n\n        //create a default type, just to normalize things\n        //this way we can check for unsupported types below\n        state.$type = state.$type || 'state';\n\n        //add ancestors and depth properties\n        state.ancestors = ancestors;\n        state.depth = ancestors.length;\n        state.parent = ancestors[0];\n        state.documentOrder = documentOrder++; \n\n        //add some information to transitions\n        state.transitions = state.transitions || [];\n        for (var j = 0, len = state.transitions.length; j < len; j++) {\n            var transition = state.transitions[j];\n            transition.documentOrder = documentOrder++; \n            transition.source = state;\n            if(printTrace) transition.toString = transitionToString.bind(transition, state);\n        };\n\n        //recursive step\n        if(state.states) {\n            var ancs = [state].concat(ancestors);\n            for (var j = 0, len = state.states.length; j < len; j++) {\n                traverse(ancs, state.states[j]);\n            }\n        }\n\n        //setup fast state type\n        switch(state.$type){\n            case 'parallel':\n                state.typeEnum = STATE_TYPES.PARALLEL;\n                state.isAtomic = false;\n                break;\n            case 'initial' : \n                state.typeEnum = STATE_TYPES.INITIAL;\n                state.isAtomic = true;\n                break;\n            case 'history' :\n                state.typeEnum = STATE_TYPES.HISTORY;\n                state.isAtomic = true;\n                break;\n            case 'final' : \n                state.typeEnum = STATE_TYPES.FINAL;\n                state.isAtomic = true;\n                break;\n            case 'state' : \n            case 'scxml' :\n                if(state.states && state.states.length){\n                    state.typeEnum = STATE_TYPES.COMPOSITE;\n                    state.isAtomic = false;\n                }else{\n                    state.typeEnum = STATE_TYPES.BASIC;\n                    state.isAtomic = true;\n                }\n                break;\n            default :\n                throw new Error('Unknown state type: ' + state.$type);\n        }\n\n        //descendants property on states will now be populated. add descendants to this state\n        if(state.states){\n            state.descendants = state.states.concat(state.states.map(function(s){return s.descendants;}).reduce(function(a,b){return a.concat(b);},[]));\n        }else{\n            state.descendants = [];\n        }\n\n        var initialChildren;\n        if(state.typeEnum === STATE_TYPES.COMPOSITE){\n            //set up initial state\n            \n            if(Array.isArray(state.initial) || typeof state.initial === 'string'){\n                statesWithInitialAttributes.push(state);\n            }else{\n                //take the first child that has initial type, or first child\n                initialChildren = state.states.filter(function(child){\n                    return child.$type === 'initial';\n                });\n\n                state.initialRef = [initialChildren.length ? initialChildren[0] : state.states[0]];\n                checkInitialRef(state);\n            }\n\n        }\n\n        //hook up history\n        if(state.typeEnum === STATE_TYPES.COMPOSITE ||\n                state.typeEnum === STATE_TYPES.PARALLEL){\n\n            var historyChildren = state.states.filter(function(s){\n                return s.$type === 'history';\n            }); \n\n           state.historyRef = historyChildren;\n        }\n\n        //now it's safe to fill in fake state ids\n        if(!state.id){\n            state.id = generateId(state.$type);\n            idToStateMap.set(state.id, state);\n        }\n\n        //normalize onEntry/onExit, which can be single fn or array, or array of arrays (blocks)\n        ['onEntry','onExit'].forEach(function(prop){\n          if (state[prop]) {\n            if(!Array.isArray(state[prop])){\n              state[prop] = [state[prop]];\n            }\n            if(!state[prop].every(function(handler){ return Array.isArray(handler); })){\n              state[prop] = [state[prop]];\n            }\n          }\n        });\n\n        if (state.invokes && !Array.isArray(state.invokes)) {\n            state.invokes = [state.invokes];\n            state.invokes.forEach( invoke => {\n              if (invoke.finalize && !Array.isArray(invoke.finalize)) {\n                invoke.finalize = [invoke.finalize];\n              }\n            })\n        }\n    }\n\n    //TODO: convert events to regular expressions in advance\n\n    function checkInitialRef(state){\n      if(!state.initialRef) throw new Error('Unable to locate initial state for composite state: ' + state.id);\n    }\n    function connectIntialAttributes(){\n      for (var j = 0, len = statesWithInitialAttributes.length; j < len; j++) {\n        var s = statesWithInitialAttributes[j];\n\n        var initialStates = Array.isArray(s.initial) ? s.initial : [s.initial];\n        s.initialRef = initialStates.map(function(initialState){ return idToStateMap.get(initialState); });\n        checkInitialRef(s);\n      }\n    }\n\n    var RX_WHITESPACE = /\\s+/;\n\n    function connectTransitionGraph(){\n        //normalize as with onEntry/onExit\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if (t.onTransition && !Array.isArray(t.onTransition)) {\n                t.onTransition = [t.onTransition];\n            }\n\n            //normalize \"event\" attribute into \"events\" attribute\n            if (typeof t.event === 'string') {\n                t.events = t.event.trim().split(RX_WHITESPACE);\n            }\n            delete t.event;\n\n            if(t.targets || (typeof t.target === 'undefined')) {\n                //targets have already been set up\n                continue;\n            }   \n\n            if(typeof t.target === 'string'){\n                var target = idToStateMap.get(t.target);\n                if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                t.target = target;\n                t.targets = [t.target];\n            }else if(Array.isArray(t.target)){\n                t.targets = t.target.map(function(target){\n                    if(typeof target === 'string'){\n                        target = idToStateMap.get(target);\n                        if(!target) throw new Error('Unable to find target state with id ' + t.target);\n                        return target;\n                    }else{\n                        return target;\n                    } \n                }); \n            }else if(typeof t.target === 'object'){\n                t.targets = [t.target];\n            }else{\n                throw new Error('Transition target has unknown type: ' + t.target);\n            }\n        }\n\n        //hook up LCA - optimization\n        for (var i = 0, len = transitions.length; i < len; i++) {\n            var t = transitions[i];\n            if(t.targets) t.lcca = getLCCA(t.source,t.targets[0]);    //FIXME: we technically do not need to hang onto the lcca. only the scope is used by the algorithm\n\n            t.scope = getScope(t);\n        }\n    }\n\n    function getScope(transition){\n        //Transition scope is normally the least common compound ancestor (lcca).\n        //Internal transitions have a scope equal to the source state.\n        var transitionIsReallyInternal = \n                transition.type === 'internal' &&\n                  transition.source.typeEnum === STATE_TYPES.COMPOSITE &&   //is transition source a composite state\n                  transition.source.parent &&    //root state won't have parent\n                  transition.targets && //does it target its descendants\n                  transition.targets.every(\n                      function(target){ return transition.source.descendants.indexOf(target) > -1;});\n\n        if(!transition.targets){\n            return null;\n        }else if(transitionIsReallyInternal){\n            return transition.source; \n        }else{\n            return transition.lcca;\n        }\n    }\n\n    function getLCCA(s1, s2) {\n        var commonAncestors = [];\n        for (var j = 0, len = s1.ancestors.length; j < len; j++) {\n            var anc = s1.ancestors[j];\n            if(anc.typeEnum === STATE_TYPES.COMPOSITE &&\n                anc.descendants.indexOf(s2) > -1){\n                commonAncestors.push(anc);\n            }\n        };\n        if(!commonAncestors.length) throw new Error(\"Could not find LCA for states.\");\n        return commonAncestors[0];\n    }\n\n    //main execution starts here\n    //FIXME: only wrap in root state if it's not a compound state\n    var fakeRootState = wrapInFakeRootState(rootState);  //I wish we had pointer semantics and could make this a C-style \"out argument\". Instead we return him\n    traverse([],fakeRootState);\n    connectTransitionGraph();\n    connectIntialAttributes();\n\n    return fakeRootState;\n}\n\n/* begin tiny-events: https://github.com/ZauberNerd/tiny-events */\nfunction EventEmitter() {\n    this._listeners = {};\n    this._listeners['*'] = [];\n}\n\nEventEmitter.prototype.on = function _on(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        this._listeners[type] = [];\n    }\n\n    if (this._listeners[type].indexOf(listener) === -1) {\n        this._listeners[type].push(listener);\n    }\n\n    return this;\n};\n\nEventEmitter.prototype.once = function _once(type, listener) {\n    var self = this;\n\n    function __once() {\n        for (var args = [], i = 0; i < arguments.length; i += 1) {\n            args[i] = arguments[i];\n        }\n\n        self.off(type, __once);\n        listener.apply(self, args);\n    }\n\n    __once.listener = listener;\n\n    return this.on(type, __once);\n};\n\nEventEmitter.prototype.off = function _off(type, listener) {\n    if (!Array.isArray(this._listeners[type])) {\n        return this;\n    }\n\n    if (typeof listener === 'undefined') {\n        this._listeners[type] = [];\n        return this;\n    }\n\n    var index = this._listeners[type].indexOf(listener);\n\n    if (index === -1) {\n        for (var i = 0; i < this._listeners[type].length; i += 1) {\n            if (this._listeners[type][i].listener === listener) {\n                index = i;\n                break;\n            }\n        }\n    }\n\n    this._listeners[type].splice(index, 1);\n    return this;\n};\n\nEventEmitter.prototype.emit = function _emit(type) {\n\n    var args = Array.prototype.slice.call(arguments);\n    var modifiedArgs = args.slice(1);\n\n    var listeners = this._listeners[type];\n    var j, len;\n    if (Array.isArray(listeners)) {\n      for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, modifiedArgs);\n      }\n    }\n\n    //special '*' event\n    listeners = this._listeners['*'];\n    for (j = 0, len = listeners.length; j < len; j++) {\n        listeners[j].apply(this, args);\n    }\n\n    return this;\n};\n\n/* end tiny-events */\n\n/* begin ArraySet */\n\n/** @constructor */\nfunction ArraySet(l) {\n    l = l || [];\n    this.o = new Set(l);        \n}\n\nArraySet.prototype = {\n\n    add : function(x) {\n        this.o.add(x);\n    },\n\n    remove : function(x) {\n        return this.o.delete(x);\n    },\n\n    union : function(l) {\n        for (var v of l.o) {\n            this.o.add(v);\n        }\n        return this;\n    },\n\n    difference : function(l) {\n        for (var v of l.o) {\n            this.o.delete(v);\n        }\n        return this;\n    },\n\n    contains : function(x) {\n        return this.o.has(x);\n    },\n\n    iter : function() {\n        return Array.from(this.o);\n    },\n\n    isEmpty : function() {\n        return !this.o.size;\n    },\n\n    size: function() {\n        return this.o.size;\n    },\n\n    equals : function(s2) {\n        if (this.o.size !== s2.size()) {\n            return false;\n        }\n\n        for (var v of this.o) {\n            if (!s2.contains(v)) {\n                return false;\n            }\n        }\n\n        return true;\n    },\n\n    toString : function() {\n        return this.o.size === 0 ? '<empty>' : Array.from(this.o).join(',\\n');\n    }\n};\n\nconst RX_TRAILING_WILDCARD = /\\.\\*$/;\n\nfunction isEventPrefixMatch(prefix, fullName) {\n    prefix = prefix.replace(RX_TRAILING_WILDCARD, '');\n\n    if (prefix === fullName) {\n        return true;\n    }\n\n    if (prefix.length > fullName.length) {\n        return false;\n    }\n\n    if (fullName.charAt(prefix.length) !== '.') {\n        return false;\n    }\n\n    return (fullName.indexOf(prefix) === 0);\n}\n\nfunction isTransitionMatch(t, eventName) {\n    return t.events.some((tEvent) => {\n        return tEvent === '*' || isEventPrefixMatch(tEvent, eventName);\n    });\n}\n\nfunction scxmlPrefixTransitionSelector(t, event, evaluator, selectEventlessTransitions) {\n    return ( \n      selectEventlessTransitions ? \n        !t.events :\n        (t.events && event && event.name && isTransitionMatch(t, event.name))\n      )\n      && (!t.cond || evaluator(t.cond));\n}\n\nfunction eventlessTransitionSelector(state){\n  return state.transitions.filter(function(transition){ return !transition.events || ( transition.events && transition.events.length === 0 ); });\n}\n\n//model accessor functions\nvar query = {\n    isDescendant : function(s1, s2){\n      //Returns 'true' if state1 is a descendant of state2 (a child, or a child of a child, or a child of a child of a child, etc.) Otherwise returns 'false'.\n      return s2.descendants.indexOf(s1) > -1;\n    },\n    getAncestors: function(s, root) {\n        var ancestors, index, state;\n        if(root === null) return [];\n        index = s.ancestors.indexOf(root);\n        if (index > -1) {\n            return s.ancestors.slice(0, index);\n        } else {\n            return s.ancestors;\n        }\n    },\n    /** @this {model} */\n    getAncestorsOrSelf: function(s, root) {\n        return [s].concat(this.getAncestors(s, root));\n    },\n    getDescendantsOrSelf: function(s) {\n        return [s].concat(s.descendants);\n    },\n    /** @this {model} */\n    isOrthogonalTo: function(s1, s2) {\n        //Two control states are orthogonal if they are not ancestrally\n        //related, and their smallest, mutual parent is a Concurrent-state.\n        if(s1 === null || s2 === null) return true;\n        return !this.isAncestrallyRelatedTo(s1, s2) && this.getLCA(s1, s2).typeEnum === STATE_TYPES.PARALLEL;\n    },\n    /** @this {model} */\n    isAncestrallyRelatedTo: function(s1, s2) {\n        //Two control states are ancestrally related if one is child/grandchild of another.\n        return this.getAncestorsOrSelf(s2).indexOf(s1) > -1 || this.getAncestorsOrSelf(s1).indexOf(s2) > -1;\n    },\n    /** @this {model} */\n    getLCA: function(s1, s2) {\n        var commonAncestors = this.getAncestors(s1).filter(function(a){\n            return a.descendants.indexOf(s2) > -1;\n        },this);\n        return commonAncestors[0];\n    }\n};\n\n//priority comparison functions\nfunction getTransitionWithHigherSourceChildPriority(_args) {\n    let t1 = _args[0], t2 = _args[1];\n    var r = getStateWithHigherSourceChildPriority(t1.source, t2.source);\n    //compare transitions based first on depth, then based on document order\n    if (t1.source.depth < t2.source.depth) {\n        return t2;\n    } else if (t2.source.depth < t1.source.depth) {\n        return t1;\n    } else {\n       if (t1.documentOrder < t2.documentOrder) {\n            return t1;\n        } else {\n            return t2;\n        }\n    }\n}\n\nfunction sortInEntryOrder(s1, s2){\n  return getStateWithHigherSourceChildPriority(s1, s2) * -1\n}\n\nfunction getStateWithHigherSourceChildPriority(s1, s2) {\n    //compare states based first on depth, then based on document order\n    if (s1.depth > s2.depth) {\n        return -1;\n    } else if (s1.depth < s2.depth) {\n        return 1;\n    } else {\n        //Equality\n        if (s1.documentOrder < s2.documentOrder) {\n            return 1;\n        } else if (s1.documentOrder > s2.documentOrder) {\n            return -1;\n        } else{\n            return 0;\n        }\n    }\n}\n\nfunction initializeModelGeneratorFn(modelFn, opts, interpreter){\n    return modelFn.call(interpreter,\n        opts._x,\n        opts._x._sessionid,\n        opts._x._ioprocessors,\n        interpreter.isIn.bind(interpreter));\n}\n\nfunction deserializeSerializedConfiguration(serializedConfiguration,idToStateMap){\n  return serializedConfiguration.map(function(id){\n    var state = idToStateMap.get(id);\n    if(!state) throw new Error('Error loading serialized configuration. Unable to locate state with id ' + id);\n    return state;\n  });\n}\n\nfunction deserializeHistory(serializedHistory,idToStateMap){\n  var o = {};\n  Object.keys(serializedHistory).forEach(function(sid){\n    o[sid] = serializedHistory[sid].map(function(id){\n      var state = idToStateMap.get(id);\n      if(!state) throw new Error('Error loading serialized history. Unable to locate state with id ' + id);\n      return state;\n    });\n  });\n  return o;\n}\n\nconst printTrace = !!process.env.DEBUG;\n\nBaseInterpreter.EVENTS = [\n  'onEntry',\n  'onExit',\n  'onTransition',\n  'onError',\n  'onBigStepBegin',\n  'onBigStepSuspend',\n  'onBigStepResume',\n  'onSmallStepBegin',\n  'onSmallStepEnd',\n  'onBigStepEnd'\n];\n\n/** @constructor */\nfunction BaseInterpreter(modelOrFnGenerator, opts){\n\n    EventEmitter.call(this);\n\n    this._scriptingContext = opts.interpreterScriptingContext || (opts.InterpreterScriptingContext ? new opts.InterpreterScriptingContext(this) : {}); \n\n\n    this.opts = opts || {};\n\n    this.opts.generateSessionid = this.opts.generateSessionid || BaseInterpreter.generateSessionid;\n    this.opts.sessionid = this.opts.sessionid || this.opts.generateSessionid();\n    this.opts.sessionRegistry = this.opts.sessionRegistry || BaseInterpreter.sessionRegistry;  //TODO: define a better interface. For now, assume a Map<sessionid, session>\n\n\n    let _ioprocessors = {};\n    _ioprocessors[SCXML_IOPROCESSOR_TYPE] = {\n      location : `#_scxml_${this.opts.sessionid}`\n    }\n    _ioprocessors.scxml = _ioprocessors[SCXML_IOPROCESSOR_TYPE];    //alias\n\n    //SCXML system variables:\n    opts._x = {\n        _sessionid : opts.sessionid,\n        _ioprocessors : _ioprocessors\n    };\n\n\n    var model;\n    if(typeof modelOrFnGenerator === 'function'){\n        model = initializeModelGeneratorFn(modelOrFnGenerator, opts, this);\n    }else if(typeof modelOrFnGenerator === 'object'){\n        model = JSON.parse(JSON.stringify(modelOrFnGenerator)); //assume object\n    }else{\n        throw new Error('Unexpected model type. Expected model factory function, or scjson object.');\n    }\n\n    this._model = initializeModel(model);\n\n    this.opts.console = opts.console || (typeof console === 'undefined' ? {log : function(){}} : console);   //rely on global console if this console is undefined\n    this.opts.Set = this.opts.Set || ArraySet;\n    this.opts.priorityComparisonFn = this.opts.priorityComparisonFn || getTransitionWithHigherSourceChildPriority;\n    this.opts.transitionSelector = this.opts.transitionSelector || scxmlPrefixTransitionSelector;\n\n    this.opts.sessionRegistry.set(String(this.opts.sessionid), this);\n\n    this._scriptingContext.log = this._scriptingContext.log || (function log(){ \n      if(this.opts.console.log.apply){\n        this.opts.console.log.apply(this.opts.console, arguments); \n      } else {\n        //console.log on older IE does not support Function.apply, so just pass him the first argument. Best we can do for now.\n        this.opts.console.log(Array.prototype.slice.apply(arguments).join(',')); \n      }\n    }.bind(this));   //set up default scripting context log function\n\n    this._externalEventQueue = [];\n    this._internalEventQueue = [];\n\n    if(opts.params){\n      this._model.$deserializeDatamodel(opts.params);   //load up the datamodel\n    }\n\n    //check if we're loading from a previous snapshot\n    if(opts.snapshot){\n      this._configuration = new this.opts.Set(deserializeSerializedConfiguration(opts.snapshot[0], this._model.$idToStateMap));\n      this._historyValue = deserializeHistory(opts.snapshot[1], this._model.$idToStateMap); \n      this._isInFinalState = opts.snapshot[2];\n      this._model.$deserializeDatamodel(opts.snapshot[3]);   //load up the datamodel\n    }else{\n      this._configuration = new this.opts.Set();\n      this._historyValue = {};\n      this._isInFinalState = false;\n    }\n\n    //add debug logging\n    BaseInterpreter.EVENTS.forEach(function(event){\n      this.on(event, this._log.bind(this,event));\n    }, this);\n}\n\n//some global singletons to use to generate in-memory session ids, in case the user does not specify these data structures\nBaseInterpreter.sessionIdCounter = 1;\nBaseInterpreter.generateSessionid = function(){\n  return BaseInterpreter.sessionIdCounter++;\n}\nBaseInterpreter.sessionRegistry = new Map();\n\nBaseInterpreter.prototype = extend(beget(EventEmitter.prototype),{\n  \n    /** @expose */\n    //cancel an invoked session\n    cancel : function(){\n      delete this.opts.parentSession;\n      if(this._isInFinalState) return;\n      this._isInFinalState = true;\n      this._log(`session cancelled ${this.opts.invokeid}`);\n      this._exitInterpreter();\n    },\n\n    _exitInterpreter : function(){\n      //TODO: cancel invoked sessions\n      //cancel all delayed sends when we enter into a final state.\n      this._cancelAllDelayedSends();\n\n      let statesToExit = \n          this._configuration.iter().\n          map(function(s){ return [s].concat(query.getAncestors(s));},this).\n          reduce(function(a,b){return a.concat(b);},[]).    //flatten\n          reduce(function(a,b){return a.indexOf(b) > -1 ? a : a.concat(b);},[])\n          .sort(getStateWithHigherSourceChildPriority);\n\n      for (var j = 0, len = statesToExit.length; j < len; j++) {\n          var stateExited = statesToExit[j];\n\n          if(stateExited.onExit !== undefined) {\n              for (var exitIdx = 0, exitLen = stateExited.onExit.length; exitIdx < exitLen; exitIdx++) {\n                  let block = stateExited.onExit[exitIdx];\n                  for (let blockIdx = 0, blockLen = block.length; blockIdx < blockLen; blockIdx++) {\n                      let actionRef = block[blockIdx];\n                      try {\n                        actionRef.call(this._scriptingContext, null);\n                      } catch (e){\n                        this._handleError(e, actionRef);\n                        break;\n                      }\n                  }\n              }\n          }\n\n          //cancel invoked session\n          if(stateExited.invokes) stateExited.invokes.forEach( invoke => {\n            this._scriptingContext.cancelInvoke(invoke.id);\n          })\n\n          //if he is a top-level <final> state, then return the done event\n          if(this.opts.parentSession &&\n              stateExited.$type === 'final' &&\n              stateExited.parent.$type === 'scxml'){\n\n            this._scriptingContext.send({\n              target: '#_parent', \n              name: 'done.invoke.' + this.opts.invokeid\n            });\n\n            this.opts.sessionRegistry.delete(this.opts.sessionid);\n          }\n      }\n\n    },\n\n    /** @expose */\n    start : function() {\n        this._initStart();\n        this._performBigStep();\n        return this.getConfiguration();\n    },\n\n    /**\n     * Starts the interpreter asynchronously\n     * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n     * @expose\n     */\n    startAsync : function(cb) {\n        cb = this._initStart(cb);\n        this.genAsync(null, cb);\n    },\n\n    _initStart : function(cb){\n        if (typeof cb !== 'function') {\n            cb = nop;\n        }\n\n        this._log(\"performing initial big step\");\n\n        //We effectively need to figure out states to enter here to populate initial config. assuming root is compound state makes this simple.\n        //but if we want it to be parallel, then this becomes more complex. so when initializing the model, we add a 'fake' root state, which\n        //makes the following operation safe.\n        this._model.initialRef.forEach( s => this._configuration.add(s) );\n\n        return cb;\n    },\n\n    /** @expose */\n    getConfiguration : function() {\n        return this._configuration.iter().map(function(s){return s.id;});\n    },\n\n    /** @expose */\n    getFullConfiguration : function() {\n        return this._configuration.iter().\n                map(function(s){ return [s].concat(query.getAncestors(s));},this).\n                reduce(function(a,b){return a.concat(b);},[]).    //flatten\n                map(function(s){return s.id;}).\n                reduce(function(a,b){return a.indexOf(b) > -1 ? a : a.concat(b);},[]); //uniq\n    },\n\n\n    /** @expose */\n    isIn : function(stateName) {\n        return this.getFullConfiguration().indexOf(stateName) > -1;\n    },\n\n    /** @expose */\n    isFinal : function(stateName) {\n        return this._isInFinalState;\n    },\n\n    /** @private */\n    _performBigStep : function(e) {\n        let currentEvent, keepGoing, allStatesExited, allStatesEntered;\n        [allStatesExited, allStatesEntered, keepGoing, currentEvent] = this._startBigStep(e);\n\n        while (keepGoing) {\n          [currentEvent, keepGoing] = this._selectTransitionsAndPerformSmallStep(currentEvent, allStatesEntered, allStatesExited);\n        }\n\n        this._finishBigStep(allStatesEntered, allStatesExited);\n    },\n\n    _selectTransitionsAndPerformSmallStep : function(currentEvent, allStatesEntered, allStatesExited){\n        var selectedTransitions  = this._selectTransitions(currentEvent, true);\n        if(selectedTransitions.isEmpty()){\n          currentEvent = this._internalEventQueue.shift() || null;\n          selectedTransitions = this._selectTransitions(currentEvent, false);\n        }\n\n        this.emit('onSmallStepBegin', currentEvent);\n        let statesExited, statesEntered;\n        [statesExited, statesEntered] = this._performSmallStep(currentEvent, selectedTransitions);\n        if(statesExited) statesExited.forEach( s => allStatesExited.add(s) );\n        if(statesEntered) statesEntered.forEach( s => allStatesEntered.add(s) );\n        this.emit('onSmallStepEnd', currentEvent);\n        let keepGoing = !selectedTransitions.isEmpty() || this._internalEventQueue.length;\n        return [currentEvent, keepGoing];\n    },\n\n    _startBigStep : function(e){\n        this.emit('onBigStepBegin');\n\n        //do applyFinalize and autoforward\n        this._configuration.iter().forEach(state => {\n          if(state.invokes) state.invokes.forEach( invoke =>  {\n            if(invoke.autoforward){\n              //autoforward\n              this._scriptingContext.send({\n                target: `#_${invoke.id}`, \n                name: e.name,\n                data : e.data\n              });\n            }\n            if(invoke.id === e.invokeid){\n              //applyFinalize\n              if(invoke.finalize) invoke.finalize.forEach( action =>  this._evaluateAction(e, action));\n            } \n          })\n        }); \n\n        if (e) this._internalEventQueue.push(e);\n\n        let allStatesExited = new Set(), allStatesEntered = new Set();\n        let keepGoing = true;\n        let currentEvent = null;\n        return [allStatesEntered, allStatesExited, keepGoing, currentEvent];\n    },\n\n    _finishBigStep : function(allStatesEntered, allStatesExited, cb){\n        let statesToInvoke = Array.from(new Set([...allStatesEntered].filter(s => s.invokes && !allStatesExited.has(s)))).sort(sortInEntryOrder);\n\n        // Here we invoke whatever needs to be invoked. The implementation of 'invoke' is platform-specific\n        statesToInvoke.forEach( s => {\n            s.invokes.forEach( f =>  this._evaluateAction(null,f) )\n        });\n\n        // cancel invoke for allStatesExited\n        allStatesExited.forEach( s => {\n          if(s.invokes) s.invokes.forEach( invoke => {\n            this._scriptingContext.cancelInvoke(invoke.id);\n          })\n        });\n\n        // TODO: Invoking may have raised internal error events and we iterate to handle them        \n        //if not internalQueue.isEmpty():\n        //    continue\n\n        this._isInFinalState = this._configuration.iter().every(function(s){ return s.typeEnum === STATE_TYPES.FINAL; });\n        if(this._isInFinalState){\n          this._exitInterpreter();\n        }\n        this.emit('onBigStepEnd');\n        if(cb) cb(undefined, this.getConfiguration());\n    },\n\n    _cancelAllDelayedSends : function(){\n      for( let timeoutOptions of this._scriptingContext._timeouts){\n        if(!timeoutOptions.sendOptions.delay) continue;\n        this._log('cancelling delayed send', timeoutOptions);\n        clearTimeout(timeoutOptions.timeoutHandle);\n        this._scriptingContext._timeouts.delete(timeoutOptions);\n      }\n      Object.keys(this._scriptingContext._timeoutMap).forEach(function(key){\n        delete this._scriptingContext._timeoutMap[key];\n      }, this);\n    },\n\n    _performBigStepAsync : function(e, cb) {\n        let currentEvent, keepGoing, allStatesExited, allStatesEntered;\n        [allStatesExited, allStatesEntered, keepGoing, currentEvent] = this._startBigStep(e);\n\n        function nextStep(emit){\n          this.emit(emit);\n          [currentEvent, keepGoing] = this._selectTransitionsAndPerformSmallStep(currentEvent, allStatesEntered, allStatesExited);\n\n          if(keepGoing){\n            this.emit('onBigStepSuspend');\n            setImmediate(nextStep.bind(this),'onBigStepResume');\n          }else{\n            this._finishBigStep(allStatesEntered, allStatesExited, cb);\n          }\n        }\n        nextStep.call(this,'onBigStepBegin');\n    },\n\n    /** @private */\n    _performSmallStep : function(currentEvent, selectedTransitions) {\n\n        this._log(\"selecting transitions with currentEvent\", currentEvent);\n\n        this._log(\"selected transitions\", selectedTransitions);\n\n        if (!selectedTransitions.isEmpty()) {\n\n            this._log(\"sorted transitions\", selectedTransitions);\n\n            //we only want to enter and exit states from transitions with targets\n            //filter out targetless transitions here - we will only use these to execute transition actions\n            var selectedTransitionsWithTargets = new this.opts.Set(selectedTransitions.iter().filter(transitionWithTargets));\n\n            var exitedTuple = this._getStatesExited(selectedTransitionsWithTargets), \n                basicStatesExited = exitedTuple[0], \n                statesExited = exitedTuple[1];\n\n            var statesEntered = this._getStatesEntered(selectedTransitionsWithTargets); \n\n            this._log(\"basicStatesExited \", basicStatesExited);\n            this._log(\"statesExited \", statesExited);\n            this._log(\"statesEntered \", statesEntered);\n\n            var eventsToAddToInnerQueue = new this.opts.Set();\n\n            //update history states\n            this._log(\"executing state exit actions\");\n\n            for (var j = 0, len = statesExited.length; j < len; j++) {\n                var stateExited = statesExited[j];\n\n                if(stateExited.isAtomic) this._configuration.remove(stateExited);\n\n                this._log(\"exiting \", stateExited.id);\n\n                //invoke listeners\n                this.emit('onExit',stateExited.id)\n\n                if(stateExited.onExit !== undefined) {\n                    for (var exitIdx = 0, exitLen = stateExited.onExit.length; exitIdx < exitLen; exitIdx++) {\n                        let block = stateExited.onExit[exitIdx];\n                        for (let blockIdx = 0, blockLen = block.length; blockIdx < blockLen; blockIdx++) {\n                            let actionRef = block[blockIdx];\n                            try {\n                              actionRef.call(this._scriptingContext, currentEvent);\n                            } catch (e){\n                              this._handleError(e, actionRef);\n                              break;\n                            }\n                        }\n                    }\n                }\n\n                var f;\n                if (stateExited.historyRef) {\n                    for(let historyRef of stateExited.historyRef){\n                        if (historyRef.isDeep) {\n                            f = function(s0) {\n                                return s0.typeEnum === STATE_TYPES.BASIC && stateExited.descendants.indexOf(s0) > -1;\n                            };\n                        } else {\n                            f = function(s0) {\n                                return s0.parent === stateExited;\n                            };\n                        }\n                        //update history\n                        this._historyValue[historyRef.id] = statesExited.filter(f);\n                    }\n                }\n            }\n\n            // -> Concurrency: Number of transitions: Multiple\n            // -> Concurrency: Order of transitions: Explicitly defined\n            var sortedTransitions = selectedTransitions.iter().sort(transitionComparator);\n\n            this._log(\"executing transitition actions\");\n\n\n            for (var stxIdx = 0, len = sortedTransitions.length; stxIdx < len; stxIdx++) {\n                var transition = sortedTransitions[stxIdx];\n\n                var targetIds = transition.targets && transition.targets.map(function(target){return target.id;});\n\n                this.emit('onTransition',transition.source.id,targetIds, transition.source.transitions.indexOf(transition));\n\n                if(transition.onTransition !== undefined) {\n                    for (var txIdx = 0, txLen = transition.onTransition.length; txIdx < txLen; txIdx++) {\n                        let actionRef = transition.onTransition[txIdx];\n                        try {\n                          actionRef.call(this._scriptingContext, currentEvent);\n                        } catch (e){\n                          this._handleError(e, actionRef);\n                          break;\n                        }\n                    }\n                }\n            }\n \n            this._log(\"executing state enter actions\");\n\n            for (var enterIdx = 0, enterLen = statesEntered.length; enterIdx < enterLen; enterIdx++) {\n                var stateEntered = statesEntered[enterIdx];\n\n                if(stateEntered.isAtomic) this._configuration.add(stateEntered);\n\n                this._log(\"entering\", stateEntered.id);\n\n                this.emit('onEntry',stateEntered.id);\n\n                if(stateEntered.onEntry !== undefined) {\n                    for (var entryIdx = 0, entryLen = stateEntered.onEntry.length; entryIdx < entryLen; entryIdx++) {\n                        let block = stateEntered.onEntry[entryIdx];\n                        for (let blockIdx = 0, blockLen = block.length; blockIdx < blockLen; blockIdx++) {\n                            let actionRef = block[blockIdx];\n                            try {\n                              actionRef.call(this._scriptingContext, currentEvent);\n                            } catch (e){\n                              this._handleError(e, actionRef);\n                              break;\n                            }\n                        }\n                    }\n                }\n            }\n\n            for (var enterIdx = 0, enterLen = statesEntered.length; enterIdx < enterLen; enterIdx++) {\n                var stateEntered = statesEntered[enterIdx];\n                if(stateEntered.typeEnum === STATE_TYPES.FINAL){\n                  let parent = stateEntered.parent;\n                  let grandparent = parent.parent;\n                  this._internalEventQueue.push({name : \"done.state.\" + parent.id, data : stateEntered.donedata});    //TODO: implement donedata\n                  if(grandparent && grandparent.typeEnum === STATE_TYPES.PARALLEL){\n                      if(grandparent.states.every(s => this.isInFinalState(s) )){\n                          this._internalEventQueue.push({name : \"done.state.\" + grandparent.id});\n                      }\n                  }\n                }\n            }\n\n\n\n            this._log(\"new configuration \", this._configuration);\n            \n            //add set of generated events to the innerEventQueue -> Event Lifelines: Next small-step\n            if (!eventsToAddToInnerQueue.isEmpty()) {\n                this._log(\"adding triggered events to inner queue \", eventsToAddToInnerQueue);\n                this._internalEventQueue.push(eventsToAddToInnerQueue);\n            }\n\n        }\n\n        //if selectedTransitions is empty, we have reached a stable state, and the big-step will stop, otherwise will continue -> Maximality: Take-Many\n        return [statesExited, statesEntered];\n    },\n\n\n    isInFinalState : function(s){\n        if(s.typeEnum === STATE_TYPES.COMPOSITE){\n            return s.states.some(s => s.typeEnum === STATE_TYPES.FINAL && this._configuration.contains(s));\n        }else if(s.typeEnum === STATE_TYPES.PARALLEL){\n            return s.states.every(this.isInFinalState.bind(this))\n        }else{\n            return false\n        }\n    },\n\n    /** @private */\n    _evaluateAction : function(currentEvent, actionRef) {\n        try {\n          return actionRef.call(this._scriptingContext, currentEvent);     //SCXML system variables\n        } catch (e){\n          this._handleError(e, actionRef);\n        }\n    },\n\n    _handleError : function(e, actionRef){\n      let event = \n        e instanceof Error || e.__proto__.name === 'Error' ?  //we can't just do 'e instanceof Error', because the Error object in the sandbox is from a different context, and instanceof will return false\n          {\n            name:'error.execution',\n            data : {\n              tagname: actionRef.tagname, \n              line: actionRef.line, \n              column: actionRef.column,\n              reason: e.message\n            },\n            type : 'platform'\n          } : \n          (e.name ? \n            e : \n            {\n              name:'error.execution',\n              data:e,\n              type : 'platform'\n            }\n          );\n      this._internalEventQueue.push(event);\n      this.emit('onError', event);\n    },\n\n    /** @private */\n    _getStatesExited : function(transitions) {\n        var statesExited = new this.opts.Set();\n        var basicStatesExited = new this.opts.Set();\n\n        //States exited are defined to be active states that are\n        //descendants of the scope of each priority-enabled transition.\n        //Here, we iterate through the transitions, and collect states\n        //that match this condition. \n        var transitionList = transitions.iter();\n        for (var txIdx = 0, txLen = transitionList.length; txIdx < txLen; txIdx++) {\n            var transition = transitionList[txIdx];\n            var scope = transition.scope,\n                desc = scope.descendants;\n\n            //For each state in the configuration\n            //is that state a descendant of the transition scope?\n            //Store ancestors of that state up to but not including the scope.\n            var configList = this._configuration.iter();\n            for (var cfgIdx = 0, cfgLen = configList.length; cfgIdx < cfgLen; cfgIdx++) {\n                var state = configList[cfgIdx];\n                if(desc.indexOf(state) > -1){\n                    basicStatesExited.add(state);\n                    statesExited.add(state);\n                    var ancestors = query.getAncestors(state,scope); \n                    for (var ancIdx = 0, ancLen = ancestors.length; ancIdx < ancLen; ancIdx++) { \n                        statesExited.add(ancestors[ancIdx]);\n                    }\n                }\n            }\n        }\n\n        var sortedStatesExited = statesExited.iter().sort(getStateWithHigherSourceChildPriority);\n        return [basicStatesExited, sortedStatesExited];\n    },\n\n    _getStatesEntered : function(enabledTransitions){\n        let statesToEnter = new Set();\n        // initialize the temporary table for default content in history states\n        this._computeEntrySet(enabledTransitions, statesToEnter) \n        return [...statesToEnter].sort(sortInEntryOrder);\n    },\n\n    _computeEntrySet : function(transitions, statesToEnter){\n      for(let t of transitions.iter()){\n          for(let s of t.targets){\n              this._addDescendantStatesToEnter(s,statesToEnter) \n          }\n          let ancestor = t.scope;\n          for(let s of this._getEffectiveTargetStates(t)){\n              this._addAncestorStatesToEnter(s, ancestor, statesToEnter)\n          }\n      }\n    },\n\n    _getEffectiveTargetStates : function(transition){\n      let targets = new Set();\n      for(let s of transition.targets){\n          if(s.typeEnum === STATE_TYPES.HISTORY){\n              if(s.id in this._historyValue)\n                  this._historyValue[s.id].forEach( state => targets.add(state))\n              else\n                  [...this._getEffectiveTargetStates(s.transitions[0])].forEach( state => targets.add(state))\n          } else {\n              targets.add(s)\n          }\n      }\n      return targets\n    },\n\n    _addDescendantStatesToEnter : function(state,statesToEnter){\n      if(state.typeEnum === STATE_TYPES.HISTORY){\n          if(this._historyValue[state.id]){\n              for(let s of this._historyValue[state.id])\n                  this._addDescendantStatesToEnter(s,statesToEnter)\n              \n              for(let s of this._historyValue[state.id])\n                  this._addAncestorStatesToEnter(s, state.parent, statesToEnter)\n          } else {\n              statesToEnter.add(state)\n          }\n      } else {\n          statesToEnter.add(state)\n          if(state.typeEnum === STATE_TYPES.COMPOSITE){\n              for(let s of state.initialRef)\n                  this._addDescendantStatesToEnter(s,statesToEnter)\n              for(let s of state.initialRef)\n                  this._addAncestorStatesToEnter(s, state, statesToEnter)\n          }else{\n              if(state.typeEnum === STATE_TYPES.PARALLEL){\n                  for(let child of state.states){\n                      if(![...statesToEnter].some(s => query.isDescendant(s, child))){\n                          this._addDescendantStatesToEnter(child,statesToEnter) \n                      }\n                  }\n              }\n          }\n      }\n    },\n\n    _addAncestorStatesToEnter : function(state, ancestor, statesToEnter){\n      for(let anc of query.getAncestors(state,ancestor)){\n          statesToEnter.add(anc)\n          if(anc.typeEnum === STATE_TYPES.PARALLEL){\n              for(let child of anc.states){\n                  if(![...statesToEnter].some(s => query.isDescendant(s, child))){\n                      this._addDescendantStatesToEnter(child,statesToEnter) \n                  }\n              }\n          }\n      }\n    },\n\n    /** @private */\n    _selectTransitions : function(currentEvent, selectEventlessTransitions) {\n        var transitionSelector = this.opts.transitionSelector;\n        var enabledTransitions = new this.opts.Set();\n\n        var e = this._evaluateAction.bind(this,currentEvent);\n\n        let atomicStates = this._configuration.iter().sort(transitionComparator);\n        for(let state of atomicStates){\n            loop: for(let s of [state].concat(query.getAncestors(state))){\n                for(let t of s.transitions){\n                    if(transitionSelector(t, currentEvent, e, selectEventlessTransitions)){\n                        enabledTransitions.add(t);\n                        break loop;\n                    }\n                }\n            }\n        }\n\n        var priorityEnabledTransitions = this._removeConflictingTransition(enabledTransitions);\n\n        this._log(\"priorityEnabledTransitions\", priorityEnabledTransitions);\n        \n        return priorityEnabledTransitions;\n    },\n\n    /** @private */\n    _removeConflictingTransition : function(enabledTransitions) {\n      let filteredTransitions = new this.opts.Set()\n      //toList sorts the transitions in the order of the states that selected them\n      for( let t1 of enabledTransitions.iter()){\n          let t1Preempted = false;\n          let transitionsToRemove = new Set()\n          for (let t2 of filteredTransitions.iter()){\n              let t1ExitSet = query.getAncestors(t1.source, t1.scope);    //t1 exit set\n              let t2ExitSet = query.getAncestors(t2.source, t2.scope);     //t2 exit set\n              let hasIntersection = t1ExitSet.some( s => t2ExitSet.indexOf(s) > -1);   //is this the same as arena orthogonal?\n              if(hasIntersection){\n                  if(t2.source.descendants.indexOf(t1.source) > -1){    //is this the same as being ancestrally related?\n                      transitionsToRemove.add(t2)\n                  }else{ \n                      t1Preempted = true;\n                      break\n                  }\n              }\n          }\n          if(!t1Preempted){\n              for(let t3 of transitionsToRemove){\n                  filteredTransitions.remove(t3)\n              }\n              filteredTransitions.add(t1)\n          }\n      }\n             \n      return filteredTransitions;\n    },\n\n    _log : function(){\n      if(printTrace){\n        var args = Array.from(arguments);\n        this.opts.console.log( \n          `${args[0]}: ${\n            args.slice(1).map(function(arg){\n              return arg === null ? 'null' : \n                ( arg === undefined ? 'undefined' : \n                  ( typeof arg === 'string' ? arg : \n                    ( arg.toString() === '[object Object]' ? util.inspect(arg) : arg.toString())));\n\n            }).join(', ')\n          }\\n`\n        );\n      }\n    },\n\n    /*\n        registerListener provides a generic mechanism to subscribe to state change and runtime error notifications.\n        Can be used for logging and debugging. For example, can attach a logger that simply logs the state changes.\n        Or can attach a network debugging client that sends state change notifications to a debugging server.\n    \n        listener is of the form:\n        {\n          onEntry : function(stateId){},\n          onExit : function(stateId){},\n          onTransition : function(sourceStateId,targetStatesIds[]){},\n          onError: function(errorInfo){},\n          onBigStepBegin: function(){},\n          onBigStepResume: function(){},\n          onBigStepSuspend: function(){},\n          onBigStepEnd: function(){}\n          onSmallStepBegin: function(event){},\n          onSmallStepEnd: function(){}\n        }\n    */\n    //TODO: refactor this to be event emitter? \n\n    /** @expose */\n    registerListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.on(event,listener[event]);\n        }, this);\n    },\n\n    /** @expose */\n    unregisterListener : function(listener){\n        BaseInterpreter.EVENTS.forEach(function(event){\n          if(listener[event]) this.off(event,listener[event]);\n        }, this);\n    },\n\n    /** @expose */\n    getAllTransitionEvents : function(){\n        var events = {};\n        function getEvents(state){\n\n            if(state.transitions){\n                for (var txIdx = 0, txLen = state.transitions.length; txIdx < txLen; txIdx++) {\n                    events[state.transitions[txIdx].event] = true;\n                }\n            }\n\n            if(state.states) {\n                for (var stateIdx = 0, stateLen = state.states.length; stateIdx < stateLen; stateIdx++) {\n                    getEvents(state.states[stateIdx]);\n                }\n            }\n        }\n\n        getEvents(this._model);\n\n        return Object.keys(events);\n    },\n\n    \n    /** @expose */\n    /**\n      Three things capture the current snapshot of a running SCION interpreter:\n\n      * basic configuration (the set of basic states the state machine is in)\n      * history state values (the states the state machine was in last time it was in the parent of a history state)\n      * the datamodel\n      \n      Note that this assumes that the method to serialize a scion.SCXML\n      instance is not called when the interpreter is executing a big-step (e.g. after\n      scion.SCXML.prototype.gen is called, and before the call to gen returns). If\n      the serialization method is called during the execution of a big-step, then the\n      inner event queue must also be saved. I do not expect this to be a common\n      requirement however, and therefore I believe it would be better to only support\n      serialization when the interpreter is not executing a big-step.\n    */\n    getSnapshot : function(){\n      if(this._isStepping) throw new Error('getSnapshot cannot be called while interpreter is executing a big-step');\n\n\n      return [\n        this.getConfiguration(),\n        this._serializeHistory(),\n        this._isInFinalState,\n        this._model.$serializeDatamodel()\n      ];\n    },\n\n    _serializeHistory : function(){\n      var o = {};\n      Object.keys(this._historyValue).forEach(function(sid){\n        o[sid] = this._historyValue[sid].map(function(state){return state.id});\n      },this);\n      return o;\n    }\n});\n\n/**\n * @constructor\n * @extends BaseInterpreter\n */\nfunction Statechart(model, opts) {\n    opts = opts || {};\n\n    opts.InterpreterScriptingContext = opts.InterpreterScriptingContext || InterpreterScriptingContext;\n\n    this._isStepping = false;\n\n    BaseInterpreter.call(this,model,opts);     //call super constructor\n}\n\nfunction beget(o){\n    function F(){}\n    F.prototype = o;\n    return new F();\n}\n\n/**\n * Do nothing\n */\nfunction nop() {}\n\n//Statechart.prototype = Object.create(BaseInterpreter.prototype);\n//would like to use Object.create here, but not portable, but it's too complicated to use portably\nStatechart.prototype = beget(BaseInterpreter.prototype);    \n\n/** @expose */\nStatechart.prototype.gen = function(evtObjOrName,optionalData) {\n\n    var currentEvent;\n    switch(typeof evtObjOrName){\n        case 'string':\n            currentEvent = {name : evtObjOrName, data : optionalData};\n            break;\n        case 'object':\n            if(typeof evtObjOrName.name === 'string'){\n                currentEvent = evtObjOrName;\n            }else{\n                throw new Error('Event object must have \"name\" property of type string.');\n            }\n            break;\n        default:\n            throw new Error('First argument to gen must be a string or object.');\n    }\n\n    if(this._isStepping) throw new Error('Cannot call gen during a big-step');\n\n    //otherwise, kick him off\n    this._isStepping = true;\n\n    this._performBigStep(currentEvent);\n\n    this._isStepping = false;\n    return this.getConfiguration();\n};\n\n/**\n * Injects an external event into the interpreter asynchronously\n * @param  {object}   currentEvent The event to inject\n * @param {string} currentEvent.name The name of the event\n * @param {string} [currentEvent.data] The event data\n * @param  {Function} cb Callback invoked with an error or the interpreter's stable configuration\n * @expose\n */\nStatechart.prototype.genAsync = function(currentEvent, cb) {\n    if (currentEvent !== null && (typeof currentEvent !== 'object' || !currentEvent || typeof currentEvent.name !== 'string')) {\n        throw new Error('Expected currentEvent to be null or an Object with a name');\n    }\n    \n    if (typeof cb !== 'function') {\n        cb = nop;\n    }\n\n    this._externalEventQueue.push([currentEvent, cb]);\n\n    //the semantics we want are to return to the cb the results of processing that particular event.\n    function nextStep(e, c){\n      this._performBigStepAsync(e, function(err, config) {\n          c(err, config);\n\n          if(this._externalEventQueue.length){\n            nextStep.apply(this,this._externalEventQueue.shift());\n          }else{\n            this._isStepping = false;\n          }\n      }.bind(this));\n    }\n    if(!this._isStepping){ \n      this._isStepping = true;\n      nextStep.apply(this,this._externalEventQueue.shift());\n    }\n};\n\nfunction InterpreterScriptingContext(interpreter) {\n    this._interpreter = interpreter;\n    this._timeoutMap = {};\n    this._invokeMap = {};\n    this._timeouts = new Set()\n}\n\n//Regex from:\n//  http://daringfireball.net/2010/07/improved_regex_for_matching_urls\n//  http://stackoverflow.com/a/6927878\nvar validateUriRegex = /(#_.*)|\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))/i;\n\n//TODO: consider whether this is the API we would like to expose\nInterpreterScriptingContext.prototype = {\n    invokeSendTargetRegex  : /^#_(.*)$/,\n    scxmlSendTargetRegex  : /^#_scxml_(.*)$/,\n    raise : function(event){\n        this._installDefaultPropsOnEvent(event, true);\n        this._interpreter._internalEventQueue.push(event); \n    },\n    parseXmlStringAsDOM : function(xmlString){\n      return (this._interpreter.opts.xmlParser || InterpreterScriptingContext.xmlParser).parse(xmlString);\n    },\n    invoke : function(invokeObj){\n      //look up invoker by type. assume invokers are passed in as an option to constructor\n      this._invokeMap[invokeObj.id] = new Promise((resolve, reject) => {\n        (this._interpreter.opts.invokers || InterpreterScriptingContext.invokers)[invokeObj.type](this._interpreter, invokeObj, (err, session) => {\n          if(err) return reject(err);\n  \n          resolve(session);\n        });\n      });\n    },\n    cancelInvoke : function(invokeid){\n      //TODO: on cancel invoke clean up this._invokeMap\n      let sessionPromise = this._invokeMap[invokeid];\n      this._interpreter._log(`cancelling session with invokeid ${invokeid}`);\n      if(sessionPromise){\n        this._interpreter._log(`sessionPromise found`);\n        sessionPromise.then( \n          ((session) => {\n            this._interpreter._log(`resolved session ${invokeid}. cancelling... `);\n            session.cancel(); \n            //clean up\n            delete this._invokeMap[invokeid];\n          }), \n          ( (err) => {\n            //TODO: dispatch error back into the state machine as error.communication\n          }));\n      }\n    },\n    _installDefaultPropsOnEvent : function(event,isInternal){\n      if(!isInternal){ \n        event.origin = this._interpreter.opts._x._ioprocessors.scxml.location;     //TODO: preserve original origin when we autoforward? \n        event.origintype = event.type || SCXML_IOPROCESSOR_TYPE;\n      }\n      if(typeof event.type === 'undefined'){\n        event.type = isInternal ? 'internal' : 'external';\n      }\n      [\n        'name',\n        'sendid',\n        'invokeid',\n        'data',\n        'origin',\n        'origintype'\n      ].forEach(prop => {\n        if(!event[prop]){\n          event[prop] = undefined;\n        }\n      });\n    },\n    send : function(event, options){\n        this._interpreter._log('send event', event, options);\n        options = options || {};\n        var sendType = options.type || SCXML_IOPROCESSOR_TYPE;\n        //TODO: move these out\n        function validateSend(event, options, sendAction){\n          if(event.target){\n            var targetIsValidUri = validateUriRegex.test(event.target)\n            if(!targetIsValidUri){\n              throw { name : \"error.execution\", data: 'Target is not valid URI', sendid: event.sendid, type : 'platform' };\n            }\n          }\n          if( sendType !== SCXML_IOPROCESSOR_TYPE) {  //TODO: extend this to support HTTP, and other IO processors\n              throw { name : \"error.execution\", data: 'Unsupported event processor type', sendid: event.sendid, type : 'platform' };\n          }\n\n          sendAction.call(this, event, options);\n        }\n\n        function defaultSendAction (event, options) {\n\n          if( typeof setTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.');\n\n          var match;\n          if(event.target === '#_internal'){\n            this.raise(event);\n          }else{ \n            this._installDefaultPropsOnEvent(event, false);\n            event.origintype = SCXML_IOPROCESSOR_TYPE;      //TODO: extend this to support HTTP, and other IO processors\n                                                            //TODO : paramterize this based on send/@type?\n            if(!event.target){\n              doSend.call(this, this._interpreter);\n            }else if(event.target === '#_parent'){\n              if(this._interpreter.opts.parentSession){\n                event.invokeid = this._interpreter.opts.invokeid;\n                doSend.call(this, this._interpreter.opts.parentSession);\n              }else{\n                throw { name : \"error.communication\", data: 'Parent session not specified', sendid: event.sendid, type : 'platform' };\n              }\n            } else if(match = event.target.match(this.scxmlSendTargetRegex)){\n              let targetSessionId = match[1];\n              let session = this._interpreter.opts.sessionRegistry.get(targetSessionId)\n              if(session){\n                doSend.call(this,session);\n              }else {\n                throw {name : 'error.communication', sendid: event.sendid, type : 'platform'};\n              }\n            }else if(match = event.target.match(this.invokeSendTargetRegex)){\n              //TODO: test this code path.\n              var invokeId = match[1]\n              this._invokeMap[invokeId].then( (session) => {\n                doSend.call(this,session);\n              })\n            } else {\n              throw new Error('Unrecognized send target.'); //TODO: dispatch error back into the state machine\n            }\n          }\n\n          function doSend(session){\n            //TODO: we probably now need to refactor data structures:\n            //    this._timeouts\n            //    this._timeoutMap\n            var timeoutHandle = setTimeout(function(){\n              if (event.sendid) delete this._timeoutMap[event.sendid];\n              this._timeouts.delete(timeoutOptions);\n              session[this._interpreter.opts.sendAsync ? 'genAsync' : 'gen'](event);\n            }.bind(this), options.delay || 0);\n\n            var timeoutOptions = {\n              sendOptions : options,\n              timeoutHandle : timeoutHandle\n            };\n            if (event.sendid) this._timeoutMap[event.sendid] = timeoutHandle;\n            this._timeouts.add(timeoutOptions); \n          }\n        }\n\n        function publish(){\n          this._interpreter.emit(event.name,event.data);\n        }\n\n        //choose send function\n        //TODO: rethink how this custom send works\n        var sendFn;         \n        if(event.type === 'https://github.com/jbeard4/SCION#publish'){\n          sendFn = publish;\n        }else if(this._interpreter.opts.customSend){\n          sendFn = this._interpreter.opts.customSend;\n        }else{\n          sendFn = defaultSendAction;\n        }\n\n        options=options || {};\n\n        this._interpreter._log(\"sending event\", event.name, \"with content\", event.data, \"after delay\", options.delay);\n\n        validateSend.call(this, event, options, sendFn);\n    },\n    cancel : function(sendid){\n        if(this._interpreter.opts.customCancel) {\n            return this._interpreter.opts.customCancel.apply(this, [sendid]);\n        }\n\n        if( typeof clearTimeout === 'undefined' ) throw new Error('Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.');\n\n        if (sendid in this._timeoutMap) {\n            this._interpreter._log(\"cancelling \", sendid, \" with timeout id \", this._timeoutMap[sendid]);\n            clearTimeout(this._timeoutMap[sendid]);\n        }\n    }\n};\n\nmodule.exports = {\n    /** @expose */\n    BaseInterpreter: BaseInterpreter,\n    /** @expose */\n    Statechart: Statechart,\n    /** @expose */\n    ArraySet : ArraySet,\n    /** @expose */\n    STATE_TYPES : STATE_TYPES,\n    /** @expose */\n    initializeModel : initializeModel,\n    /** @expose */\n    InterpreterScriptingContext : InterpreterScriptingContext\n};\n"]}