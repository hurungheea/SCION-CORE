/*! @jbeard/scion-core 2017-09-20 */
!function(a,b){if("function"==typeof define&&define.amd)define(["module","util"],b);else if("undefined"!=typeof exports)b(module,require("util"));else{var c={exports:{}};b(c,a.util),a.scion=c.exports}}(this,function(a,b){"use strict";function c(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function d(a){return a.targets}function e(a,b){return a.documentOrder-b.documentOrder}function f(a){function b(a){void 0===p[a]&&(p[a]=0);do var b=p[a]++,c="$generated-"+a+"-"+b;while(n.has(c));return c}function c(a){return{$deserializeDatamodel:a.$deserializeDatamodel||function(){},$serializeDatamodel:a.$serializeDatamodel||function(){return null},$idToStateMap:n,docUrl:a.docUrl,states:[{$type:"initial",transitions:[{target:a}]},a]}}function d(a){return a+" -- "+(this.events?"("+this.events.join(",")+")":null)+(this.cond?"["+this.cond.name+"]":"")+" --> "+(this.targets?this.targets.join(","):null)}function e(){return this.id}function f(a){if(a.id&&n.set(a.id,a),a.states)for(var b=0,c=a.states.length;b<c;b++)f(a.states[b])}function g(a,c){D&&(c.toString=e),c.transitions&&m.push.apply(m,c.transitions),c.$type=c.$type||"state",c.ancestors=a,c.depth=a.length,c.parent=a[0],c.documentOrder=o++,c.transitions=c.transitions||[];for(var f=0,i=c.transitions.length;f<i;f++){var j=c.transitions[f];j.documentOrder=o++,j.source=c,D&&(j.toString=d.bind(j,c))}if(c.states)for(var k=[c].concat(a),f=0,i=c.states.length;f<i;f++)g(k,c.states[f]);switch(c.$type){case"parallel":c.typeEnum=z.PARALLEL,c.isAtomic=!1;break;case"initial":c.typeEnum=z.INITIAL,c.isAtomic=!0;break;case"history":c.typeEnum=z.HISTORY,c.isAtomic=!0;break;case"final":c.typeEnum=z.FINAL,c.isAtomic=!0;break;case"state":case"scxml":c.states&&c.states.length?(c.typeEnum=z.COMPOSITE,c.isAtomic=!1):(c.typeEnum=z.BASIC,c.isAtomic=!0);break;default:throw new Error("Unknown state type: "+c.$type)}c.states?c.descendants=c.states.concat(c.states.map(function(a){return a.descendants}).reduce(function(a,b){return a.concat(b)},[])):c.descendants=[];var l;if(c.typeEnum===z.COMPOSITE&&(Array.isArray(c.initial)||"string"==typeof c.initial?q.push(c):(l=c.states.filter(function(a){return"initial"===a.$type}),c.initialRef=[l.length?l[0]:c.states[0]],h(c))),c.typeEnum===z.COMPOSITE||c.typeEnum===z.PARALLEL){var p=c.states.filter(function(a){return"history"===a.$type});c.historyRef=p}c.id||(c.id=b(c.$type),n.set(c.id,c)),["onEntry","onExit"].forEach(function(a){c[a]&&(Array.isArray(c[a])||(c[a]=[c[a]]),c[a].every(function(a){return Array.isArray(a)})||(c[a]=[c[a]]))}),c.invokes&&!Array.isArray(c.invokes)&&(c.invokes=[c.invokes],c.invokes.forEach(function(a){a.finalize&&!Array.isArray(a.finalize)&&(a.finalize=[a.finalize])}))}function h(a){if(!a.initialRef)throw new Error("Unable to locate initial state for composite state: "+a.id)}function i(){for(var a=0,b=q.length;a<b;a++){var c=q[a],d=Array.isArray(c.initial)?c.initial:[c.initial];c.initialRef=d.map(function(a){return n.get(a)}),h(c)}}function j(){for(var a=0,b=m.length;a<b;a++){var c=m[a];if(c.onTransition&&!Array.isArray(c.onTransition)&&(c.onTransition=[c.onTransition]),"string"==typeof c.event&&(c.events=c.event.trim().split(r)),delete c.event,!c.targets&&"undefined"!=typeof c.target)if("string"==typeof c.target){var d=n.get(c.target);if(!d)throw new Error("Unable to find target state with id "+c.target);c.target=d,c.targets=[c.target]}else if(Array.isArray(c.target))c.targets=c.target.map(function(a){if("string"==typeof a){if(a=n.get(a),!a)throw new Error("Unable to find target state with id "+c.target);return a}return a});else{if("object"!==x(c.target))throw new Error("Transition target has unknown type: "+c.target);c.targets=[c.target]}}for(var a=0,b=m.length;a<b;a++){var c=m[a];c.targets&&(c.lcca=l(c.source,c.targets[0])),c.scope=k(c)}}function k(a){var b="internal"===a.type&&a.source.typeEnum===z.COMPOSITE&&a.source.parent&&a.targets&&a.targets.every(function(b){return a.source.descendants.indexOf(b)>-1});return a.targets?b?a.source:a.lcca:null}function l(a,b){for(var c=[],d=0,e=a.ancestors.length;d<e;d++){var f=a.ancestors[d];(f.typeEnum===z.COMPOSITE||f.typeEnum===z.PARALLEL)&&f.descendants.indexOf(b)>-1&&c.push(f)}if(!c.length)throw new Error("Could not find LCA for states.");return c[0]}var m=[],n=new Map,o=0,p={},q=[],r=/\s+/;f(a);var s=c(a);return g([],s),j(),i(),s}function g(){this._listeners={},this._listeners["*"]=[]}function h(a){a=a||[],this.o=new Set(a)}function i(a,b){return a=a.replace(B,""),a===b||!(a.length>b.length)&&("."===b.charAt(a.length)&&0===b.indexOf(a))}function j(a,b){return a.events.some(function(a){return"*"===a||i(a,b)})}function k(a,b,c,d){return(d?!a.events:a.events&&b&&b.name&&j(a,b.name))&&(!a.cond||c(a.cond))}function l(a){var b=a[0],c=a[1];n(b.source,c.source);return b.source.depth<c.source.depth?c:c.source.depth<b.source.depth?b:b.documentOrder<c.documentOrder?b:c}function m(a,b){return n(a,b)*-1}function n(a,b){return a.depth>b.depth?-1:a.depth<b.depth?1:a.documentOrder<b.documentOrder?1:a.documentOrder>b.documentOrder?-1:0}function o(a,b,c){return a.call(c,b._x,b._x._sessionid,b._x._ioprocessors,c.isIn.bind(c))}function p(a,b){return a.map(function(a){var c=b.get(a);if(!c)throw new Error("Error loading serialized configuration. Unable to locate state with id "+a);return c})}function q(a,b){var c={};return Object.keys(a).forEach(function(d){c[d]=a[d].map(function(a){var c=b.get(a);if(!c)throw new Error("Error loading serialized history. Unable to locate state with id "+a);return c})}),c}function r(a,b){g.call(this),this._scriptingContext=b.interpreterScriptingContext||(b.InterpreterScriptingContext?new b.InterpreterScriptingContext(this):{}),this.opts=b||{},this.opts.generateSessionid=this.opts.generateSessionid||r.generateSessionid,this.opts.sessionid=this.opts.sessionid||this.opts.generateSessionid(),this.opts.sessionRegistry=this.opts.sessionRegistry||r.sessionRegistry;var c={};c[A]={location:"#_scxml_"+this.opts.sessionid},c.scxml=c[A],b._x={_sessionid:b.sessionid,_ioprocessors:c};var d;if("function"==typeof a)d=o(a,b,this);else{if("object"!==("undefined"==typeof a?"undefined":x(a)))throw new Error("Unexpected model type. Expected model factory function, or scjson object.");d=JSON.parse(JSON.stringify(a))}this._model=f(d),this.opts.console=b.console||("undefined"==typeof console?{log:function(){}}:console),this.opts.Set=this.opts.Set||h,this.opts.priorityComparisonFn=this.opts.priorityComparisonFn||l,this.opts.transitionSelector=this.opts.transitionSelector||k,this.opts.sessionRegistry.set(String(this.opts.sessionid),this),this._scriptingContext.log=this._scriptingContext.log||function(){this.opts.console.log.apply?this.opts.console.log.apply(this.opts.console,arguments):this.opts.console.log(Array.prototype.slice.apply(arguments).join(","))}.bind(this),this._externalEventQueue=[],this._internalEventQueue=[],b.params&&this._model.$deserializeDatamodel(b.params),b.snapshot?(this._configuration=new this.opts.Set(p(b.snapshot[0],this._model.$idToStateMap)),this._historyValue=q(b.snapshot[1],this._model.$idToStateMap),this._isInFinalState=b.snapshot[2],this._model.$deserializeDatamodel(b.snapshot[3]),this._internalEventQueue=b.snapshot[4]):(this._configuration=new this.opts.Set,this._historyValue={},this._isInFinalState=!1),r.EVENTS.forEach(function(a){this.on(a,this._log.bind(this,a))},this)}function s(b,c){c=c||{},c.InterpreterScriptingContext=c.InterpreterScriptingContext||v,this._isStepping=!1,r.call(this,b,c),a.exports.emit("new",this)}function t(a){function b(){}return b.prototype=a,new b}function u(){}function v(a){this._interpreter=a,this._timeoutMap={},this._invokeMap={},this._timeouts=new Set}var w=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},y=Object.assign||function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},z={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5},A="http://www.w3.org/TR/scxml/#SCXMLEventProcessor";g.prototype.on=function(a,b){return Array.isArray(this._listeners[a])||(this._listeners[a]=[]),this._listeners[a].indexOf(b)===-1&&this._listeners[a].push(b),this},g.prototype.once=function(a,b){function c(){for(var e=[],f=0;f<arguments.length;f+=1)e[f]=arguments[f];d.off(a,c),b.apply(d,e)}var d=this;return c.listener=b,this.on(a,c)},g.prototype.off=function(a,b){if("undefined"==typeof a)return Object.keys(this._listeners).forEach(function(a){for(var d=0;d<this._listeners[a].length;d+=1)if(this._listeners[a][d].listener===b){c=d;break}},this),this;if(!Array.isArray(this._listeners[a]))return this;if("undefined"==typeof b)return this._listeners[a]=[],this;var c=this._listeners[a].indexOf(b);if(c===-1)for(var d=0;d<this._listeners[a].length;d+=1)if(this._listeners[a][d].listener===b){c=d;break}return this._listeners[a].splice(c,1),this},g.prototype.emit=function(a){var b,c,d=Array.prototype.slice.call(arguments),e=d.slice(1),f=this._listeners[a];if(Array.isArray(f))for(b=0,c=f.length;b<c;b++)f[b].apply(this,e);for(f=this._listeners["*"],b=0,c=f.length;b<c;b++)f[b].apply(this,d);return this},h.prototype={add:function(a){this.o.add(a)},remove:function(a){return this.o["delete"](a)},union:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;this.o.add(g)}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return this},difference:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;this.o["delete"](g)}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return this},contains:function(a){return this.o.has(a)},iter:function(){return Array.from(this.o)},isEmpty:function(){return!this.o.size},size:function(){return this.o.size},equals:function(a){if(this.o.size!==a.size())return!1;var b=!0,c=!1,d=void 0;try{for(var e,f=this.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;if(!a.contains(g))return!1}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return!0},toString:function(){return 0===this.o.size?"<empty>":Array.from(this.o).join(",\n")}};var B=/\.\*$/,C={isDescendant:function(a,b){return b.descendants.indexOf(a)>-1},getAncestors:function(a,b){var c;return c=a.ancestors.indexOf(b),c>-1?a.ancestors.slice(0,c):a.ancestors},getAncestorsOrSelf:function(a,b){return[a].concat(this.getAncestors(a,b))},getDescendantsOrSelf:function(a){return[a].concat(a.descendants)}},D="undefined"!=typeof process&&!!process.env.DEBUG;r.EVENTS=["onEntry","onExit","onTransition","onError","onBigStepBegin","onBigStepSuspend","onBigStepResume","onSmallStepBegin","onSmallStepEnd","onBigStepEnd"],r.sessionIdCounter=1,r.generateSessionid=function(){return r.sessionIdCounter++},r.sessionRegistry=new Map,r.prototype=y(t(g.prototype),{cancel:function(){delete this.opts.parentSession,this._isInFinalState||(this._isInFinalState=!0,this._log("session cancelled "+this.opts.invokeid),this._exitInterpreter(null))},_exitInterpreter:function(a){var b=this;this._cancelAllDelayedSends();for(var c=this._getFullConfiguration().sort(n),d=0,e=c.length;d<e;d++){var f=c[d];if(void 0!==f.onExit)for(var g=0,h=f.onExit.length;g<h;g++)for(var i=f.onExit[g],j=0,k=i.length;j<k;j++){var l=i[j];try{l.call(this._scriptingContext,null)}catch(m){this._handleError(m,l);break}}f.invokes&&f.invokes.forEach(function(a){b._scriptingContext.cancelInvoke(a.id)}),"final"===f.$type&&"scxml"===f.parent.$type&&(this.opts.parentSession&&this._scriptingContext.send({target:"#_parent",name:"done.invoke."+this.opts.invokeid,data:f.donedata&&f.donedata.call(this._scriptingContext,a)}),this.opts.sessionRegistry["delete"](this.opts.sessionid),this.emit("onExitInterpreter",a))}},start:function(){return this._initStart(),this._performBigStep(),this.getConfiguration()},startAsync:function(a){a=this._initStart(a),this.genAsync(null,a)},_initStart:function(a){var b=this;return"function"!=typeof a&&(a=u),this._log("performing initial big step"),this._model.initialRef.forEach(function(a){return b._configuration.add(a)}),a},getConfiguration:function(){return this._configuration.iter().map(function(a){return a.id})},_getFullConfiguration:function(){return this._configuration.iter().map(function(a){return[a].concat(C.getAncestors(a))},this).reduce(function(a,b){return a.concat(b)},[]).reduce(function(a,b){return a.indexOf(b)>-1?a:a.concat(b)},[])},getFullConfiguration:function(){return this._getFullConfiguration().map(function(a){return a.id})},isIn:function(a){return this.getFullConfiguration().indexOf(a)>-1},isFinal:function(a){return this._isInFinalState},_performBigStep:function(a){var b=void 0,c=void 0,d=void 0,e=void 0,f=this._startBigStep(a),g=w(f,4);for(d=g[0],e=g[1],c=g[2],b=g[3];c;){var h=this._selectTransitionsAndPerformSmallStep(b,e,d),i=w(h,2);b=i[0],c=i[1]}this._finishBigStep(b,e,d)},_selectTransitionsAndPerformSmallStep:function(a,b,c){var d=this._selectTransitions(a,!0);if(d.isEmpty()){var e=this._internalEventQueue.shift();e&&(a=e,d=this._selectTransitions(a,!1))}if(!d.isEmpty()){this.emit("onSmallStepBegin",a);var f=void 0,g=void 0,h=this._performSmallStep(a,d),i=w(h,2);f=i[0],g=i[1],f&&f.forEach(function(a){return c.add(a)}),g&&g.forEach(function(a){return b.add(a)}),this.emit("onSmallStepEnd",a)}var j=!d.isEmpty()||this._internalEventQueue.length;return[a,j]},_startBigStep:function(a){var b=this;this.emit("onBigStepBegin",a),this._configuration.iter().forEach(function(c){c.invokes&&c.invokes.forEach(function(c){c.autoforward&&b._scriptingContext.send({target:"#_"+c.id,name:a.name,data:a.data}),c.id===a.invokeid&&c.finalize&&c.finalize.forEach(function(c){return b._evaluateAction(a,c)})})}),a&&this._internalEventQueue.push(a);var c=new Set,d=new Set,e=!0,f=a;return[d,c,e,f]},_finishBigStep:function(a,b,d,e){var f=this,g=Array.from(new Set([].concat(c(b)).filter(function(a){return a.invokes&&!d.has(a)}))).sort(m);g.forEach(function(b){b.invokes.forEach(function(b){return f._evaluateAction(a,b)})}),d.forEach(function(a){a.invokes&&a.invokes.forEach(function(a){f._scriptingContext.cancelInvoke(a.id)})}),this._isInFinalState=this._configuration.iter().every(function(a){return a.typeEnum===z.FINAL}),this._isInFinalState&&this._exitInterpreter(a),this.emit("onBigStepEnd"),e&&e(void 0,this.getConfiguration())},_cancelAllDelayedSends:function(){var a=!0,b=!1,c=void 0;try{for(var d,e=this._scriptingContext._timeouts[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value;f.sendOptions.delay&&(this._log("cancelling delayed send",f),clearTimeout(f.timeoutHandle),this._scriptingContext._timeouts["delete"](f))}}catch(g){b=!0,c=g}finally{try{!a&&e["return"]&&e["return"]()}finally{if(b)throw c}}Object.keys(this._scriptingContext._timeoutMap).forEach(function(a){delete this._scriptingContext._timeoutMap[a]},this)},_performBigStepAsync:function(a,b){function c(a){this.emit(a);var h=this._selectTransitionsAndPerformSmallStep(d,g,f),i=w(h,2);d=i[0],e=i[1],e?(this.emit("onBigStepSuspend"),setImmediate(c.bind(this),"onBigStepResume")):this._finishBigStep(d,g,f,b)}var d=void 0,e=void 0,f=void 0,g=void 0,h=this._startBigStep(a),i=w(h,4);f=i[0],g=i[1],e=i[2],d=i[3],c.call(this,"onBigStepBegin")},_performSmallStep:function(a,b){this._log("selecting transitions with currentEvent",a),this._log("selected transitions",b);var c=void 0,e=void 0;if(!b.isEmpty()){var f=new this.opts.Set(b.iter().filter(d));c=this._exitStates(a,f),this._executeTransitions(a,b),e=this._enterStates(a,f),this._log("new configuration ",this._configuration)}return[c,e]},_exitStates:function(a,b){var c=void 0,d=void 0,e=this._getStatesExited(b),f=w(e,2);c=f[0],d=f[1],this._log("exiting states");for(var g=0,h=d.length;g<h;g++){var i=d[g];if(i.isAtomic&&this._configuration.remove(i),this._log("exiting ",i.id),this.emit("onExit",i.id),void 0!==i.onExit)for(var j=0,k=i.onExit.length;j<k;j++)for(var l=i.onExit[j],m=0,n=l.length;m<n;m++){var o=l[m];try{o.call(this._scriptingContext,a)}catch(p){this._handleError(p,o);break}}var q;if(i.historyRef){var r=!0,s=!1,t=void 0;try{for(var u,v=i.historyRef[Symbol.iterator]();!(r=(u=v.next()).done);r=!0){var x=u.value;q=x.isDeep?function(a){return a.typeEnum===z.BASIC&&i.descendants.indexOf(a)>-1}:function(a){return a.parent===i},this._historyValue[x.id]=d.filter(q)}}catch(y){s=!0,t=y}finally{try{!r&&v["return"]&&v["return"]()}finally{if(s)throw t}}}}return d},_executeTransitions:function(a,b){var c=b.iter().sort(e);this._log("executing transitition actions");for(var d=0,f=c.length;d<f;d++){var g=c[d],h=g.targets&&g.targets.map(function(a){return a.id});if(this.emit("onTransition",g.source.id,h,g.source.transitions.indexOf(g)),void 0!==g.onTransition)for(var i=0,j=g.onTransition.length;i<j;i++){var k=g.onTransition[i];try{k.call(this._scriptingContext,a)}catch(l){this._handleError(l,k);break}}}},_enterStates:function(a,b){var d=this;this._log("entering states");var e=new Set,f=new Set,g={};this._computeEntrySet(b,e,f,g),e=[].concat(c(e)).sort(m),this._log("statesEntered ",e);for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j.isAtomic&&this._configuration.add(j),this._log("entering",j.id),this.emit("onEntry",j.id),void 0!==j.onEntry)for(var k=0,l=j.onEntry.length;k<l;k++)for(var n=j.onEntry[k],o=0,p=n.length;o<p;o++){var q=n[o];try{q.call(this._scriptingContext,a)}catch(r){this._handleError(r,q);break}}if(f.has(j)){var s=!0,t=!1,u=void 0;try{for(var v,w=j.initialRef[Symbol.iterator]();!(s=(v=w.next()).done);s=!0){var x=v.value;if(this.emit("onDefaultEntry",x.id),x.typeEnum===z.INITIAL){var y=x.transitions[0];if(void 0!==y.onTransition){this._log("executing initial transition content for initial state of parent state",j.id);for(var A=0,B=y.onTransition.length;A<B;A++){var C=y.onTransition[A];try{C.call(this._scriptingContext,a)}catch(r){this._handleError(r,C);break}}}}}}catch(D){t=!0,u=D}finally{try{!s&&w["return"]&&w["return"]()}finally{if(t)throw u}}}if(g[j.id]){var E=g[j.id];if(void 0!==E.onTransition){this._log("executing history transition content for history state of parent state",j.id);for(var A=0,B=E.onTransition.length;A<B;A++){var F=E.onTransition[A];try{F.call(this._scriptingContext,a)}catch(r){this._handleError(r,F);break}}}}}for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j.typeEnum===z.FINAL){var G=j.parent,H=G.parent;this._internalEventQueue.push({name:"done.state."+G.id,data:j.donedata&&j.donedata.call(this._scriptingContext,a)}),H&&H.typeEnum===z.PARALLEL&&H.states.every(function(a){return d.isInFinalState(a)})&&this._internalEventQueue.push({name:"done.state."+H.id})}}return e},isInFinalState:function(a){var b=this;return a.typeEnum===z.COMPOSITE?a.states.some(function(a){return a.typeEnum===z.FINAL&&b._configuration.contains(a)}):a.typeEnum===z.PARALLEL&&a.states.every(this.isInFinalState.bind(this))},_evaluateAction:function(a,b){try{return b.call(this._scriptingContext,a)}catch(c){this._handleError(c,b)}},_handleError:function(a,b){var c=a instanceof Error||"string"==typeof a.__proto__.name&&a.__proto__.name.match(/^.*Error$/)?{name:"error.execution",data:{tagname:b.tagname,line:b.line,column:b.column,reason:a.message},type:"platform"}:a.name?a:{name:"error.execution",data:a,type:"platform"};this._internalEventQueue.push(c),this.emit("onError",c)},_getStatesExited:function(a){for(var b=new this.opts.Set,c=new this.opts.Set,d=a.iter(),e=0,f=d.length;e<f;e++)for(var g=d[e],h=g.scope,i=h.descendants,j=this._configuration.iter(),k=0,l=j.length;k<l;k++){var m=j[k];if(i.indexOf(m)>-1){c.add(m),b.add(m);for(var o=C.getAncestors(m,h),p=0,q=o.length;p<q;p++)b.add(o[p])}}var r=b.iter().sort(n);return[c,r]},_computeEntrySet:function(a,b,c,d){var e=!0,f=!1,g=void 0;try{for(var h,i=a.iter()[Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value,k=!0,l=!1,m=void 0;try{for(var n,o=j.targets[Symbol.iterator]();!(k=(n=o.next()).done);k=!0){var p=n.value;this._addDescendantStatesToEnter(p,b,c,d)}}catch(q){l=!0,m=q}finally{try{!k&&o["return"]&&o["return"]()}finally{if(l)throw m}}var r=j.scope,s=!0,t=!1,u=void 0;try{for(var v,w=this._getEffectiveTargetStates(j)[Symbol.iterator]();!(s=(v=w.next()).done);s=!0){var x=v.value;this._addAncestorStatesToEnter(x,r,b,c,d)}}catch(q){t=!0,u=q}finally{try{!s&&w["return"]&&w["return"]()}finally{if(t)throw u}}}}catch(q){f=!0,g=q}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}},_getEffectiveTargetStates:function(a){var b=new Set,d=!0,e=!1,f=void 0;try{for(var g,h=a.targets[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value;i.typeEnum===z.HISTORY?i.id in this._historyValue?this._historyValue[i.id].forEach(function(a){return b.add(a)}):[].concat(c(this._getEffectiveTargetStates(i.transitions[0]))).forEach(function(a){return b.add(a)}):b.add(i)}}catch(j){e=!0,f=j}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return b},_addDescendantStatesToEnter:function(a,b,d,e){var f=this;if(a.typeEnum===z.HISTORY)if(this._historyValue[a.id]){var g=!0,h=!1,i=void 0;try{for(var j,k=this._historyValue[a.id][Symbol.iterator]();!(g=(j=k.next()).done);g=!0){var l=j.value;this._addDescendantStatesToEnter(l,b,d,e)}}catch(m){h=!0,i=m}finally{try{!g&&k["return"]&&k["return"]()}finally{if(h)throw i}}var n=!0,o=!1,p=void 0;try{for(var q,r=this._historyValue[a.id][Symbol.iterator]();!(n=(q=r.next()).done);n=!0){var s=q.value;this._addAncestorStatesToEnter(s,a.parent,b,d,e)}}catch(m){o=!0,p=m}finally{try{!n&&r["return"]&&r["return"]()}finally{if(o)throw p}}}else{e[a.parent.id]=a.transitions[0];var t=!0,u=!1,v=void 0;try{for(var w,x=a.transitions[0].targets[Symbol.iterator]();!(t=(w=x.next()).done);t=!0){var y=w.value;this._addDescendantStatesToEnter(y,b,d,e)}}catch(m){u=!0,v=m}finally{try{!t&&x["return"]&&x["return"]()}finally{if(u)throw v}}var A=!0,B=!1,D=void 0;try{for(var E,F=a.transitions[0].targets[Symbol.iterator]();!(A=(E=F.next()).done);A=!0){var G=E.value;this._addAncestorStatesToEnter(G,a.parent,b,d,e)}}catch(m){B=!0,D=m}finally{try{!A&&F["return"]&&F["return"]()}finally{if(B)throw D}}}else if(b.add(a),a.typeEnum===z.COMPOSITE){d.add(a);var H=!0,I=!1,J=void 0;try{for(var K,L=a.initialRef[Symbol.iterator]();!(H=(K=L.next()).done);H=!0){var M=K.value,N=M.typeEnum===z.INITIAL?M.transitions[0].targets:[M],O=!0,P=!1,Q=void 0;try{for(var R,S=N[Symbol.iterator]();!(O=(R=S.next()).done);O=!0){var T=R.value;this._addDescendantStatesToEnter(T,b,d,e)}}catch(m){P=!0,Q=m}finally{try{!O&&S["return"]&&S["return"]()}finally{if(P)throw Q}}}}catch(m){I=!0,J=m}finally{try{!H&&L["return"]&&L["return"]()}finally{if(I)throw J}}var U=!0,V=!1,W=void 0;try{for(var X,Y=a.initialRef[Symbol.iterator]();!(U=(X=Y.next()).done);U=!0){var Z=X.value,$=Z.typeEnum===z.INITIAL?Z.transitions[0].targets:[Z],_=!0,aa=!1,ba=void 0;try{for(var ca,da=$[Symbol.iterator]();!(_=(ca=da.next()).done);_=!0){var ea=ca.value;this._addAncestorStatesToEnter(ea,a,b,d,e)}}catch(m){aa=!0,ba=m}finally{try{!_&&da["return"]&&da["return"]()}finally{if(aa)throw ba}}}}catch(m){V=!0,W=m}finally{try{!U&&Y["return"]&&Y["return"]()}finally{if(V)throw W}}}else if(a.typeEnum===z.PARALLEL){var fa=!0,ga=!1,ha=void 0;try{for(var ia,ja=function(){var a=ia.value;[].concat(c(b)).some(function(b){return C.isDescendant(b,a)})||f._addDescendantStatesToEnter(a,b,d,e)},ka=a.states[Symbol.iterator]();!(fa=(ia=ka.next()).done);fa=!0)ja()}catch(m){ga=!0,ha=m}finally{try{!fa&&ka["return"]&&ka["return"]()}finally{if(ga)throw ha}}}},_addAncestorStatesToEnter:function(a,b,d,e,f){var g=this,h=function(a){if(a.typeEnum===z.PARALLEL){var b=!0,h=!1,i=void 0;try{for(var j,k=function(){var a=j.value;a.typeEnum===z.HISTORY||[].concat(c(d)).some(function(b){return C.isDescendant(b,a)})||g._addDescendantStatesToEnter(a,d,e,f)},l=a.states[Symbol.iterator]();!(b=(j=l.next()).done);b=!0)k()}catch(m){h=!0,i=m}finally{try{!b&&l["return"]&&l["return"]()}finally{if(h)throw i}}}},i=!0,j=!1,k=void 0;try{for(var l,m=C.getAncestors(a,b)[Symbol.iterator]();!(i=(l=m.next()).done);i=!0){var n=l.value;d.add(n),h(n)}}catch(o){j=!0,k=o}finally{try{!i&&m["return"]&&m["return"]()}finally{if(j)throw k}}h(b)},_selectTransitions:function(a,b){var c=this.opts.transitionSelector,d=new this.opts.Set,f=this._evaluateAction.bind(this,a),g=this._configuration.iter().sort(e),h=!0,i=!1,j=void 0;try{for(var k,l=g[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value,n=!0,o=!1,p=void 0;try{a:for(var q,r=[m].concat(C.getAncestors(m))[Symbol.iterator]();!(n=(q=r.next()).done);n=!0){var s=q.value,t=!0,u=!1,v=void 0;try{for(var w,x=s.transitions[Symbol.iterator]();!(t=(w=x.next()).done);t=!0){var y=w.value;if(c(y,a,f,b)){d.add(y);break a}}}catch(z){u=!0,v=z}finally{try{!t&&x["return"]&&x["return"]()}finally{if(u)throw v}}}}catch(z){o=!0,p=z}finally{try{!n&&r["return"]&&r["return"]()}finally{if(o)throw p}}}}catch(z){i=!0,j=z}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}var A=this._removeConflictingTransition(d);return this._log("priorityEnabledTransitions",A),A},_computeExitSet:function(a){var b=new Set,c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;if(h.targets){var i=h.scope,j=!0,k=!1,l=void 0;try{for(var m,n=this._getFullConfiguration()[Symbol.iterator]();!(j=(m=n.next()).done);j=!0){var o=m.value;C.isDescendant(o,i)&&b.add(o)}}catch(p){k=!0,l=p}finally{try{!j&&n["return"]&&n["return"]()}finally{if(k)throw l}}}}}catch(p){d=!0,e=p}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return b},_removeConflictingTransition:function(a){var b=this,d=new this.opts.Set,e=!0,f=!1,g=void 0;try{for(var h,i=a.iter()[Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value,k=!1,l=new Set,m=!0,n=!1,o=void 0;try{for(var p,q=function(){var a=p.value,d=b._computeExitSet([j]),e=b._computeExitSet([a]),f=[].concat(c(d)).some(function(a){return e.has(a)})||[].concat(c(e)).some(function(a){return d.has(a)});if(b._log("t1ExitSet",j.source.id,[].concat(c(d)).map(function(a){return a.id})),b._log("t2ExitSet",a.source.id,[].concat(c(e)).map(function(a){return a.id})),b._log("hasIntersection",f),f){if(!(a.source.descendants.indexOf(j.source)>-1))return k=!0,"break";l.add(a)}},r=d.iter()[Symbol.iterator]();!(m=(p=r.next()).done);m=!0){var s=q();if("break"===s)break}}catch(t){n=!0,o=t}finally{try{!m&&r["return"]&&r["return"]()}finally{if(n)throw o}}if(!k){var u=!0,v=!1,w=void 0;try{for(var x,y=l[Symbol.iterator]();!(u=(x=y.next()).done);u=!0){var z=x.value;d.remove(z)}}catch(t){v=!0,w=t}finally{try{!u&&y["return"]&&y["return"]()}finally{if(v)throw w}}d.add(j)}}}catch(t){f=!0,g=t}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}return d},_log:function(){if(D){var a=Array.from(arguments);this.opts.console.log(a[0]+": "+a.slice(1).map(function(a){return null===a?"null":void 0===a?"undefined":"string"==typeof a?a:"[object Object]"===a.toString()?b.inspect(a):a.toString()}).join(", ")+"\n")}},registerListener:function(a){r.EVENTS.forEach(function(b){a[b]&&this.on(b,a[b])},this)},unregisterListener:function(a){r.EVENTS.forEach(function(b){a[b]&&this.off(b,a[b])},this)},getAllTransitionEvents:function(){function a(c){if(c.transitions)for(var d=0,e=c.transitions.length;d<e;d++)b[c.transitions[d].event]=!0;if(c.states)for(var f=0,g=c.states.length;f<g;f++)a(c.states[f])}var b={};return a(this._model),Object.keys(b)},getSnapshot:function(){return[this.getConfiguration(),this._serializeHistory(),this._isInFinalState,this._model.$serializeDatamodel(),this._internalEventQueue.slice()]},_serializeHistory:function(){var a={};return Object.keys(this._historyValue).forEach(function(b){a[b]=this._historyValue[b].map(function(a){return a.id})},this),a}}),s.prototype=t(r.prototype),s.prototype.gen=function(a,b){var c;switch("undefined"==typeof a?"undefined":x(a)){case"string":c={name:a,data:b};break;case"object":if("string"!=typeof a.name)throw new Error('Event object must have "name" property of type string.');c=a;break;default:throw new Error("First argument to gen must be a string or object.")}if(this._isStepping)throw new Error("Cannot call gen during a big-step");return this._isStepping=!0,this._performBigStep(c),this._isStepping=!1,this.getConfiguration()},s.prototype.genAsync=function(a,b){function c(a,b){this._performBigStepAsync(a,function(a,d){b(a,d),this._externalEventQueue.length?c.apply(this,this._externalEventQueue.shift()):this._isStepping=!1}.bind(this))}if(null!==a&&("object"!==("undefined"==typeof a?"undefined":x(a))||!a||"string"!=typeof a.name))throw new Error("Expected currentEvent to be null or an Object with a name");"function"!=typeof b&&(b=u),this._externalEventQueue.push([a,b]),this._isStepping||(this._isStepping=!0,c.apply(this,this._externalEventQueue.shift()))};var E=/(#_.*)|\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i;v.prototype={invokeSendTargetRegex:/^#_(.*)$/,scxmlSendTargetRegex:/^#_scxml_(.*)$/,raise:function(a){this._installDefaultPropsOnEvent(a,!0),this._interpreter._internalEventQueue.push(a)},parseXmlStringAsDOM:function(a){return(this._interpreter.opts.xmlParser||v.xmlParser).parse(a)},invoke:function(a){var b=this;this._invokeMap[a.id]=new Promise(function(c,d){(b._interpreter.opts.invokers||v.invokers)[a.type](b._interpreter,a,function(a,e){return a?d(a):(b._interpreter.emit("onInvokedSessionInitialized",e),void c(e))})})},cancelInvoke:function(a){var b=this,c=this._invokeMap[a];this._interpreter._log("cancelling session with invokeid "+a),c&&(this._interpreter._log("sessionPromise found"),c.then(function(c){b._interpreter._log("resolved session "+a+". cancelling... "),c.cancel(),delete b._invokeMap[a]},function(a){}))},_installDefaultPropsOnEvent:function(a,b){b||(a.origin=this._interpreter.opts._x._ioprocessors.scxml.location,a.origintype=a.type||A),"undefined"==typeof a.type&&(a.type=b?"internal":"external"),["name","sendid","invokeid","data","origin","origintype"].forEach(function(b){"undefined"==typeof a[b]&&(a[b]=void 0)})},send:function(a,b){function c(a,b,c){if(a.target){var d=E.test(a.target);if(!d)throw{name:"error.execution",data:"Target is not valid URI",sendid:a.sendid,type:"platform"}}if(g!==A)throw{name:"error.execution",data:"Unsupported event processor type",sendid:a.sendid,type:"platform"};c.call(this,a,b)}function d(a,b){function c(c){var d=setTimeout(function(){a.sendid&&delete this._timeoutMap[a.sendid],this._timeouts["delete"](e),this._interpreter.opts.doSend?this._interpreter.opts.doSend(c,a):c[this._interpreter.opts.sendAsync?"genAsync":"gen"](a)}.bind(this),b.delay||0),e={sendOptions:b,timeoutHandle:d};a.sendid&&(this._timeoutMap[a.sendid]=d),this._timeouts.add(e)}var d=this;if("undefined"==typeof setTimeout)throw new Error("Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.");var e;if("#_internal"===a.target)this.raise(a);else if(this._installDefaultPropsOnEvent(a,!1),a.origintype=A,a.target)if("#_parent"===a.target){if(!this._interpreter.opts.parentSession)throw{name:"error.communication",data:"Parent session not specified",sendid:a.sendid,type:"platform"};a.invokeid=this._interpreter.opts.invokeid,c.call(this,this._interpreter.opts.parentSession)}else if(e=a.target.match(this.scxmlSendTargetRegex)){var f=e[1],g=this._interpreter.opts.sessionRegistry.get(f);if(!g)throw{
name:"error.communication",sendid:a.sendid,type:"platform"};c.call(this,g)}else{if(!(e=a.target.match(this.invokeSendTargetRegex)))throw new Error("Unrecognized send target.");var h=e[1];this._invokeMap[h].then(function(a){c.call(d,a)})}else c.call(this,this._interpreter)}function e(){this._interpreter.emit(a.name,a.data)}this._interpreter._log("send event",a,b),b=b||{};var f,g=b.type||A;f="https://github.com/jbeard4/SCION#publish"===a.type?e:this._interpreter.opts.customSend?this._interpreter.opts.customSend:d,b=b||{},this._interpreter._log("sending event",a.name,"with content",a.data,"after delay",b.delay),c.call(this,a,b,f)},cancel:function(a){if(this._interpreter.opts.customCancel)return this._interpreter.opts.customCancel.apply(this,[a]);if("undefined"==typeof clearTimeout)throw new Error("Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.");a in this._timeoutMap&&(this._interpreter._log("cancelling ",a," with timeout id ",this._timeoutMap[a]),clearTimeout(this._timeoutMap[a]))}},a.exports=y(new g,{BaseInterpreter:r,Statechart:s,ArraySet:h,STATE_TYPES:z,initializeModel:f,InterpreterScriptingContext:v})});