/*! scion-core 2017-07-28 */
!function(a,b){if("function"==typeof define&&define.amd)define(["module","util"],b);else if("undefined"!=typeof exports)b(module,require("util"));else{var c={exports:{}};b(c,a.util),a.scion=c.exports}}(this,function(a,b){"use strict";function c(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function d(a){return a.targets}function e(a,b){return a.documentOrder-b.documentOrder}function f(a){function b(a){void 0===o[a]&&(o[a]=0);var b=o[a]++;return"$generated-"+a+"-"+b}function c(a){return{$deserializeDatamodel:a.$deserializeDatamodel||function(){},$serializeDatamodel:a.$serializeDatamodel||function(){return null},$idToStateMap:m,states:[{$type:"initial",transitions:[{target:a}]},a]}}function d(a){return a+" -- "+(this.events?"("+this.events.join(",")+")":null)+(this.cond?"["+this.cond.name+"]":"")+" --> "+(this.targets?this.targets.join(","):null)}function e(){return this.id}function f(a,c){if(D&&(c.toString=e),c.transitions&&l.push.apply(l,c.transitions),c.id){if(m.has(c.id))throw new Error("Redefinition of state id "+c.id);m.set(c.id,c)}c.$type=c.$type||"state",c.ancestors=a,c.depth=a.length,c.parent=a[0],c.documentOrder=n++,c.transitions=c.transitions||[];for(var h=0,i=c.transitions.length;h<i;h++){var j=c.transitions[h];j.documentOrder=n++,j.source=c,D&&(j.toString=d.bind(j,c))}if(c.states)for(var k=[c].concat(a),h=0,i=c.states.length;h<i;h++)f(k,c.states[h]);switch(c.$type){case"parallel":c.typeEnum=z.PARALLEL,c.isAtomic=!1;break;case"initial":c.typeEnum=z.INITIAL,c.isAtomic=!0;break;case"history":c.typeEnum=z.HISTORY,c.isAtomic=!0;break;case"final":c.typeEnum=z.FINAL,c.isAtomic=!0;break;case"state":case"scxml":c.states&&c.states.length?(c.typeEnum=z.COMPOSITE,c.isAtomic=!1):(c.typeEnum=z.BASIC,c.isAtomic=!0);break;default:throw new Error("Unknown state type: "+c.$type)}c.states?c.descendants=c.states.concat(c.states.map(function(a){return a.descendants}).reduce(function(a,b){return a.concat(b)},[])):c.descendants=[];var o;if(c.typeEnum===z.COMPOSITE&&(Array.isArray(c.initial)||"string"==typeof c.initial?p.push(c):(o=c.states.filter(function(a){return"initial"===a.$type}),c.initialRef=[o.length?o[0]:c.states[0]],g(c))),c.typeEnum===z.COMPOSITE||c.typeEnum===z.PARALLEL){var q=c.states.filter(function(a){return"history"===a.$type});c.historyRef=q}c.id||(c.id=b(c.$type),m.set(c.id,c)),["onEntry","onExit"].forEach(function(a){c[a]&&(Array.isArray(c[a])||(c[a]=[c[a]]),c[a].every(function(a){return Array.isArray(a)})||(c[a]=[c[a]]))}),c.invokes&&!Array.isArray(c.invokes)&&(c.invokes=[c.invokes],c.invokes.forEach(function(a){a.finalize&&!Array.isArray(a.finalize)&&(a.finalize=[a.finalize])}))}function g(a){if(!a.initialRef)throw new Error("Unable to locate initial state for composite state: "+a.id)}function h(){for(var a=0,b=p.length;a<b;a++){var c=p[a],d=Array.isArray(c.initial)?c.initial:[c.initial];c.initialRef=d.map(function(a){return m.get(a)}),g(c)}}function i(){for(var a=0,b=l.length;a<b;a++){var c=l[a];if(c.onTransition&&!Array.isArray(c.onTransition)&&(c.onTransition=[c.onTransition]),"string"==typeof c.event&&(c.events=c.event.trim().split(q)),delete c.event,!c.targets&&"undefined"!=typeof c.target)if("string"==typeof c.target){var d=m.get(c.target);if(!d)throw new Error("Unable to find target state with id "+c.target);c.target=d,c.targets=[c.target]}else if(Array.isArray(c.target))c.targets=c.target.map(function(a){if("string"==typeof a){if(a=m.get(a),!a)throw new Error("Unable to find target state with id "+c.target);return a}return a});else{if("object"!==x(c.target))throw new Error("Transition target has unknown type: "+c.target);c.targets=[c.target]}}for(var a=0,b=l.length;a<b;a++){var c=l[a];c.targets&&(c.lcca=k(c.source,c.targets[0])),c.scope=j(c)}}function j(a){var b="internal"===a.type&&a.source.typeEnum===z.COMPOSITE&&a.source.parent&&a.targets&&a.targets.every(function(b){return a.source.descendants.indexOf(b)>-1});return a.targets?b?a.source:a.lcca:null}function k(a,b){for(var c=[],d=0,e=a.ancestors.length;d<e;d++){var f=a.ancestors[d];f.typeEnum===z.COMPOSITE&&f.descendants.indexOf(b)>-1&&c.push(f)}if(!c.length)throw new Error("Could not find LCA for states.");return c[0]}var l=[],m=new Map,n=0,o={},p=[],q=/\s+/,r=c(a);return f([],r),i(),h(),r}function g(){this._listeners={},this._listeners["*"]=[]}function h(a){a=a||[],this.o=new Set(a)}function i(a,b){return a=a.replace(B,""),a===b||!(a.length>b.length)&&("."===b.charAt(a.length)&&0===b.indexOf(a))}function j(a,b){return a.events.some(function(a){return"*"===a||i(a,b)})}function k(a,b,c,d){return(d?!a.events:a.events&&b&&b.name&&j(a,b.name))&&(!a.cond||c(a.cond))}function l(a){var b=a[0],c=a[1];n(b.source,c.source);return b.source.depth<c.source.depth?c:c.source.depth<b.source.depth?b:b.documentOrder<c.documentOrder?b:c}function m(a,b){return n(a,b)*-1}function n(a,b){return a.depth>b.depth?-1:a.depth<b.depth?1:a.documentOrder<b.documentOrder?1:a.documentOrder>b.documentOrder?-1:0}function o(a,b,c){return a.call(c,b._x,b._x._sessionid,b._x._ioprocessors,c.isIn.bind(c))}function p(a,b){return a.map(function(a){var c=b.get(a);if(!c)throw new Error("Error loading serialized configuration. Unable to locate state with id "+a);return c})}function q(a,b){var c={};return Object.keys(a).forEach(function(d){c[d]=a[d].map(function(a){var c=b.get(a);if(!c)throw new Error("Error loading serialized history. Unable to locate state with id "+a);return c})}),c}function r(a,b){g.call(this),this._scriptingContext=b.interpreterScriptingContext||(b.InterpreterScriptingContext?new b.InterpreterScriptingContext(this):{}),this.opts=b||{},this.opts.generateSessionid=this.opts.generateSessionid||r.generateSessionid,this.opts.sessionid=this.opts.sessionid||this.opts.generateSessionid(),this.opts.sessionRegistry=this.opts.sessionRegistry||r.sessionRegistry;var c={};c[A]={location:"#_scxml_"+this.opts.sessionid},c.scxml=c[A],b._x={_sessionid:b.sessionid,_ioprocessors:c};var d;if("function"==typeof a)d=o(a,b,this);else{if("object"!==("undefined"==typeof a?"undefined":x(a)))throw new Error("Unexpected model type. Expected model factory function, or scjson object.");d=JSON.parse(JSON.stringify(a))}this._model=f(d),this.opts.console=b.console||("undefined"==typeof console?{log:function(){}}:console),this.opts.Set=this.opts.Set||h,this.opts.priorityComparisonFn=this.opts.priorityComparisonFn||l,this.opts.transitionSelector=this.opts.transitionSelector||k,this.opts.sessionRegistry.set(String(this.opts.sessionid),this),this._scriptingContext.log=this._scriptingContext.log||function(){this.opts.console.log.apply?this.opts.console.log.apply(this.opts.console,arguments):this.opts.console.log(Array.prototype.slice.apply(arguments).join(","))}.bind(this),this._externalEventQueue=[],this._internalEventQueue=[],b.params&&this._model.$deserializeDatamodel(b.params),b.snapshot?(this._configuration=new this.opts.Set(p(b.snapshot[0],this._model.$idToStateMap)),this._historyValue=q(b.snapshot[1],this._model.$idToStateMap),this._isInFinalState=b.snapshot[2],this._model.$deserializeDatamodel(b.snapshot[3])):(this._configuration=new this.opts.Set,this._historyValue={},this._isInFinalState=!1),r.EVENTS.forEach(function(a){this.on(a,this._log.bind(this,a))},this)}function s(a,b){b=b||{},b.InterpreterScriptingContext=b.InterpreterScriptingContext||v,this._isStepping=!1,r.call(this,a,b)}function t(a){function b(){}return b.prototype=a,new b}function u(){}function v(a){this._interpreter=a,this._timeoutMap={},this._invokeMap={},this._timeouts=new Set}var w=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},y=Object.assign||function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},z={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5},A="http://www.w3.org/TR/scxml/#SCXMLEventProcessor";g.prototype.on=function(a,b){return Array.isArray(this._listeners[a])||(this._listeners[a]=[]),this._listeners[a].indexOf(b)===-1&&this._listeners[a].push(b),this},g.prototype.once=function(a,b){function c(){for(var e=[],f=0;f<arguments.length;f+=1)e[f]=arguments[f];d.off(a,c),b.apply(d,e)}var d=this;return c.listener=b,this.on(a,c)},g.prototype.off=function(a,b){if(!Array.isArray(this._listeners[a]))return this;if("undefined"==typeof b)return this._listeners[a]=[],this;var c=this._listeners[a].indexOf(b);if(c===-1)for(var d=0;d<this._listeners[a].length;d+=1)if(this._listeners[a][d].listener===b){c=d;break}return this._listeners[a].splice(c,1),this},g.prototype.emit=function(a){var b,c,d=Array.prototype.slice.call(arguments),e=d.slice(1),f=this._listeners[a];if(Array.isArray(f))for(b=0,c=f.length;b<c;b++)f[b].apply(this,e);for(f=this._listeners["*"],b=0,c=f.length;b<c;b++)f[b].apply(this,d);return this},h.prototype={add:function(a){this.o.add(a)},remove:function(a){return this.o["delete"](a)},union:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;this.o.add(g)}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return this},difference:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=a.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;this.o["delete"](g)}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return this},contains:function(a){return this.o.has(a)},iter:function(){return Array.from(this.o)},isEmpty:function(){return!this.o.size},size:function(){return this.o.size},equals:function(a){if(this.o.size!==a.size())return!1;var b=!0,c=!1,d=void 0;try{for(var e,f=this.o[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;if(!a.contains(g))return!1}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return!0},toString:function(){return 0===this.o.size?"<empty>":Array.from(this.o).join(",\n")}};var B=/\.\*$/,C={isDescendant:function(a,b){return b.descendants.indexOf(a)>-1},getAncestors:function(a,b){var c;return null===b?[]:(c=a.ancestors.indexOf(b),c>-1?a.ancestors.slice(0,c):a.ancestors)},getAncestorsOrSelf:function(a,b){return[a].concat(this.getAncestors(a,b))},getDescendantsOrSelf:function(a){return[a].concat(a.descendants)},isOrthogonalTo:function(a,b){return null===a||null===b||!this.isAncestrallyRelatedTo(a,b)&&this.getLCA(a,b).typeEnum===z.PARALLEL},isAncestrallyRelatedTo:function(a,b){return this.getAncestorsOrSelf(b).indexOf(a)>-1||this.getAncestorsOrSelf(a).indexOf(b)>-1},getLCA:function(a,b){var c=this.getAncestors(a).filter(function(a){return a.descendants.indexOf(b)>-1},this);return c[0]}},D=!!process.env.DEBUG;r.EVENTS=["onEntry","onExit","onTransition","onError","onBigStepBegin","onBigStepSuspend","onBigStepResume","onSmallStepBegin","onSmallStepEnd","onBigStepEnd"],r.sessionIdCounter=1,r.generateSessionid=function(){return r.sessionIdCounter++},r.sessionRegistry=new Map,r.prototype=y(t(g.prototype),{cancel:function(){delete this.opts.parentSession,this._isInFinalState||(this._isInFinalState=!0,this._log("session cancelled "+this.opts.invokeid),this._exitInterpreter())},_exitInterpreter:function(){var a=this;this._cancelAllDelayedSends();for(var b=this._configuration.iter().map(function(a){return[a].concat(C.getAncestors(a))},this).reduce(function(a,b){return a.concat(b)},[]).reduce(function(a,b){return a.indexOf(b)>-1?a:a.concat(b)},[]).sort(n),c=0,d=b.length;c<d;c++){var e=b[c];if(void 0!==e.onExit)for(var f=0,g=e.onExit.length;f<g;f++)for(var h=e.onExit[f],i=0,j=h.length;i<j;i++){var k=h[i];try{k.call(this._scriptingContext,null)}catch(l){this._handleError(l,k);break}}e.invokes&&e.invokes.forEach(function(b){a._scriptingContext.cancelInvoke(b.id)}),this.opts.parentSession&&"final"===e.$type&&"scxml"===e.parent.$type&&(this._scriptingContext.send({target:"#_parent",name:"done.invoke."+this.opts.invokeid}),this.opts.sessionRegistry["delete"](this.opts.sessionid))}},start:function(){return this._initStart(),this._performBigStep(),this.getConfiguration()},startAsync:function(a){a=this._initStart(a),this.genAsync(null,a)},_initStart:function(a){var b=this;return"function"!=typeof a&&(a=u),this._log("performing initial big step"),this._model.initialRef.forEach(function(a){return b._configuration.add(a)}),a},getConfiguration:function(){return this._configuration.iter().map(function(a){return a.id})},getFullConfiguration:function(){return this._configuration.iter().map(function(a){return[a].concat(C.getAncestors(a))},this).reduce(function(a,b){return a.concat(b)},[]).map(function(a){return a.id}).reduce(function(a,b){return a.indexOf(b)>-1?a:a.concat(b)},[])},isIn:function(a){return this.getFullConfiguration().indexOf(a)>-1},isFinal:function(a){return this._isInFinalState},_performBigStep:function(a){var b=void 0,c=void 0,d=void 0,e=void 0,f=this._startBigStep(a),g=w(f,4);for(d=g[0],e=g[1],c=g[2],b=g[3];c;){var h=this._selectTransitionsAndPerformSmallStep(b,e,d),i=w(h,2);b=i[0],c=i[1]}this._finishBigStep(e,d)},_selectTransitionsAndPerformSmallStep:function(a,b,c){var d=this._selectTransitions(a,!0);d.isEmpty()&&(a=this._internalEventQueue.shift()||null,d=this._selectTransitions(a,!1)),this.emit("onSmallStepBegin",a);var e=void 0,f=void 0,g=this._performSmallStep(a,d),h=w(g,2);e=h[0],f=h[1],e&&e.forEach(function(a){return c.add(a)}),f&&f.forEach(function(a){return b.add(a)}),this.emit("onSmallStepEnd",a);var i=!d.isEmpty()||this._internalEventQueue.length;return[a,i]},_startBigStep:function(a){var b=this;this.emit("onBigStepBegin"),this._configuration.iter().forEach(function(c){c.invokes&&c.invokes.forEach(function(c){c.autoforward&&b._scriptingContext.send({target:"#_"+c.id,name:a.name,data:a.data}),c.id===a.invokeid&&c.finalize&&c.finalize.forEach(function(c){return b._evaluateAction(a,c)})})}),a&&this._internalEventQueue.push(a);var c=new Set,d=new Set,e=!0,f=null;return[d,c,e,f]},_finishBigStep:function(a,b,d){var e=this,f=Array.from(new Set([].concat(c(a)).filter(function(a){return a.invokes&&!b.has(a)}))).sort(m);f.forEach(function(a){a.invokes.forEach(function(a){return e._evaluateAction(null,a)})}),b.forEach(function(a){a.invokes&&a.invokes.forEach(function(a){e._scriptingContext.cancelInvoke(a.id)})}),this._isInFinalState=this._configuration.iter().every(function(a){return a.typeEnum===z.FINAL}),this._isInFinalState&&this._exitInterpreter(),this.emit("onBigStepEnd"),d&&d(void 0,this.getConfiguration())},_cancelAllDelayedSends:function(){var a=!0,b=!1,c=void 0;try{for(var d,e=this._scriptingContext._timeouts[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value;f.sendOptions.delay&&(this._log("cancelling delayed send",f),clearTimeout(f.timeoutHandle),this._scriptingContext._timeouts["delete"](f))}}catch(g){b=!0,c=g}finally{try{!a&&e["return"]&&e["return"]()}finally{if(b)throw c}}Object.keys(this._scriptingContext._timeoutMap).forEach(function(a){delete this._scriptingContext._timeoutMap[a]},this)},_performBigStepAsync:function(a,b){function c(a){this.emit(a);var h=this._selectTransitionsAndPerformSmallStep(d,g,f),i=w(h,2);d=i[0],e=i[1],e?(this.emit("onBigStepSuspend"),setImmediate(c.bind(this),"onBigStepResume")):this._finishBigStep(g,f,b)}var d=void 0,e=void 0,f=void 0,g=void 0,h=this._startBigStep(a),i=w(h,4);f=i[0],g=i[1],e=i[2],d=i[3],c.call(this,"onBigStepBegin")},_performSmallStep:function(a,b){var c=this;if(this._log("selecting transitions with currentEvent",a),this._log("selected transitions",b),!b.isEmpty()){this._log("sorted transitions",b);var f=new this.opts.Set(b.iter().filter(d)),g=this._getStatesExited(f),h=g[0],i=g[1],j=this._getStatesEntered(f);this._log("basicStatesExited ",h),this._log("statesExited ",i),this._log("statesEntered ",j);var k=new this.opts.Set;this._log("executing state exit actions");for(var l=0,m=i.length;l<m;l++){var n=i[l];if(n.isAtomic&&this._configuration.remove(n),this._log("exiting ",n.id),this.emit("onExit",n.id),void 0!==n.onExit)for(var o=0,p=n.onExit.length;o<p;o++)for(var q=n.onExit[o],r=0,s=q.length;r<s;r++){var t=q[r];try{t.call(this._scriptingContext,a)}catch(u){this._handleError(u,t);break}}var v;if(n.historyRef){var w=!0,x=!1,y=void 0;try{for(var A,B=n.historyRef[Symbol.iterator]();!(w=(A=B.next()).done);w=!0){var C=A.value;v=C.isDeep?function(a){return a.typeEnum===z.BASIC&&n.descendants.indexOf(a)>-1}:function(a){return a.parent===n},this._historyValue[C.id]=i.filter(v)}}catch(D){x=!0,y=D}finally{try{!w&&B["return"]&&B["return"]()}finally{if(x)throw y}}}}var E=b.iter().sort(e);this._log("executing transitition actions");for(var F=0,m=E.length;F<m;F++){var G=E[F],H=G.targets&&G.targets.map(function(a){return a.id});if(this.emit("onTransition",G.source.id,H,G.source.transitions.indexOf(G)),void 0!==G.onTransition)for(var I=0,J=G.onTransition.length;I<J;I++){var K=G.onTransition[I];try{K.call(this._scriptingContext,a)}catch(u){this._handleError(u,K);break}}}this._log("executing state enter actions");for(var L=0,M=j.length;L<M;L++){var N=j[L];if(N.isAtomic&&this._configuration.add(N),this._log("entering",N.id),this.emit("onEntry",N.id),void 0!==N.onEntry)for(var O=0,P=N.onEntry.length;O<P;O++)for(var Q=N.onEntry[O],R=0,S=Q.length;R<S;R++){var T=Q[R];try{T.call(this._scriptingContext,a)}catch(u){this._handleError(u,T);break}}}for(var L=0,M=j.length;L<M;L++){var N=j[L];if(N.typeEnum===z.FINAL){var U=N.parent,V=U.parent;this._internalEventQueue.push({name:"done.state."+U.id,data:N.donedata}),V&&V.typeEnum===z.PARALLEL&&V.states.every(function(a){return c.isInFinalState(a)})&&this._internalEventQueue.push({name:"done.state."+V.id})}}this._log("new configuration ",this._configuration),k.isEmpty()||(this._log("adding triggered events to inner queue ",k),this._internalEventQueue.push(k))}return[i,j]},isInFinalState:function(a){var b=this;return a.typeEnum===z.COMPOSITE?a.states.some(function(a){return a.typeEnum===z.FINAL&&b._configuration.contains(a)}):a.typeEnum===z.PARALLEL&&a.states.every(this.isInFinalState.bind(this))},_evaluateAction:function(a,b){try{return b.call(this._scriptingContext,a)}catch(c){this._handleError(c,b)}},_handleError:function(a,b){var c=a instanceof Error||"Error"===a.__proto__.name?{name:"error.execution",data:{tagname:b.tagname,line:b.line,column:b.column,reason:a.message},type:"platform"}:a.name?a:{name:"error.execution",data:a,type:"platform"};this._internalEventQueue.push(c),this.emit("onError",c)},_getStatesExited:function(a){for(var b=new this.opts.Set,c=new this.opts.Set,d=a.iter(),e=0,f=d.length;e<f;e++)for(var g=d[e],h=g.scope,i=h.descendants,j=this._configuration.iter(),k=0,l=j.length;k<l;k++){var m=j[k];if(i.indexOf(m)>-1){c.add(m),b.add(m);for(var o=C.getAncestors(m,h),p=0,q=o.length;p<q;p++)b.add(o[p])}}var r=b.iter().sort(n);return[c,r]},_getStatesEntered:function(a){var b=new Set;return this._computeEntrySet(a,b),[].concat(c(b)).sort(m)},_computeEntrySet:function(a,b){var c=!0,d=!1,e=void 0;try{for(var f,g=a.iter()[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=!0,j=!1,k=void 0;try{for(var l,m=h.targets[Symbol.iterator]();!(i=(l=m.next()).done);i=!0){var n=l.value;this._addDescendantStatesToEnter(n,b)}}catch(o){j=!0,k=o}finally{try{!i&&m["return"]&&m["return"]()}finally{if(j)throw k}}var p=h.scope,q=!0,r=!1,s=void 0;try{for(var t,u=this._getEffectiveTargetStates(h)[Symbol.iterator]();!(q=(t=u.next()).done);q=!0){var v=t.value;this._addAncestorStatesToEnter(v,p,b)}}catch(o){r=!0,s=o}finally{try{!q&&u["return"]&&u["return"]()}finally{if(r)throw s}}}}catch(o){d=!0,e=o}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}},_getEffectiveTargetStates:function(a){var b=new Set,d=!0,e=!1,f=void 0;try{for(var g,h=a.targets[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value;i.typeEnum===z.HISTORY?i.id in this._historyValue?this._historyValue[i.id].forEach(function(a){return b.add(a)}):[].concat(c(this._getEffectiveTargetStates(i.transitions[0]))).forEach(function(a){return b.add(a)}):b.add(i)}}catch(j){e=!0,f=j}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return b},_addDescendantStatesToEnter:function(a,b){var d=this;if(a.typeEnum===z.HISTORY)if(this._historyValue[a.id]){var e=!0,f=!1,g=void 0;try{for(var h,i=this._historyValue[a.id][Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value;this._addDescendantStatesToEnter(j,b)}}catch(k){f=!0,g=k}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}var l=!0,m=!1,n=void 0;try{for(var o,p=this._historyValue[a.id][Symbol.iterator]();!(l=(o=p.next()).done);l=!0){var q=o.value;this._addAncestorStatesToEnter(q,a.parent,b)}}catch(k){m=!0,n=k}finally{try{!l&&p["return"]&&p["return"]()}finally{if(m)throw n}}}else b.add(a);else if(b.add(a),a.typeEnum===z.COMPOSITE){var r=!0,s=!1,t=void 0;try{for(var u,v=a.initialRef[Symbol.iterator]();!(r=(u=v.next()).done);r=!0){var w=u.value;this._addDescendantStatesToEnter(w,b)}}catch(k){s=!0,t=k}finally{try{!r&&v["return"]&&v["return"]()}finally{if(s)throw t}}var x=!0,y=!1,A=void 0;try{for(var B,D=a.initialRef[Symbol.iterator]();!(x=(B=D.next()).done);x=!0){var E=B.value;this._addAncestorStatesToEnter(E,a,b)}}catch(k){y=!0,A=k}finally{try{!x&&D["return"]&&D["return"]()}finally{if(y)throw A}}}else if(a.typeEnum===z.PARALLEL){var F=!0,G=!1,H=void 0;try{for(var I,J=function(){var a=I.value;[].concat(c(b)).some(function(b){return C.isDescendant(b,a)})||d._addDescendantStatesToEnter(a,b)},K=a.states[Symbol.iterator]();!(F=(I=K.next()).done);F=!0)J()}catch(k){G=!0,H=k}finally{try{!F&&K["return"]&&K["return"]()}finally{if(G)throw H}}}},_addAncestorStatesToEnter:function(a,b,d){var e=this,f=!0,g=!1,h=void 0;try{for(var i,j=C.getAncestors(a,b)[Symbol.iterator]();!(f=(i=j.next()).done);f=!0){var k=i.value;if(d.add(k),k.typeEnum===z.PARALLEL){var l=!0,m=!1,n=void 0;try{for(var o,p=function(){var a=o.value;[].concat(c(d)).some(function(b){return C.isDescendant(b,a)})||e._addDescendantStatesToEnter(a,d)},q=k.states[Symbol.iterator]();!(l=(o=q.next()).done);l=!0)p()}catch(r){m=!0,n=r}finally{try{!l&&q["return"]&&q["return"]()}finally{if(m)throw n}}}}}catch(r){g=!0,h=r}finally{try{!f&&j["return"]&&j["return"]()}finally{if(g)throw h}}},_selectTransitions:function(a,b){var c=this.opts.transitionSelector,d=new this.opts.Set,f=this._evaluateAction.bind(this,a),g=this._configuration.iter().sort(e),h=!0,i=!1,j=void 0;try{for(var k,l=g[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value,n=!0,o=!1,p=void 0;try{a:for(var q,r=[m].concat(C.getAncestors(m))[Symbol.iterator]();!(n=(q=r.next()).done);n=!0){var s=q.value,t=!0,u=!1,v=void 0;try{for(var w,x=s.transitions[Symbol.iterator]();!(t=(w=x.next()).done);t=!0){var y=w.value;if(c(y,a,f,b)){d.add(y);break a}}}catch(z){u=!0,v=z}finally{try{!t&&x["return"]&&x["return"]()}finally{if(u)throw v}}}}catch(z){o=!0,p=z}finally{try{!n&&r["return"]&&r["return"]()}finally{if(o)throw p}}}}catch(z){i=!0,j=z}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}var A=this._removeConflictingTransition(d);return this._log("priorityEnabledTransitions",A),A},_removeConflictingTransition:function(a){var b=new this.opts.Set,c=!0,d=!1,e=void 0;try{for(var f,g=a.iter()[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=!1,j=new Set,k=!0,l=!1,m=void 0;try{for(var n,o=function(){var a=n.value,b=C.getAncestors(h.source,h.scope),c=C.getAncestors(a.source,a.scope),d=b.some(function(a){return c.indexOf(a)>-1});if(d){if(!(a.source.descendants.indexOf(h.source)>-1))return i=!0,"break";j.add(a)}},p=b.iter()[Symbol.iterator]();!(k=(n=p.next()).done);k=!0){var q=o();if("break"===q)break}}catch(r){l=!0,m=r}finally{try{!k&&p["return"]&&p["return"]()}finally{if(l)throw m}}if(!i){var s=!0,t=!1,u=void 0;try{for(var v,w=j[Symbol.iterator]();!(s=(v=w.next()).done);s=!0){var x=v.value;b.remove(x)}}catch(r){t=!0,u=r}finally{try{!s&&w["return"]&&w["return"]()}finally{if(t)throw u}}b.add(h)}}}catch(r){d=!0,e=r}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return b},_log:function(){if(D){var a=Array.from(arguments);this.opts.console.log(a[0]+": "+a.slice(1).map(function(a){return null===a?"null":void 0===a?"undefined":"string"==typeof a?a:"[object Object]"===a.toString()?b.inspect(a):a.toString()}).join(", ")+"\n")}},registerListener:function(a){r.EVENTS.forEach(function(b){a[b]&&this.on(b,a[b])},this)},unregisterListener:function(a){r.EVENTS.forEach(function(b){a[b]&&this.off(b,a[b])},this)},getAllTransitionEvents:function(){function a(c){if(c.transitions)for(var d=0,e=c.transitions.length;d<e;d++)b[c.transitions[d].event]=!0;if(c.states)for(var f=0,g=c.states.length;f<g;f++)a(c.states[f])}var b={};return a(this._model),Object.keys(b)},getSnapshot:function(){if(this._isStepping)throw new Error("getSnapshot cannot be called while interpreter is executing a big-step");return[this.getConfiguration(),this._serializeHistory(),this._isInFinalState,this._model.$serializeDatamodel()]},_serializeHistory:function(){var a={};return Object.keys(this._historyValue).forEach(function(b){a[b]=this._historyValue[b].map(function(a){return a.id})},this),a}}),s.prototype=t(r.prototype),s.prototype.gen=function(a,b){var c;switch("undefined"==typeof a?"undefined":x(a)){case"string":c={name:a,data:b};break;case"object":if("string"!=typeof a.name)throw new Error('Event object must have "name" property of type string.');c=a;break;default:throw new Error("First argument to gen must be a string or object.")}if(this._isStepping)throw new Error("Cannot call gen during a big-step");return this._isStepping=!0,this._performBigStep(c),this._isStepping=!1,this.getConfiguration()},s.prototype.genAsync=function(a,b){function c(a,b){this._performBigStepAsync(a,function(a,d){b(a,d),this._externalEventQueue.length?c.apply(this,this._externalEventQueue.shift()):this._isStepping=!1}.bind(this))}if(null!==a&&("object"!==("undefined"==typeof a?"undefined":x(a))||!a||"string"!=typeof a.name))throw new Error("Expected currentEvent to be null or an Object with a name");"function"!=typeof b&&(b=u),this._externalEventQueue.push([a,b]),this._isStepping||(this._isStepping=!0,c.apply(this,this._externalEventQueue.shift()))};var E=/(#_.*)|\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i;v.prototype={invokeSendTargetRegex:/^#_(.*)$/,scxmlSendTargetRegex:/^#_scxml_(.*)$/,raise:function(a){this._installDefaultPropsOnEvent(a,!0),this._interpreter._internalEventQueue.push(a)},parseXmlStringAsDOM:function(a){return(this._interpreter.opts.xmlParser||v.xmlParser).parse(a)},invoke:function(a){var b=this;this._invokeMap[a.id]=new Promise(function(c,d){(b._interpreter.opts.invokers||v.invokers)[a.type](b._interpreter,a,function(a,b){return a?d(a):void c(b)})})},cancelInvoke:function(a){var b=this,c=this._invokeMap[a];this._interpreter._log("cancelling session with invokeid "+a),c&&(this._interpreter._log("sessionPromise found"),c.then(function(c){b._interpreter._log("resolved session "+a+". cancelling... "),c.cancel(),delete b._invokeMap[a]},function(a){}))},_installDefaultPropsOnEvent:function(a,b){b||(a.origin=this._interpreter.opts._x._ioprocessors.scxml.location,a.origintype=a.type||A),"undefined"==typeof a.type&&(a.type=b?"internal":"external"),["name","sendid","invokeid","data","origin","origintype"].forEach(function(b){a[b]||(a[b]=void 0)})},send:function(a,b){function c(a,b,c){if(a.target){var d=E.test(a.target);if(!d)throw{name:"error.execution",data:"Target is not valid URI",sendid:a.sendid,type:"platform"}}if(g!==A)throw{name:"error.execution",data:"Unsupported event processor type",sendid:a.sendid,type:"platform"};c.call(this,a,b)}function d(a,b){function c(c){var d=setTimeout(function(){a.sendid&&delete this._timeoutMap[a.sendid],this._timeouts["delete"](e),c[this._interpreter.opts.sendAsync?"genAsync":"gen"](a)}.bind(this),b.delay||0),e={sendOptions:b,timeoutHandle:d};a.sendid&&(this._timeoutMap[a.sendid]=d),this._timeouts.add(e)}var d=this;if("undefined"==typeof setTimeout)throw new Error("Default implementation of Statechart.prototype.send will not work unless setTimeout is defined globally.");var e;if("#_internal"===a.target)this.raise(a);else if(this._installDefaultPropsOnEvent(a,!1),a.origintype=A,a.target)if("#_parent"===a.target){if(!this._interpreter.opts.parentSession)throw{name:"error.communication",data:"Parent session not specified",sendid:a.sendid,type:"platform"};a.invokeid=this._interpreter.opts.invokeid,c.call(this,this._interpreter.opts.parentSession)}else if(e=a.target.match(this.scxmlSendTargetRegex)){var f=e[1],g=this._interpreter.opts.sessionRegistry.get(f);if(!g)throw{name:"error.communication",sendid:a.sendid,type:"platform"};c.call(this,g)}else{if(!(e=a.target.match(this.invokeSendTargetRegex)))throw new Error("Unrecognized send target.");var h=e[1];this._invokeMap[h].then(function(a){c.call(d,a)})}else c.call(this,this._interpreter)}function e(){this._interpreter.emit(a.name,a.data)}this._interpreter._log("send event",a,b),b=b||{};var f,g=b.type||A;f="https://github.com/jbeard4/SCION#publish"===a.type?e:this._interpreter.opts.customSend?this._interpreter.opts.customSend:d,b=b||{},this._interpreter._log("sending event",a.name,"with content",a.data,"after delay",b.delay),c.call(this,a,b,f)},cancel:function(a){if(this._interpreter.opts.customCancel)return this._interpreter.opts.customCancel.apply(this,[a]);if("undefined"==typeof clearTimeout)throw new Error("Default implementation of Statechart.prototype.cancel will not work unless setTimeout is defined globally.");a in this._timeoutMap&&(this._interpreter._log("cancelling ",a," with timeout id ",this._timeoutMap[a]),clearTimeout(this._timeoutMap[a]))}},a.exports={BaseInterpreter:r,Statechart:s,ArraySet:h,STATE_TYPES:z,initializeModel:f,InterpreterScriptingContext:v}});